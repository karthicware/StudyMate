<!-- Onboarding Wizard Modal -->
<div
  data-testid="onboarding-wizard-modal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4"
  role="dialog"
  aria-labelledby="wizard-title"
  aria-describedby="wizard-description"
>
  <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <!-- Wizard Header -->
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 id="wizard-title" class="text-2xl font-semibold text-gray-800">Welcome to StudyMate!</h2>
      <p id="wizard-description" class="text-sm text-gray-600 mt-1">
        Let's set up your first study hall
      </p>

      <!-- Progress Indicator -->
      <div
        class="mt-4 flex items-center"
        role="progressbar"
        [attr.aria-valuenow]="currentStep()"
        aria-valuemin="1"
        aria-valuemax="3"
        [attr.aria-label]="'Onboarding progress: Step ' + currentStep() + ' of 3'"
        data-testid="progress-indicator"
      >
        <!-- Step 1 -->
        <div class="flex items-center">
          <div
            class="flex items-center justify-center w-8 h-8 rounded-full font-semibold"
            [class.bg-blue-600]="currentStep() >= 1"
            [class.text-white]="currentStep() >= 1"
            [class.bg-gray-300]="currentStep() < 1"
            [class.text-gray-600]="currentStep() < 1"
          >
            1
          </div>
          <span
            class="ml-2 text-sm"
            [class.font-medium]="currentStep() === 1"
            [class.text-blue-600]="currentStep() === 1"
            [class.text-gray-500]="currentStep() !== 1"
            >Hall Setup</span
          >
        </div>
        <div
          class="flex-1 h-1 mx-4"
          [class.bg-blue-600]="currentStep() >= 2"
          [class.bg-gray-200]="currentStep() < 2"
        ></div>
        <!-- Step 2 -->
        <div class="flex items-center">
          <div
            class="flex items-center justify-center w-8 h-8 rounded-full font-semibold"
            [class.bg-blue-600]="currentStep() >= 2"
            [class.text-white]="currentStep() >= 2"
            [class.bg-gray-300]="currentStep() < 2"
            [class.text-gray-600]="currentStep() < 2"
          >
            2
          </div>
          <span
            class="ml-2 text-sm"
            [class.font-medium]="currentStep() === 2"
            [class.text-blue-600]="currentStep() === 2"
            [class.text-gray-500]="currentStep() !== 2"
            >Pricing</span
          >
        </div>
        <div
          class="flex-1 h-1 mx-4"
          [class.bg-blue-600]="currentStep() >= 3"
          [class.bg-gray-200]="currentStep() < 3"
        ></div>
        <!-- Step 3 -->
        <div class="flex items-center">
          <div
            class="flex items-center justify-center w-8 h-8 rounded-full font-semibold"
            [class.bg-blue-600]="currentStep() >= 3"
            [class.text-white]="currentStep() >= 3"
            [class.bg-gray-300]="currentStep() < 3"
            [class.text-gray-600]="currentStep() < 3"
          >
            3
          </div>
          <span
            class="ml-2 text-sm"
            [class.font-medium]="currentStep() === 3"
            [class.text-blue-600]="currentStep() === 3"
            [class.text-gray-500]="currentStep() !== 3"
            >Location</span
          >
        </div>
      </div>
    </div>

    <!-- Wizard Body - Step 1: Hall Creation Form -->
    <div class="px-6 py-6" *ngIf="currentStep() === 1">
      <form [formGroup]="hallForm" (ngSubmit)="onSubmit()" data-testid="hall-creation-form">
        <!-- Success Message -->
        <div
          *ngIf="successMessage()"
          data-testid="success-message"
          class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md"
          role="alert"
          aria-live="polite"
        >
          <p class="text-green-800 text-sm">✓ {{ successMessage() }}</p>
        </div>

        <!-- Error Message -->
        <div
          *ngIf="errorMessage()"
          data-testid="error-message"
          class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md"
          role="alert"
          aria-live="assertive"
        >
          <p class="text-red-800 text-sm">✗ {{ errorMessage() }}</p>
        </div>

        <!-- Hall Name -->
        <div class="mb-4">
          <label for="hallName" class="block text-sm font-medium text-gray-700 mb-1">
            Hall Name <span class="text-red-500">*</span>
          </label>
          <input
            id="hallName"
            type="text"
            formControlName="hallName"
            data-testid="hall-name-input"
            placeholder="e.g., Downtown Study Center"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            [class.border-red-500]="
              hasError('hallName', 'required') || hasError('hallName', 'pattern')
            "
            aria-required="true"
            [attr.aria-invalid]="
              hasError('hallName', 'required') || hasError('hallName', 'pattern') ? 'true' : null
            "
            [attr.aria-describedby]="getErrorMessage('hallName') ? 'hallName-error' : null"
          />
          <p
            *ngIf="getErrorMessage('hallName')"
            id="hallName-error"
            data-testid="hall-name-error-message"
            class="mt-1 text-sm text-red-600"
            role="alert"
          >
            {{ getErrorMessage('hallName') }}
          </p>
        </div>

        <!-- Description -->
        <div class="mb-4">
          <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
            Description (optional)
          </label>
          <textarea
            id="description"
            formControlName="description"
            data-testid="description-textarea"
            placeholder="Brief description of your study hall"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            [class.border-red-500]="hasError('description', 'maxlength')"
          ></textarea>
          <p
            *ngIf="getErrorMessage('description')"
            data-testid="description-error-message"
            class="mt-1 text-sm text-red-600"
          >
            {{ getErrorMessage('description') }}
          </p>
        </div>

        <!-- Address -->
        <div class="mb-4">
          <label for="address" class="block text-sm font-medium text-gray-700 mb-1">
            Address <span class="text-red-500">*</span>
          </label>
          <textarea
            id="address"
            formControlName="address"
            data-testid="address-textarea"
            placeholder="Street address, floor, building name"
            rows="2"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            [class.border-red-500]="hasError('address', 'required')"
          ></textarea>
          <p
            *ngIf="getErrorMessage('address')"
            data-testid="address-error-message"
            class="mt-1 text-sm text-red-600"
          >
            {{ getErrorMessage('address') }}
          </p>
        </div>

        <!-- City and State Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- City -->
          <div>
            <label for="city" class="block text-sm font-medium text-gray-700 mb-1">
              City <span class="text-red-500">*</span>
            </label>
            <input
              id="city"
              type="text"
              formControlName="city"
              data-testid="city-input"
              placeholder="e.g., Mumbai"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="hasError('city', 'required')"
            />
            <p
              *ngIf="getErrorMessage('city')"
              data-testid="city-error-message"
              class="mt-1 text-sm text-red-600"
            >
              {{ getErrorMessage('city') }}
            </p>
          </div>

          <!-- State -->
          <div>
            <label for="state" class="block text-sm font-medium text-gray-700 mb-1">
              State/Province <span class="text-red-500">*</span>
            </label>
            <input
              id="state"
              type="text"
              formControlName="state"
              data-testid="state-input"
              placeholder="e.g., Maharashtra"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="hasError('state', 'required')"
            />
            <p
              *ngIf="getErrorMessage('state')"
              data-testid="state-error-message"
              class="mt-1 text-sm text-red-600"
            >
              {{ getErrorMessage('state') }}
            </p>
          </div>
        </div>

        <!-- Postal Code and Country Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- Postal Code -->
          <div>
            <label for="postalCode" class="block text-sm font-medium text-gray-700 mb-1">
              Postal Code (optional)
            </label>
            <input
              id="postalCode"
              type="text"
              formControlName="postalCode"
              data-testid="postal-code-input"
              placeholder="e.g., 400001"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="hasError('postalCode', 'pattern')"
            />
            <p
              *ngIf="getErrorMessage('postalCode')"
              data-testid="postal-code-error-message"
              class="mt-1 text-sm text-red-600"
            >
              {{ getErrorMessage('postalCode') }}
            </p>
          </div>

          <!-- Country -->
          <div>
            <label for="country" class="block text-sm font-medium text-gray-700 mb-1">
              Country <span class="text-red-500">*</span>
            </label>
            <select
              id="country"
              formControlName="country"
              data-testid="country-select"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="hasError('country', 'required')"
            >
              <option *ngFor="let country of supportedCountries" [value]="country">
                {{ country }}
              </option>
            </select>
            <p
              *ngIf="getErrorMessage('country')"
              data-testid="country-error-message"
              class="mt-1 text-sm text-red-600"
            >
              {{ getErrorMessage('country') }}
            </p>
          </div>
        </div>
      </form>
    </div>

    <!-- Wizard Body - Step 2: Pricing Configuration -->
    <div class="px-6 py-6" *ngIf="currentStep() === 2">
      <form
        [formGroup]="pricingForm"
        (ngSubmit)="onPricingSubmit()"
        data-testid="pricing-configuration-form"
      >
        <!-- Success Message -->
        <div
          *ngIf="successMessage()"
          data-testid="success-message"
          class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md"
          role="alert"
          aria-live="polite"
        >
          <p class="text-green-800 text-sm">✓ {{ successMessage() }}</p>
        </div>

        <!-- Error Message -->
        <div
          *ngIf="errorMessage()"
          data-testid="error-message"
          class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md"
          role="alert"
          aria-live="assertive"
        >
          <p class="text-red-800 text-sm">✗ {{ errorMessage() }}</p>
        </div>

        <!-- Instructions -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Set Your Base Pricing</h3>
          <p class="text-sm text-gray-600">
            Configure the hourly rate for your study hall. You can update this later from your
            dashboard.
          </p>
        </div>

        <!-- Base Pricing Input -->
        <div class="mb-6">
          <label for="basePricing" class="block text-sm font-medium text-gray-700 mb-1">
            Base Hourly Rate <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-600 font-medium">₹</span>
            <input
              id="basePricing"
              type="number"
              formControlName="basePricing"
              data-testid="base-pricing-input"
              placeholder="100"
              min="50"
              max="5000"
              step="10"
              class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="
                hasError('basePricing', 'required', pricingForm) ||
                hasError('basePricing', 'min', pricingForm) ||
                hasError('basePricing', 'max', pricingForm)
              "
              aria-required="true"
              [attr.aria-invalid]="
                hasError('basePricing', 'required', pricingForm) ||
                hasError('basePricing', 'min', pricingForm) ||
                hasError('basePricing', 'max', pricingForm)
                  ? 'true'
                  : null
              "
              [attr.aria-describedby]="
                getErrorMessage('basePricing', pricingForm) ? 'basePricing-error' : null
              "
            />
          </div>
          <p class="mt-1 text-xs text-gray-500">Allowed range: ₹50 - ₹5000 per hour</p>
          <p
            *ngIf="getErrorMessage('basePricing', pricingForm)"
            id="basePricing-error"
            data-testid="base-pricing-error-message"
            class="mt-1 text-sm text-red-600"
            role="alert"
          >
            {{ getErrorMessage('basePricing', pricingForm) }}
          </p>
        </div>
      </form>
    </div>

    <!-- Wizard Body - Step 3: Location Configuration -->
    <div class="px-6 py-6" *ngIf="currentStep() === 3">
      <form
        [formGroup]="locationForm"
        (ngSubmit)="onLocationSubmit()"
        data-testid="location-configuration-form"
      >
        <!-- Success Message -->
        <div
          *ngIf="successMessage()"
          data-testid="success-message"
          class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md"
          role="alert"
          aria-live="polite"
        >
          <p class="text-green-800 text-sm">✓ {{ successMessage() }}</p>
        </div>

        <!-- Error Message -->
        <div
          *ngIf="errorMessage()"
          data-testid="error-message"
          class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md"
          role="alert"
          aria-live="assertive"
        >
          <p class="text-red-800 text-sm">✗ {{ errorMessage() }}</p>
        </div>

        <!-- Instructions -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Set Your Location</h3>
          <p class="text-sm text-gray-600">
            Click on the map to set your hall's location. This helps students find your hall on the
            map.
          </p>
        </div>

        <!-- Google Maps -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Location on Map</label>
          <div
            class="w-full h-96 border border-gray-300 rounded-md overflow-hidden"
            data-testid="google-map-container"
          >
            <google-map
              [center]="mapCenter()"
              [options]="mapOptions"
              [height]="'100%'"
              [width]="'100%'"
              (mapClick)="onMapClick($event)"
              data-testid="google-map"
            >
              <map-marker
                *ngIf="mapMarkerPosition()"
                [position]="mapMarkerPosition()!"
                data-testid="map-marker"
              ></map-marker>
            </google-map>
          </div>
          <p class="mt-1 text-xs text-gray-500">Click anywhere on the map to set your location</p>
        </div>

        <!-- Latitude and Longitude (readonly, auto-populated) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <!-- Latitude -->
          <div>
            <label for="latitude" class="block text-sm font-medium text-gray-700 mb-1">
              Latitude <span class="text-red-500">*</span>
            </label>
            <input
              id="latitude"
              type="text"
              formControlName="latitude"
              data-testid="latitude-input"
              placeholder="Click map to set"
              readonly
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 cursor-not-allowed"
              aria-readonly="true"
            />
            <p
              *ngIf="getErrorMessage('latitude', locationForm)"
              data-testid="latitude-error-message"
              class="mt-1 text-sm text-red-600"
              role="alert"
            >
              {{ getErrorMessage('latitude', locationForm) }}
            </p>
          </div>

          <!-- Longitude -->
          <div>
            <label for="longitude" class="block text-sm font-medium text-gray-700 mb-1">
              Longitude <span class="text-red-500">*</span>
            </label>
            <input
              id="longitude"
              type="text"
              formControlName="longitude"
              data-testid="longitude-input"
              placeholder="Click map to set"
              readonly
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 cursor-not-allowed"
              aria-readonly="true"
            />
            <p
              *ngIf="getErrorMessage('longitude', locationForm)"
              data-testid="longitude-error-message"
              class="mt-1 text-sm text-red-600"
              role="alert"
            >
              {{ getErrorMessage('longitude', locationForm) }}
            </p>
          </div>
        </div>

        <!-- Region Dropdown -->
        <div class="mb-6">
          <label for="region" class="block text-sm font-medium text-gray-700 mb-1">
            Region <span class="text-red-500">*</span>
          </label>
          <select
            id="region"
            formControlName="region"
            data-testid="region-select"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            [class.border-red-500]="hasError('region', 'required', locationForm)"
            aria-required="true"
            [attr.aria-invalid]="hasError('region', 'required', locationForm) ? 'true' : null"
            [attr.aria-describedby]="
              getErrorMessage('region', locationForm) ? 'region-error' : null
            "
          >
            <option value="">Select a region</option>
            <option *ngFor="let option of regionOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
          <p
            *ngIf="getErrorMessage('region', locationForm)"
            id="region-error"
            data-testid="region-error-message"
            class="mt-1 text-sm text-red-600"
            role="alert"
          >
            {{ getErrorMessage('region', locationForm) }}
          </p>
        </div>
      </form>
    </div>

    <!-- Wizard Footer -->
    <div
      class="px-6 py-4 border-t border-gray-200 flex justify-between"
      *ngIf="currentStep() === 1"
    >
      <button
        type="button"
        (click)="onSkipClick()"
        data-testid="skip-button"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400"
        [disabled]="isLoading()"
      >
        Skip for now
      </button>

      <button
        type="submit"
        (click)="onSubmit()"
        data-testid="create-hall-button"
        class="px-6 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed"
        [disabled]="hallForm.invalid || isLoading()"
      >
        <span *ngIf="!isLoading()">Create Hall</span>
        <span *ngIf="isLoading()" class="flex items-center">
          <svg
            class="animate-spin h-4 w-4 mr-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          Creating...
        </span>
      </button>
    </div>

    <!-- Wizard Footer - Step 2 (Pricing) -->
    <div
      class="px-6 py-4 border-t border-gray-200 flex justify-between"
      *ngIf="currentStep() === 2"
    >
      <button
        type="button"
        (click)="onSkipPricing()"
        data-testid="skip-pricing-button"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400"
        [disabled]="isLoading()"
      >
        Skip for now
      </button>

      <button
        type="submit"
        (click)="onPricingSubmit()"
        data-testid="continue-pricing-button"
        class="px-6 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed"
        [disabled]="pricingForm.invalid || isLoading()"
      >
        <span *ngIf="!isLoading()">Continue</span>
        <span *ngIf="isLoading()" class="flex items-center">
          <svg
            class="animate-spin h-4 w-4 mr-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          Saving...
        </span>
      </button>
    </div>

    <!-- Wizard Footer - Step 3 (Location) -->
    <div
      class="px-6 py-4 border-t border-gray-200 flex justify-between"
      *ngIf="currentStep() === 3"
    >
      <button
        type="button"
        (click)="onSkipLocation()"
        data-testid="skip-location-button"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400"
        [disabled]="isLoading()"
      >
        Skip for now
      </button>

      <button
        type="submit"
        (click)="onLocationSubmit()"
        data-testid="complete-setup-button"
        class="px-6 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed"
        [disabled]="locationForm.invalid || isLoading()"
      >
        <span *ngIf="!isLoading()">Complete Setup</span>
        <span *ngIf="isLoading()" class="flex items-center">
          <svg
            class="animate-spin h-4 w-4 mr-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          Activating Hall...
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Skip Confirmation Dialog -->
<div
  *ngIf="showSkipConfirmation()"
  data-testid="skip-confirmation-modal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[60]"
>
  <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 m-4">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">Skip Onboarding?</h3>
    <p class="text-sm text-gray-600 mb-6">
      You can create your hall later from the dashboard. Are you sure you want to skip this setup?
    </p>

    <div class="flex justify-end space-x-3">
      <button
        type="button"
        (click)="onCancelSkip()"
        data-testid="skip-cancel-button"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400"
      >
        Cancel
      </button>
      <button
        type="button"
        (click)="onConfirmSkip()"
        data-testid="skip-confirm-button"
        class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
      >
        Yes, Skip
      </button>
    </div>
  </div>
</div>
