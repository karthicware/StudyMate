# Story 4.99: Epic 4 API Validation with PostgreSQL MCP

## Status
Draft

## Story
**As a** QA Engineer,
**I want** all Epic 4 APIs validated end-to-end using PostgreSQL MCP with dummy data,
**so that** I can verify all announcement and communication endpoints work correctly with real database interactions and capture evidence.

## Acceptance Criteria
1. Test data created in database using PostgreSQL MCP (users, study halls, announcements)
2. All Epic 4 endpoints tested with MCP-sourced data
3. Test results captured and documented in this story file
4. Authentication tested with owner and student users from database
5. Owner authorization verified for announcement management
6. Announcement visibility tested (owner-only vs. student-visible)
7. Push notification logic verified (if applicable)
8. All edge cases tested (non-existent announcements, unauthorized access)
9. Database state verified after each operation

## Tasks / Subtasks
- [ ] Task 1: Setup test data using PostgreSQL MCP (AC: 1)
  - [ ] Create test owner user with study hall
  - [ ] Create test student users (5 users)
  - [ ] Create test announcements in various states (active, expired, urgent)
  - [ ] Create announcement read receipts
  - [ ] Capture INSERT results with row counts
- [ ] Task 2: Test authentication with owner user (AC: 4)
  - [ ] Query test owner credentials from database
  - [ ] Call POST /api/auth/login with database owner user
  - [ ] Capture JWT token response
  - [ ] Verify token contains correct user info and OWNER role
  - [ ] Document login response in story file
- [ ] Task 3: Test GET /owner/announcements/{hallId} (AC: 2, 9)
  - [ ] Call endpoint with owner JWT token
  - [ ] Verify response includes all announcements for the hall
  - [ ] Query database to validate announcement list
  - [ ] Test pagination (page=0, size=10)
  - [ ] Test filtering by date range
  - [ ] Capture API response and SQL query results
- [ ] Task 4: Test POST /owner/announcements (AC: 2, 9)
  - [ ] Prepare announcement creation request with title, message, priority
  - [ ] Call endpoint with owner JWT token
  - [ ] Query database to verify announcement created
  - [ ] Verify created_at timestamp and owner_id
  - [ ] Test validation for missing required fields (400)
  - [ ] Capture announcement creation response and database state
- [ ] Task 5: Test PUT /owner/announcements/{announcementId} (AC: 2, 9)
  - [ ] Update announcement title or message
  - [ ] Call endpoint with owner JWT token
  - [ ] Query database to verify announcement updated
  - [ ] Verify updated_at timestamp changed
  - [ ] Test updating non-existent announcement (404)
  - [ ] Test updating another owner's announcement (403)
  - [ ] Capture update response and SQL verification
- [ ] Task 6: Test DELETE /owner/announcements/{announcementId} (AC: 2, 9)
  - [ ] Call endpoint to delete announcement
  - [ ] Query database to verify announcement deleted (soft delete or hard delete)
  - [ ] Verify announcement no longer appears in GET /owner/announcements
  - [ ] Test deleting non-existent announcement (404)
  - [ ] Test deleting another owner's announcement (403)
  - [ ] Capture delete response and database state
- [ ] Task 7: Test GET /student/announcements/{hallId} (AC: 2, 6, 9)
  - [ ] Call endpoint with student JWT token
  - [ ] Verify response includes only student-visible announcements
  - [ ] Query database to validate visible announcements
  - [ ] Test pagination (page=0, size=10)
  - [ ] Verify private/owner-only announcements excluded
  - [ ] Capture response and SQL query results
- [ ] Task 8: Test POST /student/announcements/{announcementId}/mark-read (AC: 2, 9)
  - [ ] Call endpoint with student JWT token
  - [ ] Query database to verify read receipt created
  - [ ] Verify user_id and announcement_id in read receipts table
  - [ ] Test marking already-read announcement (should be idempotent)
  - [ ] Test marking non-existent announcement (404)
  - [ ] Capture mark-read response and database verification
- [ ] Task 9: Test GET /student/announcements/unread (AC: 2)
  - [ ] Call endpoint with student JWT token
  - [ ] Verify response shows only unread announcements
  - [ ] Query database to validate unread count
  - [ ] Compare with announcements marked as read
  - [ ] Capture response and SQL verification
- [ ] Task 10: Test announcement priority and urgency (AC: 6)
  - [ ] Create announcements with different priority levels (HIGH, MEDIUM, LOW)
  - [ ] Query database to verify priority stored correctly
  - [ ] Verify API response orders by priority (if applicable)
  - [ ] Test filtering by priority
  - [ ] Capture priority handling results
- [ ] Task 11: Test announcement expiry logic (AC: 6, 9)
  - [ ] Create announcement with expiry date
  - [ ] Query database to verify expiry_date set
  - [ ] Verify expired announcements excluded from student view
  - [ ] Test announcement visibility before and after expiry
  - [ ] Capture expiry logic verification
- [ ] Task 12: Test push notification trigger (AC: 7)
  - [ ] Create announcement with push notification enabled
  - [ ] Verify notification payload prepared (if push service integrated)
  - [ ] Query database for notification records (if stored)
  - [ ] Document push notification logic
  - [ ] Capture notification trigger evidence
- [ ] Task 13: Test authorization failures (AC: 5, 8)
  - [ ] Test owner accessing another owner's announcements (403)
  - [ ] Test student creating announcements (403)
  - [ ] Test student deleting announcements (403)
  - [ ] Test accessing announcements without JWT token (401)
  - [ ] Test with expired token (401)
  - [ ] Capture error responses
- [ ] Task 14: Test edge cases (AC: 8)
  - [ ] Test announcement with empty message (400)
  - [ ] Test announcement with extremely long message
  - [ ] Test marking read on expired announcement
  - [ ] Test fetching announcements for non-existent hall (404)
  - [ ] Query database to set up edge case scenarios
  - [ ] Capture responses for each scenario
- [ ] Task 15: Document all results in story file (AC: 3)
  - [ ] Add all SQL queries used
  - [ ] Add all API responses
  - [ ] Add database verification queries
  - [ ] Add screenshots or formatted output

## Dev Notes

### PostgreSQL MCP Integration
[Source: docs/architecture/studymate-system-architecture-blueprint.md#7-postgresql-mcp-integration-mandatory]
- **Database**: studymate_user
- **Credentials**: user=studymate_user, pwd=studymate_user
- **Tool**: `mcp__postgres__query`

### Test Data Setup Queries
Execute these via PostgreSQL MCP:

```sql
-- 1. Create test owner user
INSERT INTO users (email, password_hash, first_name, last_name, role)
VALUES ('owner@test.com', '$2a$10$...bcrypt_hash...', 'Test', 'Owner', 'OWNER')
RETURNING id, email, role;

-- 2. Create test student users
INSERT INTO users (email, password_hash, first_name, last_name, role)
VALUES
  ('student1@test.com', '$2a$10$...', 'Alice', 'Student', 'STUDENT'),
  ('student2@test.com', '$2a$10$...', 'Bob', 'Student', 'STUDENT'),
  ('student3@test.com', '$2a$10$...', 'Charlie', 'Student', 'STUDENT'),
  ('student4@test.com', '$2a$10$...', 'Diana', 'Student', 'STUDENT'),
  ('student5@test.com', '$2a$10$...', 'Eve', 'Student', 'STUDENT')
RETURNING id, email;

-- 3. Create test study hall (use owner_id from step 1)
INSERT INTO study_halls (owner_id, hall_name, seat_count, address)
VALUES (1, 'Test Study Hall', 30, '999 Announcement Test Street, Test City')
RETURNING id, hall_name, seat_count;

-- 4. Create test announcements in various states
INSERT INTO announcements (hall_id, owner_id, title, message, priority, expiry_date, is_push_enabled, created_at)
VALUES
  -- Active urgent announcement
  (1, 1, 'Important: Hall Closure Notice',
   'The study hall will be closed on October 15th for maintenance.',
   'HIGH', '2025-10-15', true, '2025-10-10 09:00:00'),

  -- Active normal announcement
  (1, 1, 'New WiFi Password',
   'The WiFi password has been changed to: StudyHall2025!',
   'MEDIUM', '2025-11-01', false, '2025-10-09 14:00:00'),

  -- Active low priority announcement
  (1, 1, 'Library Hours Extended',
   'Study hall hours are now extended until 10 PM on weekdays.',
   'LOW', '2025-12-31', false, '2025-10-08 10:00:00'),

  -- Expired announcement
  (1, 1, 'Holiday Notice',
   'Hall will be closed for Diwali holidays.',
   'MEDIUM', '2025-10-05', false, '2025-09-30 12:00:00')
RETURNING id, title, priority, expiry_date;

-- 5. Create announcement read receipts
INSERT INTO announcement_read_receipts (announcement_id, user_id, read_at)
VALUES
  (2, 2, '2025-10-09 15:00:00'),  -- Student1 read announcement 2
  (3, 2, '2025-10-08 11:00:00'),  -- Student1 read announcement 3
  (2, 3, '2025-10-09 16:00:00')   -- Student2 read announcement 2
RETURNING id, announcement_id, user_id, read_at;
```

### Validation Queries

**Verify Announcement Creation:**
```sql
-- Check announcement created with correct details
SELECT
  a.id,
  a.hall_id,
  a.owner_id,
  a.title,
  a.message,
  a.priority,
  a.expiry_date,
  a.is_push_enabled,
  a.created_at,
  a.updated_at
FROM announcements a
WHERE a.id = ?;
```

**Verify Announcement List for Owner:**
```sql
-- Get all announcements for owner's hall
SELECT
  a.id,
  a.title,
  a.message,
  a.priority,
  a.expiry_date,
  a.created_at,
  CASE
    WHEN a.expiry_date < CURRENT_DATE THEN 'EXPIRED'
    ELSE 'ACTIVE'
  END as status
FROM announcements a
WHERE a.hall_id = ?
ORDER BY a.created_at DESC;
```

**Verify Announcement Visibility for Students:**
```sql
-- Get only active (non-expired) announcements visible to students
SELECT
  a.id,
  a.title,
  a.message,
  a.priority,
  a.expiry_date,
  a.created_at,
  EXISTS(
    SELECT 1 FROM announcement_read_receipts arr
    WHERE arr.announcement_id = a.id AND arr.user_id = ?
  ) as is_read
FROM announcements a
WHERE a.hall_id = ?
  AND a.expiry_date >= CURRENT_DATE
ORDER BY a.priority DESC, a.created_at DESC;
```

**Verify Read Receipt Creation:**
```sql
-- Check read receipt exists for user and announcement
SELECT
  arr.id,
  arr.announcement_id,
  arr.user_id,
  arr.read_at
FROM announcement_read_receipts arr
WHERE arr.announcement_id = ? AND arr.user_id = ?;
```

**Verify Unread Announcements Count:**
```sql
-- Get count of unread announcements for student
SELECT COUNT(*) as unread_count
FROM announcements a
WHERE a.hall_id = ?
  AND a.expiry_date >= CURRENT_DATE
  AND NOT EXISTS (
    SELECT 1 FROM announcement_read_receipts arr
    WHERE arr.announcement_id = a.id AND arr.user_id = ?
  );
```

**Verify Announcement Update:**
```sql
-- Confirm announcement updated with new data
SELECT
  a.id,
  a.title,
  a.message,
  a.updated_at,
  a.updated_at > a.created_at as was_updated
FROM announcements a
WHERE a.id = ?;
```

**Verify Announcement Deletion:**
```sql
-- Check announcement deleted or soft-deleted
SELECT
  a.id,
  a.title,
  a.deleted_at  -- if using soft delete
FROM announcements a
WHERE a.id = ?;

-- Or if hard delete, verify it doesn't exist
SELECT COUNT(*) as exists_count
FROM announcements a
WHERE a.id = ?;
```

**Verify Priority Handling:**
```sql
-- Get announcements ordered by priority
SELECT
  a.id,
  a.title,
  a.priority,
  CASE
    WHEN a.priority = 'HIGH' THEN 1
    WHEN a.priority = 'MEDIUM' THEN 2
    WHEN a.priority = 'LOW' THEN 3
  END as priority_order
FROM announcements a
WHERE a.hall_id = ?
ORDER BY priority_order, a.created_at DESC;
```

### API Testing Template

For each endpoint, document:
1. **Setup**: SQL queries to prepare test data
2. **Request**: HTTP method, URL, headers, body
3. **Response**: Status code, response body
4. **Verification**: SQL queries to verify database state
5. **Teardown**: SQL queries to clean up (if needed)

## Test Results

### Test Data Setup Results
```
_To be filled by QA Agent during testing_

Example format:
=================================================
SQL Query:
INSERT INTO announcements (hall_id, owner_id, title, message, priority, expiry_date, is_push_enabled, created_at)
VALUES (1, 1, 'Important: Hall Closure Notice', '...', 'HIGH', '2025-10-15', true, '2025-10-10 09:00:00')
RETURNING id, title, priority, expiry_date;

Result:
 id |            title                | priority | expiry_date
----+---------------------------------+----------+-------------
  1 | Important: Hall Closure Notice  | HIGH     | 2025-10-15
(1 row)
=================================================
```

### Authentication Test Results (Owner User)
```
_To be filled by QA Agent_

Request:
POST /api/auth/login
Content-Type: application/json

{
  "email": "owner@test.com",
  "password": "test123"
}

Response (200 OK):
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "email": "owner@test.com",
  "role": "OWNER"
}

Verification SQL:
SELECT email, role FROM users WHERE email = 'owner@test.com';

Result: ✅ User found, credentials match, OWNER role confirmed
```

### GET /owner/announcements/{hallId} Test Results
```
_To be filled by QA Agent_

Request:
GET /owner/announcements/1
Authorization: Bearer <owner_token>

Response (200 OK):
{
  "announcements": [
    {
      "id": 1,
      "title": "Important: Hall Closure Notice",
      "message": "The study hall will be closed...",
      "priority": "HIGH",
      "expiryDate": "2025-10-15",
      "createdAt": "2025-10-10T09:00:00",
      "status": "ACTIVE"
    },
    {
      "id": 2,
      "title": "New WiFi Password",
      "message": "The WiFi password has been changed...",
      "priority": "MEDIUM",
      "expiryDate": "2025-11-01",
      "createdAt": "2025-10-09T14:00:00",
      "status": "ACTIVE"
    },
    ...
  ],
  "totalCount": 4,
  "page": 0,
  "size": 10
}

Verification SQL:
SELECT id, title, priority, expiry_date, created_at
FROM announcements
WHERE hall_id = 1
ORDER BY created_at DESC;

Result: ✅ All announcements returned, including expired ones, ordered correctly
```

### POST /owner/announcements Test Results
```
_To be filled by QA Agent_

Request:
POST /owner/announcements
Authorization: Bearer <owner_token>
Content-Type: application/json

{
  "hallId": 1,
  "title": "Test Announcement",
  "message": "This is a test announcement for validation.",
  "priority": "MEDIUM",
  "expiryDate": "2025-10-20",
  "isPushEnabled": false
}

Response (201 Created):
{
  "announcementId": 5,
  "title": "Test Announcement",
  "message": "This is a test announcement for validation.",
  "priority": "MEDIUM",
  "expiryDate": "2025-10-20",
  "createdAt": "2025-10-11T10:30:00"
}

Verification SQL:
SELECT id, hall_id, owner_id, title, message, priority, expiry_date, created_at
FROM announcements
WHERE id = 5;

Result: ✅ Announcement created with correct details, owner_id matches authenticated user

Test: Missing Required Fields
Request: POST /owner/announcements (without title)
Response: 400 Bad Request - "Title is required"
Result: ✅ Validation working correctly
```

### PUT /owner/announcements/{announcementId} Test Results
```
_To be filled by QA Agent_

Request:
PUT /owner/announcements/5
Authorization: Bearer <owner_token>
Content-Type: application/json

{
  "title": "Updated Test Announcement",
  "message": "This announcement has been updated.",
  "priority": "HIGH"
}

Response (200 OK):
{
  "announcementId": 5,
  "title": "Updated Test Announcement",
  "message": "This announcement has been updated.",
  "priority": "HIGH",
  "updatedAt": "2025-10-11T10:35:00"
}

Verification SQL:
SELECT id, title, message, priority, updated_at, updated_at > created_at as was_updated
FROM announcements
WHERE id = 5;

Result: ✅ Announcement updated successfully, updated_at timestamp changed

Test: Update Another Owner's Announcement
Request: PUT /owner/announcements/999 (owned by different owner)
Response: 403 Forbidden
Result: ✅ Authorization prevents updating other owners' announcements
```

### DELETE /owner/announcements/{announcementId} Test Results
```
_To be filled by QA Agent_

Request:
DELETE /owner/announcements/5
Authorization: Bearer <owner_token>

Response (200 OK):
{
  "message": "Announcement deleted successfully"
}

Verification SQL:
SELECT COUNT(*) as exists_count
FROM announcements
WHERE id = 5 AND deleted_at IS NULL;

Result: ✅ Announcement deleted (soft delete or hard delete), no longer appears in list
```

### GET /student/announcements/{hallId} Test Results
```
_To be filled by QA Agent_

Request:
GET /student/announcements/1
Authorization: Bearer <student_token>

Response (200 OK):
{
  "announcements": [
    {
      "id": 1,
      "title": "Important: Hall Closure Notice",
      "message": "The study hall will be closed...",
      "priority": "HIGH",
      "expiryDate": "2025-10-15",
      "createdAt": "2025-10-10T09:00:00",
      "isRead": false
    },
    {
      "id": 2,
      "title": "New WiFi Password",
      "message": "The WiFi password has been changed...",
      "priority": "MEDIUM",
      "expiryDate": "2025-11-01",
      "createdAt": "2025-10-09T14:00:00",
      "isRead": true
    },
    ...
  ],
  "totalCount": 3
}

Verification SQL:
SELECT a.id, a.title, a.priority, a.expiry_date,
  EXISTS(SELECT 1 FROM announcement_read_receipts arr
         WHERE arr.announcement_id = a.id AND arr.user_id = 2) as is_read
FROM announcements a
WHERE a.hall_id = 1 AND a.expiry_date >= CURRENT_DATE
ORDER BY a.priority DESC, a.created_at DESC;

Result: ✅ Only active (non-expired) announcements returned, read status accurate, expired announcement 4 excluded
```

### POST /student/announcements/{announcementId}/mark-read Test Results
```
_To be filled by QA Agent_

Request:
POST /student/announcements/1/mark-read
Authorization: Bearer <student_token>

Response (200 OK):
{
  "message": "Announcement marked as read",
  "readAt": "2025-10-11T10:40:00"
}

Verification SQL:
SELECT arr.id, arr.announcement_id, arr.user_id, arr.read_at
FROM announcement_read_receipts arr
WHERE arr.announcement_id = 1 AND arr.user_id = 2;

Result: ✅ Read receipt created with correct user_id and timestamp

Test: Mark Already-Read Announcement
Request: POST /student/announcements/1/mark-read (second time)
Response: 200 OK - Idempotent operation
Result: ✅ No duplicate read receipts created
```

### GET /student/announcements/unread Test Results
```
_To be filled by QA Agent_

Request:
GET /student/announcements/unread?hallId=1
Authorization: Bearer <student_token>

Response (200 OK):
{
  "unreadCount": 2,
  "unreadAnnouncements": [
    {
      "id": 1,
      "title": "Important: Hall Closure Notice",
      "priority": "HIGH"
    },
    {
      "id": 3,
      "title": "Library Hours Extended",
      "priority": "LOW"
    }
  ]
}

Verification SQL:
SELECT COUNT(*) as unread_count
FROM announcements a
WHERE a.hall_id = 1
  AND a.expiry_date >= CURRENT_DATE
  AND NOT EXISTS (
    SELECT 1 FROM announcement_read_receipts arr
    WHERE arr.announcement_id = a.id AND arr.user_id = 2
  );

Result: ✅ Unread count matches database, only unread announcements returned
```

### Announcement Priority Test Results
```
_To be filled by QA Agent_

Verification SQL:
SELECT a.id, a.title, a.priority,
  CASE
    WHEN a.priority = 'HIGH' THEN 1
    WHEN a.priority = 'MEDIUM' THEN 2
    WHEN a.priority = 'LOW' THEN 3
  END as priority_order
FROM announcements a
WHERE a.hall_id = 1
ORDER BY priority_order, a.created_at DESC;

Result: ✅ Announcements ordered by priority (HIGH > MEDIUM > LOW), then by date
```

### Announcement Expiry Logic Test Results
```
_To be filled by QA Agent_

Request:
GET /student/announcements/1 (with expired announcement in database)
Authorization: Bearer <student_token>

Verification SQL:
SELECT a.id, a.title, a.expiry_date,
  CASE
    WHEN a.expiry_date < CURRENT_DATE THEN 'EXPIRED'
    ELSE 'ACTIVE'
  END as status
FROM announcements a
WHERE a.hall_id = 1;

Result: ✅ Expired announcements excluded from student view, only active announcements returned
```

### Push Notification Trigger Test Results
```
_To be filled by QA Agent_

Request:
POST /owner/announcements (with isPushEnabled=true)

Verification:
[Check logs or notification service records]

Result: ✅ Push notification triggered for announcement with isPushEnabled=true
```

### Authorization Failure Tests
```
_To be filled by QA Agent_

Test: Owner accessing another owner's announcements
Request: GET /owner/announcements/999 (hall owned by different owner)
Response: 403 Forbidden
Result: ✅ Authorization prevents access to other owners' halls

Test: Student creating announcements
Request: POST /owner/announcements (with student token)
Response: 403 Forbidden
Result: ✅ Role-based authorization working

Test: Student deleting announcements
Request: DELETE /owner/announcements/1 (with student token)
Response: 403 Forbidden
Result: ✅ Students cannot delete announcements

Test: No JWT token
Request: GET /owner/announcements/1 (no Authorization header)
Response: 401 Unauthorized
Result: ✅ Authentication required
```

### Edge Case Tests
```
_To be filled by QA Agent_

Test: Announcement with empty message
Request: POST /owner/announcements (with message="")
Response: 400 Bad Request - "Message cannot be empty"
Result: ✅ Validation prevents empty messages

Test: Announcement with extremely long message (>5000 chars)
Request: POST /owner/announcements (with very long message)
Response: 400 Bad Request or truncated message
Result: ✅ Handles long messages appropriately

Test: Marking read on expired announcement
Request: POST /student/announcements/4/mark-read (announcement 4 is expired)
Response: 400 Bad Request or 200 OK with warning
Result: ✅ Handles expired announcement marking gracefully

Test: Fetching announcements for non-existent hall
Request: GET /owner/announcements/9999
Response: 404 Not Found
Result: ✅ Returns appropriate error for non-existent hall
```

## Testing Checklist

- [ ] All test data created successfully in database
- [ ] All SQL queries documented with results
- [ ] All API requests documented with responses
- [ ] All database verifications performed
- [ ] Announcement creation, update, deletion tested
- [ ] Read receipt tracking verified
- [ ] Announcement visibility tested (owner vs. student)
- [ ] Priority and expiry logic validated
- [ ] Push notification trigger tested (if applicable)
- [ ] All edge cases tested
- [ ] All authorization scenarios tested
- [ ] All results captured in this story file
- [ ] Database cleaned up after testing (optional)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-11 | 1.0 | Epic 4 API validation story created | Bob (Scrum Master) |

## QA Agent Record

### Test Execution Date
_To be filled by QA Agent_

### Test Environment
- Database: studymate_user (PostgreSQL)
- Backend URL: http://localhost:8080
- PostgreSQL MCP: Connected ✅

### Overall Test Results
- Total Endpoints Tested: __/9
- Passed: __
- Failed: __
- Blocked: __

### Issues Found
_To be filled by QA Agent_

### Evidence Files
_Screenshots, exported SQL results, API response logs_
