# Story 1.2.1: Fix OwnerRegisterComponent Tests

## Status
Draft

## Story
**As a** Developer,
**I want** all Router-related test failures fixed (OwnerRegisterComponent, OwnerLayoutComponent, roleGuard)
**so that** the test suite achieves 100% pass rate and unblocks further development.

## Acceptance Criteria

### AC1: Fix OwnerRegisterComponent Tests (23 failures)
- [ ] Add proper Router/ActivatedRoute provider configuration to test setup
- [ ] Verify RouterLink directive works correctly in tests
- [ ] All 23 OwnerRegisterComponent tests now pass
- [ ] No console errors during test execution

### AC2: Fix OwnerLayoutComponent Tests (2 failures)
- [ ] Fix "should import OwnerFooterComponent" test
- [ ] Fix "should import OwnerHeaderComponent" test
- [ ] Apply same Router configuration pattern as OwnerRegisterComponent
- [ ] Verify both tests passing (2/2)

### AC3: Fix roleGuard Regression (1 failure)
- [ ] Fix "should allow access when route data is undefined" test
- [ ] Properly mock route.data in test setup
- [ ] Verify roleGuard test passing
- [ ] No console errors during test execution

### AC4: Achieve 100% Pass Rate for Full Test Suite
- [ ] Run full test suite: `npm test -- --watch=false`
- [ ] Verify overall pass rate reaches 100% (248/248 tests - current total)
- [ ] Document final test results in story
- [ ] Confirm no regressions introduced

### AC5: Document Root Cause and Solution
- [ ] Document why RouterLink required additional configuration
- [ ] Document roleGuard route.data mocking issue
- [ ] Add solution to test patterns documentation (if not already present)
- [ ] Provide guidance for future component tests using RouterLink
- [ ] Update story with findings

## Tasks / Subtasks

- [ ] Task 1: Root cause analysis and investigation (AC: 1, 2, 3, 5)
  - [ ] Review OwnerRegisterComponent test file and identify missing providers
  - [ ] Review OwnerLayoutComponent test file and identify issues
  - [ ] Review roleGuard test file and identify route.data mocking issue
  - [ ] Check component templates for RouterLink usage
  - [ ] Determine correct Router test configuration approach
  - [ ] Document findings: why tests are failing (26 total failures)

- [ ] Task 2: Fix OwnerRegisterComponent tests (AC: 1)
  - [ ] Add provideRouter([]) to TestBed configuration (recommended)
  - [ ] OR use RouterTestingModule if appropriate
  - [ ] Verify RouterLink directive functions correctly
  - [ ] Run tests and verify all 23 tests passing

- [ ] Task 3: Fix OwnerLayoutComponent tests (AC: 2)
  - [ ] Apply same Router configuration pattern as OwnerRegisterComponent
  - [ ] Add provideRouter([]) to TestBed configuration
  - [ ] Verify both import tests passing (2/2 tests)
  - [ ] Check for console errors/warnings

- [ ] Task 4: Fix roleGuard regression (AC: 3)
  - [ ] Update "should allow access when route data is undefined" test
  - [ ] Properly mock route.data in test setup (handle undefined case)
  - [ ] Verify roleGuard test passing
  - [ ] Confirm no other roleGuard tests regressed

- [ ] Task 5: Full test suite validation (AC: 4)
  - [ ] Run complete test suite: `npm test -- --watch=false`
  - [ ] Verify 100% pass rate (248/248 tests - current total)
  - [ ] Generate code coverage report
  - [ ] Document test results and coverage

- [ ] Task 6: Documentation and knowledge sharing (AC: 5)
  - [ ] Document root cause in story completion notes
  - [ ] Document all three fix categories (OwnerRegister, OwnerLayout, roleGuard)
  - [ ] Add to test patterns documentation if needed
  - [ ] Create guidance for RouterLink testing in components
  - [ ] Update story with solution details

## Dev Notes

### Previous Story Insights

**Story 1.14a** (Fix Router Test Configuration) resolved Router-related test issues:
- Fixed auth guard and role guard test compilation errors
- Achieved 87/87 tests passing in story scope
- However, 26 tests remain failing (outside Story 1.14a scope):
  - 23 OwnerRegisterComponent tests (Story 1.2 scope)
  - 2 OwnerLayoutComponent tests (Story 1.2 scope)
  - 1 roleGuard test (new regression introduced)
- Root cause: Missing Router/ActivatedRoute provider for RouterLink directive

**Test Suite Growth:**
- Story 1.14a review: 232 tests
- Current: 248 tests (+16 tests added since Story 1.14a)
- Pass rate: 225/248 (90.7%) - down from 209/232 (90.1%)
- Need to fix: 26 failures to achieve 100% pass rate

**Key Learning:** Components using RouterLink directive require proper routing context in tests, even if the component doesn't directly inject ActivatedRoute.

### Architecture Overview

[Source: docs/architecture/tech-stack.md]
- **Frontend**: Angular 20 with TypeScript, Signals, Tailwind CSS
- **Testing Framework**: Jasmine/Karma (Unit), Playwright (E2E)
- **Router**: Angular Router with standalone components
- **Test Utilities**: Custom test utilities in `src/testing/`

### Component Analysis

**OwnerRegisterComponent (23 failing tests):**
- Location: `studymate-frontend/src/app/features/auth/owner-register/owner-register.component.ts`
- Type: Standalone component
- Dependencies: FormBuilder, AuthService, Router (injected)
- Template Dependencies: RouterLink directive (for navigation links)
- Does NOT inject: ActivatedRoute
- Issue: RouterLink requires routing context

**OwnerLayoutComponent (2 failing tests):**
- Location: `studymate-frontend/src/app/owner/owner-layout/owner-layout.component.ts`
- Type: Standalone component
- Failing tests: Component import verification tests
- Issue: Likely same RouterLink/ActivatedRoute configuration issue

**roleGuard (1 failing test - NEW REGRESSION):**
- Location: `studymate-frontend/src/app/core/guards/role.guard.spec.ts`
- Failing test: "should allow access when route data is undefined"
- Error: `TypeError: Cannot read properties of undefined (reading 'role')`
- Issue: Test not properly mocking route.data (accessing undefined.role)

**Current Test Configuration (OwnerRegisterComponent):**
```typescript
await TestBed.configureTestingModule({
  imports: [OwnerRegisterComponent, HttpClientTestingModule, RouterLink],
  providers: [
    { provide: AuthService, useValue: authServiceSpy },
    { provide: Router, useValue: routerSpy }
  ]
}).compileComponents();
```

**Issue:** RouterLink directive requires routing context (ActivatedRoute) to function, even though the component doesn't directly use it.

### Angular Testing Standards

[Source: docs/architecture/coding-standards.md#angular-standards]
- Use standalone components with `inject()` function for service injection
- For Router testing in Angular 20:
  - Prefer `provideRouter([])` for standalone components
  - Use `RouterTestingModule` for module-based components
  - Use Router spies for components that don't need actual routing
- Follow Arrange-Act-Assert pattern for all tests
- Achieve 90%+ test coverage

### Recommended Solutions

**Option 1: Use provideRouter (Angular 20 Standalone Pattern - RECOMMENDED):**
```typescript
import { provideRouter } from '@angular/router';

await TestBed.configureTestingModule({
  imports: [OwnerRegisterComponent, HttpClientTestingModule],
  providers: [
    { provide: AuthService, useValue: authServiceSpy },
    provideRouter([]) // Provides complete routing context including ActivatedRoute
  ]
}).compileComponents();
```

**Option 2: Use RouterTestingModule (Traditional Approach):**
```typescript
import { RouterTestingModule } from '@angular/router/testing';

await TestBed.configureTestingModule({
  imports: [
    OwnerRegisterComponent,
    HttpClientTestingModule,
    RouterTestingModule.withRoutes([])
  ],
  providers: [
    { provide: AuthService, useValue: authServiceSpy }
  ]
}).compileComponents();
```

**Option 3: Manually provide ActivatedRoute:**
```typescript
import { ActivatedRoute } from '@angular/router';

const routerSpy = jasmine.createSpyObj('Router', ['navigate']);
const activatedRouteMock = {}; // Minimal mock

await TestBed.configureTestingModule({
  imports: [OwnerRegisterComponent, HttpClientTestingModule],
  providers: [
    { provide: AuthService, useValue: authServiceSpy },
    { provide: Router, useValue: routerSpy },
    { provide: ActivatedRoute, useValue: activatedRouteMock }
  ]
}).compileComponents();
```

**Recommendation:** Use **Option 1 (provideRouter)** as it's the Angular 20 best practice for standalone components and provides complete routing context.

### File Locations

**Files to Modify:**
- `studymate-frontend/src/app/features/auth/owner-register/owner-register.component.spec.ts`

**Files to Reference:**
- `studymate-frontend/src/app/features/auth/owner-register/owner-register.component.ts` (component implementation)
- `studymate-frontend/src/app/features/auth/owner-register/owner-register.component.html` (template with RouterLink)

### Testing Requirements

[Source: docs/architecture/testing-strategy.md]

#### Unit Testing
- **Framework**: Jasmine/Karma (Angular default)
- **Pattern**: Arrange-Act-Assert
- **Coverage**: 90%+ required
- **Focus**: Router configuration for RouterLink directive

#### Test Execution Commands
```bash
# Run only OwnerRegisterComponent tests
npm test -- --include='**/owner-register.component.spec.ts'

# Run full test suite
npm test -- --watch=false

# Generate coverage report
npm test -- --watch=false --code-coverage
```

#### Success Criteria
- **OwnerRegisterComponent**: 23/23 tests passing (100%)
- **OwnerLayoutComponent**: 2/2 tests passing (100%)
- **roleGuard**: All tests passing (regression fixed)
- **Full Test Suite**: 248/248 tests passing (100%)
- **Console**: Zero errors, zero warnings
- **Coverage**: Maintain or improve current coverage levels (currently 75.5%)

### Technical Constraints

- **Performance**: Test suite must complete within 5 minutes
- **Compatibility**: Angular 20 testing patterns required
- **No Breaking Changes**: Existing passing tests must remain passing
- **Isolation**: Fix should not affect other test files

### context7 MCP Integration (MANDATORY)

[Source: docs/architecture/tech-stack.md#context7-mcp-mandatory]
- **Pre-Implementation**: ALWAYS consult context7 before writing code for latest patterns
- **Query**: `"use context7 - Angular 20 router testing with RouterLink directive"`
- **Usage**: Verify Router mock implementations against official Angular 20 documentation

### Project Structure Notes

Test file location follows Angular standards:
- Co-located with component: `owner-register.component.spec.ts`
- Use Angular 20 standalone component testing patterns
- Follow existing test structure in the file

## Testing

### Unit Testing
- **Location**: `studymate-frontend/src/app/features/auth/owner-register/owner-register.component.spec.ts`
- **Framework**: Jasmine/Karma
- **Coverage**: Must maintain or improve current coverage
- **Test Count**: 23 tests (currently failing, must all pass)

### Test Categories to Validate

**OwnerRegisterComponent (23 tests):**
- [ ] Component creation test
- [ ] Form validation tests (7 tests)
- [ ] Password validation tests (4 tests)
- [ ] Form submission tests (3 tests)
- [ ] Error handling tests (3 tests)
- [ ] Password visibility toggle tests (2 tests)
- [ ] Accessibility test (1 test)

**OwnerLayoutComponent (2 tests):**
- [ ] should import OwnerFooterComponent
- [ ] should import OwnerHeaderComponent

**roleGuard (1 test - regression fix):**
- [ ] should allow access when route data is undefined

### Full Test Suite Validation
- **Command**: `npm test -- --watch=false --code-coverage`
- **Success Criteria**: 248/248 tests passing (100%)
- **Console Validation**: Zero errors, zero warnings
- **Coverage Target**: Maintain or exceed current 75.5% coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Story created to fix OwnerRegisterComponent test failures (23 tests) blocking 100% pass rate | Bob (Scrum Master) |
| 2025-10-12 | 1.1 | Expanded scope to include OwnerLayoutComponent (2 failures) and roleGuard regression (1 failure). Updated test counts from 232 to 248. Total failures to fix: 26 tests. | Quinn (Test Architect) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent during implementation:_
- Document which solution option was chosen (Option 1, 2, or 3)
- Note the exact RouterLink usage in component template
- Record final test pass count (should be 23/23)
- Document any additional changes needed beyond test configuration
- Note any insights for future RouterLink testing

### File List

**Files Modified:**
- `studymate-frontend/src/app/features/auth/owner-register/owner-register.component.spec.ts` (23 test fixes)
- `studymate-frontend/src/app/owner/owner-layout/owner-layout.component.spec.ts` (2 test fixes)
- `studymate-frontend/src/app/core/guards/role.guard.spec.ts` (1 regression fix)

**Files Analyzed (No Changes):**
- `studymate-frontend/src/app/features/auth/owner-register/owner-register.component.ts`
- `studymate-frontend/src/app/features/auth/owner-register/owner-register.component.html`
- `studymate-frontend/src/app/owner/owner-layout/owner-layout.component.ts`
- `studymate-frontend/src/app/owner/owner-layout/owner-layout.component.html`
- `studymate-frontend/src/app/core/guards/role.guard.ts`

## QA Results

_To be filled by QA Agent_
