# Story 0.11: Integrate Flyway Migration Tool with Maven

## Status
Ready for development

## Story
**As a** Developer,
**I want** Flyway database migration tool integrated with Maven,
**so that** I can version-control and apply database schema changes automatically.

## Acceptance Criteria
1. Flyway Maven plugin added to pom.xml
2. Flyway configuration added to application.properties
3. Migration directory structure created
4. Flyway validates on application startup
5. Maven flyway commands work (flyway:migrate, flyway:info, flyway:clean)
6. Flyway integration tested with sample migration

## Tasks / Subtasks
- [ ] Task 1: Add Flyway Maven plugin (AC: 1)
  - [ ] Add Flyway Maven plugin to pom.xml
  - [ ] Configure plugin with database connection details
  - [ ] Set Flyway version (latest compatible with Spring Boot 3.5.6)
  - [ ] Run `mvn clean install` to verify plugin loads
- [ ] Task 2: Add Flyway Spring Boot dependency (AC: 1)
  - [ ] Add spring-boot-starter-flyway to dependencies
  - [ ] Verify dependency resolution
  - [ ] Check for version conflicts
- [ ] Task 3: Configure Flyway in application.properties (AC: 2)
  - [ ] Enable Flyway: spring.flyway.enabled=true
  - [ ] Set migration locations: classpath:db/migration
  - [ ] Configure baseline-on-migrate for existing databases
  - [ ] Set validate-on-migrate to true
  - [ ] Configure table name for tracking: flyway_schema_history
- [ ] Task 4: Create migration directory structure (AC: 3)
  - [ ] Create src/main/resources/db/migration/ directory
  - [ ] Create README.md explaining migration naming convention
  - [ ] Document: V{version}__{description}.sql format
  - [ ] Example: V1__initial_schema.sql
- [ ] Task 5: Create test migration (AC: 6)
  - [ ] Create V0__baseline.sql with simple comment
  - [ ] Run application to test Flyway executes migration
  - [ ] Check flyway_schema_history table created
  - [ ] Verify migration recorded in history table
- [ ] Task 6: Test Maven Flyway commands (AC: 5)
  - [ ] Run `mvn flyway:info` to see migration status
  - [ ] Run `mvn flyway:validate` to check migrations
  - [ ] Test `mvn flyway:migrate` applies pending migrations
  - [ ] Document flyway:clean (caution: drops all objects)
- [ ] Task 7: Verify Spring Boot integration (AC: 4)
  - [ ] Start application with migrations pending
  - [ ] Verify Flyway runs automatically on startup
  - [ ] Check logs for Flyway migration messages
  - [ ] Verify application fails if migration validation fails
- [ ] Task 8: Document Flyway usage (AC: 3)
  - [ ] Create migration guide in docs/
  - [ ] Document naming convention
  - [ ] Document dos and don'ts
  - [ ] Add troubleshooting tips
  - [ ] Document rollback strategy

## Dev Notes

### Previous Story Insights
**From Story 0.10:** PostgreSQL database set up with studymate_user database and credentials

### Flyway Maven Plugin Configuration
[Source: docs/epics/epic-0-project-foundation-setup.md#feature-0.3]

Add to pom.xml:
```xml
<dependencies>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-core</artifactId>
    </dependency>
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-database-postgresql</artifactId>
        <scope>runtime</scope>
    </dependency>
</dependencies>

<build>
    <plugins>
        <plugin>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-maven-plugin</artifactId>
            <version>10.0.0</version>
            <configuration>
                <url>jdbc:postgresql://localhost:5432/studymate</url>
                <user>studymate_user</user>
                <password>studymate_user</password>
                <locations>
                    <location>filesystem:src/main/resources/db/migration</location>
                </locations>
            </configuration>
        </plugin>
    </plugins>
</build>
```

### Flyway Application Properties
```properties
# Flyway Configuration
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.validate-on-migrate=true
spring.flyway.table=flyway_schema_history
```

### Migration Naming Convention
Format: `V{version}__{description}.sql`
- Version: Sequential number (1, 2, 3) or semantic (1.0, 1.1, 2.0)
- Separator: Double underscore `__`
- Description: Snake_case or words separated by underscores

Examples:
- V1__initial_schema.sql
- V2__add_user_roles.sql
- V3__create_booking_tables.sql

### Test Migration File
`src/main/resources/db/migration/V0__baseline.sql`:
```sql
-- Baseline migration for Flyway
-- This migration establishes the starting point for version control

-- No schema changes in baseline
-- Actual schema will be created in V1__initial_schema.sql
```

### Flyway Maven Commands
- `mvn flyway:info` - Show migration status
- `mvn flyway:migrate` - Apply pending migrations
- `mvn flyway:validate` - Validate applied migrations
- `mvn flyway:clean` - **DANGEROUS** - Drops all objects
- `mvn flyway:baseline` - Baseline existing database

### File Locations
- Migration files: `src/main/resources/db/migration/`
- Flyway config: `src/main/resources/application.properties`
- Maven plugin: `pom.xml`

## Testing
- **Plugin Test**: `mvn flyway:info` shows migration status
- **Spring Integration**: Application starts and runs migrations
- **History Table**: flyway_schema_history table exists in database

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 0, Feature 0.3 | Bob (Scrum Master) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
