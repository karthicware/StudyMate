# Story 3.1-Backend: Implement Payment Integration APIs

## Status
Draft

## Story
**As a** Backend Developer,
**I want** payment integration APIs implemented with Razorpay,
**so that** students can make secure payments for bookings.

## Acceptance Criteria
1. POST `/payment/initiate` - Create Razorpay order
2. POST `/payment/webhook` - Handle Razorpay webhook confirmation
3. Payment records stored with transaction IDs
4. Booking confirmed only after successful payment
5. Webhook signature validation for security
6. PostgreSQL MCP validation

## Tasks / Subtasks
- [ ] Create PaymentController with endpoints
- [ ] Create PaymentService for Razorpay integration
- [ ] Add Razorpay Java SDK dependency
- [ ] Implement order creation with Razorpay API
- [ ] Implement webhook handler with signature verification
- [ ] Update booking status to CONFIRMED after payment
- [ ] Store payment records (amount, transactionId, status)
- [ ] Handle payment failures and refunds
- [ ] Create integration tests (mock Razorpay)
- [ ] Validate with PostgreSQL MCP

## Dev Notes

### Razorpay Integration
```java
@Service
@RequiredArgsConstructor
public class PaymentService {

    private final RazorpayClient razorpayClient;
    private final PaymentRepository paymentRepository;
    private final BookingRepository bookingRepository;

    @Value("${razorpay.key-id}")
    private String razorpayKeyId;

    @Value("${razorpay.key-secret}")
    private String razorpayKeySecret;

    public PaymentInitiateResponse initiatePayment(PaymentRequest request) {
        // Create Razorpay order
        JSONObject orderRequest = new JSONObject();
        orderRequest.put("amount", request.getAmount() * 100); // Convert to paise
        orderRequest.put("currency", "INR");
        orderRequest.put("receipt", "booking_" + request.getBookingId());

        Order order = razorpayClient.orders.create(orderRequest);

        // Store payment record
        Payment payment = Payment.builder()
            .bookingId(request.getBookingId())
            .amount(request.getAmount())
            .razorpayOrderId(order.get("id"))
            .status(PaymentStatus.PENDING)
            .build();
        paymentRepository.save(payment);

        return new PaymentInitiateResponse(order.get("id"), razorpayKeyId);
    }
}
```

### Webhook Handler
```java
@PostMapping("/webhook")
public ResponseEntity<Void> handleWebhook(
        @RequestBody String payload,
        @RequestHeader("X-Razorpay-Signature") String signature) {

    // Verify signature
    if (!verifySignature(payload, signature)) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
    }

    JSONObject event = new JSONObject(payload);
    String orderId = event.getJSONObject("payload")
        .getJSONObject("payment")
        .getJSONObject("entity")
        .getString("order_id");

    // Update payment and booking
    Payment payment = paymentRepository.findByRazorpayOrderId(orderId)
        .orElseThrow();

    payment.setStatus(PaymentStatus.CONFIRMED);
    payment.setRazorpayPaymentId(event.getString("payment_id"));

    Booking booking = payment.getBooking();
    booking.setStatus(BookingStatus.CONFIRMED);

    return ResponseEntity.ok().build();
}
```

### Dependencies
```xml
<dependency>
    <groupId>com.razorpay</groupId>
    <artifactId>razorpay-java</artifactId>
    <version>1.4.3</version>
</dependency>
```

### File Locations
- Controller: `controller/PaymentController.java`
- Service: `service/PaymentService.java`
- Entity: `model/Payment.java` (new)
- Repository: `repository/PaymentRepository.java` (new)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Payment integration APIs | Bob (Scrum Master) |
