# Story 2.1-Backend: Implement Seat Booking APIs

## Status
Draft

## Story
**As a** Backend Developer,
**I want** seat booking core APIs implemented,
**so that** students can view available seats, lock them, and create bookings.

## Acceptance Criteria
1. GET `/booking/seats/{hallId}` - Real-time seat status
2. POST `/booking/seats/lock` - Lock seat temporarily (5 min)
3. POST `/booking/create` - Create confirmed booking
4. Prevent double-booking with database locking
5. Automatic lock expiration after 5 minutes
6. PostgreSQL MCP validation

## Tasks / Subtasks
- [ ] Create BookingController with endpoints
- [ ] Create BookingService with transaction management
- [ ] Implement seat locking with pessimistic database lock
- [ ] Add scheduled task to expire locks (every minute)
- [ ] Verify seat availability before locking
- [ ] Create DTOs (SeatStatusResponse, LockSeatRequest, CreateBookingRequest)
- [ ] Add validation (date range, seat availability)
- [ ] Create comprehensive tests including race conditions
- [ ] Validate with PostgreSQL MCP

## Dev Notes

### API Specifications

**GET `/booking/seats/{hallId}`**
Response: Array of SeatStatus (id, number, coords, status, lockedUntil)

**POST `/booking/seats/lock`**
Request: `{"seatId": 1, "userId": 123}`
Response: `{"lockId": "uuid", "expiresAt": "2025-10-10T10:05:00Z"}`

**POST `/booking/create`**
Request: `{"lockId": "uuid", "seatId": 1, "startTime": "...", "endTime": "..."}`
Response: 201 Created with booking ID

### Critical Implementation
```java
@Transactional
public LockResponse lockSeat(Long seatId, Long userId) {
    // Pessimistic lock to prevent race conditions
    Seat seat = seatRepository.findByIdWithLock(seatId)
        .orElseThrow(() -> new ResourceNotFoundException("Seat not found"));

    // Check if seat is already locked or booked
    if (seat.getStatus() != SeatStatus.AVAILABLE) {
        throw new SeatUnavailableException("Seat not available");
    }

    // Create lock entry
    SeatLock lock = SeatLock.builder()
        .seat(seat)
        .user(userId)
        .expiresAt(LocalDateTime.now().plusMinutes(5))
        .build();

    seatLockRepository.save(lock);
    seat.setStatus(SeatStatus.LOCKED);

    return new LockResponse(lock.getId(), lock.getExpiresAt());
}
```

### Scheduled Lock Expiration
```java
@Scheduled(fixedRate = 60000) // Every minute
@Transactional
public void expireOldLocks() {
    List<SeatLock> expiredLocks = seatLockRepository
        .findByExpiresAtBeforeAndStatusNot(LocalDateTime.now(), LockStatus.EXPIRED);

    expiredLocks.forEach(lock -> {
        lock.setStatus(LockStatus.EXPIRED);
        lock.getSeat().setStatus(SeatStatus.AVAILABLE);
    });
}
```

### File Locations
- Controller: `controller/BookingController.java`
- Service: `service/BookingService.java`
- Entity: `model/SeatLock.java` (new entity)
- Repository: `repository/SeatLockRepository.java` (new)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Seat booking APIs backend story | Bob (Scrum Master) |
