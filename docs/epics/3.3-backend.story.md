# Story 3.3-Backend: Implement Subscription Management APIs

## Status
Draft

## Story
**As a** Backend Developer,
**I want** subscription management APIs implemented,
**so that** students can manage their monthly subscriptions.

## Acceptance Criteria
1. GET `/subscription/status/{userId}` - Get subscription status
2. POST `/subscription/renew` - Renew subscription
3. GET `/subscription/expiring` - List subscriptions expiring within 7 days
4. Automatic expiration checking (scheduled task)
5. Subscription plans stored in database
6. PostgreSQL MCP validation

## Tasks / Subtasks
- [ ] Create SubscriptionController with endpoints
- [ ] Create SubscriptionService
- [ ] Create Subscription entity (userId, planId, startDate, endDate, status)
- [ ] Create SubscriptionPlan entity (name, duration, price)
- [ ] Implement subscription status check
- [ ] Implement renewal logic (create new subscription linked to payment)
- [ ] Create scheduled task to check expiring subscriptions
- [ ] Send notifications for expiring subscriptions
- [ ] Create tests including expiration scenarios
- [ ] Validate with PostgreSQL MCP

## Dev Notes

### Subscription Status Check
```java
public SubscriptionStatusResponse getStatus(Long userId) {
    Subscription active = subscriptionRepository
        .findActiveByUserId(userId, LocalDate.now())
        .orElse(null);

    if (active == null) {
        return SubscriptionStatusResponse.expired();
    }

    long daysRemaining = ChronoUnit.DAYS.between(LocalDate.now(), active.getEndDate());

    return SubscriptionStatusResponse.builder()
        .status(active.getStatus())
        .planName(active.getPlan().getName())
        .expiresAt(active.getEndDate())
        .daysRemaining(daysRemaining)
        .build();
}
```

### Expiring Subscriptions Check
```java
@Scheduled(cron = "0 0 9 * * *") // Daily at 9 AM
public void checkExpiringSubscriptions() {
    LocalDate now = LocalDate.now();
    LocalDate sevenDaysFromNow = now.plusDays(7);

    List<Subscription> expiring = subscriptionRepository
        .findExpiringBetween(now, sevenDaysFromNow);

    expiring.forEach(subscription -> {
        notificationService.sendExpiryReminder(subscription);
    });
}
```

### File Locations
- Controller: `controller/SubscriptionController.java`
- Service: `service/SubscriptionService.java`
- Entity: `model/Subscription.java`, `model/SubscriptionPlan.java` (new)
- Repository: `repository/SubscriptionRepository.java` (new)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Subscription management APIs | Bob (Scrum Master) |
