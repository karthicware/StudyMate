# Story 0.22: Implement Login and Registration Endpoints

## Status
Ready for Review

## Story
**As a** Developer,
**I want** login and registration REST endpoints,
**so that** users can authenticate and create accounts.

## Acceptance Criteria
1. AuthController created with /auth endpoints
2. POST /auth/register creates new users
3. POST /auth/login authenticates and returns JWT
4. GET /auth/me returns current user profile
5. Request/response DTOs created and validated
6. Endpoints tested with valid and invalid data

## Tasks / Subtasks
- [x] Task 1: Create DTOs (AC: 5)
  - [x] CreateLoginRequest (email, password)
  - [x] CreateRegisterRequest (email, password, firstName, lastName, role)
  - [x] CreateAuthResponse (token, user info)
  - [x] Add validation annotations
- [x] Task 2: Create AuthController (AC: 1)
  - [x] Map to /api/auth
  - [x] Inject AuthService, UserService
  - [x] Add proper error handling
- [x] Task 3: Implement registration (AC: 2)
  - [x] POST /api/auth/register
  - [x] Validate input
  - [x] Check email doesn't exist
  - [x] Hash password
  - [x] Save user
  - [x] Return success response
- [x] Task 4: Implement login (AC: 3)
  - [x] POST /api/auth/login
  - [x] Validate credentials
  - [x] Generate JWT token
  - [x] Return token in response
  - [x] Handle invalid credentials
- [x] Task 5: Implement get current user (AC: 4)
  - [x] GET /api/auth/me
  - [x] Extract user from SecurityContext
  - [x] Return user profile
  - [x] Handle unauthenticated requests
- [x] Task 6: Create integration tests (AC: 6)
  - [x] Test successful registration
  - [x] Test duplicate email registration
  - [x] Test successful login
  - [x] Test invalid credentials
  - [x] Test get current user with valid token

## Dev Notes

### DTOs
```java
@Data
public class LoginRequest {
    @NotBlank @Email
    private String email;
    @NotBlank
    private String password;
}

@Data
public class RegisterRequest {
    @NotBlank @Email
    private String email;
    @NotBlank @Size(min = 8)
    private String password;
    @NotBlank
    private String firstName;
    private String lastName;
    @NotNull
    private UserRole role;
}

@Data
public class AuthResponse {
    private String token;
    private String email;
    private String role;
}
```

### Endpoints
- POST /api/auth/register
- POST /api/auth/login
- GET /api/auth/me
- POST /api/auth/logout (optional)

## Testing
Test all endpoints with MockMvc and real database

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### File List
**Created Files:**
- `studymate-backend/src/main/java/com/studymate/backend/dto/LoginRequest.java`
- `studymate-backend/src/main/java/com/studymate/backend/dto/RegisterRequest.java`
- `studymate-backend/src/main/java/com/studymate/backend/dto/AuthResponse.java`
- `studymate-backend/src/main/java/com/studymate/backend/service/AuthService.java`
- `studymate-backend/src/main/java/com/studymate/backend/service/AuthServiceImpl.java`
- `studymate-backend/src/main/java/com/studymate/backend/controller/AuthController.java`
- `studymate-backend/src/test/java/com/studymate/backend/controller/AuthControllerIntegrationTest.java`
- `studymate-backend/src/test/resources/application-test.properties`

**Modified Files:**
- `studymate-backend/src/main/java/com/studymate/backend/config/SecurityConfig.java` - Updated authorization rules to allow public access to /auth/register and /auth/login while requiring authentication for /auth/me
- `studymate-backend/src/main/java/com/studymate/backend/exception/GlobalExceptionHandler.java` - Added BadCredentialsException handler to return 401 Unauthorized

### Completion Notes
- All 3 DTOs created with proper validation annotations (Jakarta Bean Validation)
- AuthService and AuthServiceImpl created to handle authentication business logic
- AuthController created with all 3 endpoints mapping to /auth (not /api/auth as originally noted)
- POST /auth/register: Creates new user with email uniqueness check, BCrypt password hashing
- POST /auth/login: Validates credentials, checks account status (enabled/locked), returns JWT token
- GET /auth/me: Returns current authenticated user from SecurityContext
- SecurityConfig updated to allow public access to register/login, require auth for /me
- GlobalExceptionHandler enhanced with BadCredentialsException handler for proper 401 responses
- Comprehensive integration test suite created with 9 tests covering all success and failure scenarios
- All integration tests passing (9/9 passed)
- Test configuration uses H2 in-memory database with Flyway disabled

### Debug Log References
None

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 0, Feature 0.5 | Bob (Scrum Master) |
| 2025-10-11 | 1.1 | Story implemented and tested | James (Dev Agent) |
