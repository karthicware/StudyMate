# Story 1.20: Owner Settings Page (Frontend)

## Story Metadata

| Field | Value |
|-------|-------|
| **Story ID** | 1.20 |
| **Title** | Owner Settings Page |
| **Epic** | Epic-1 - Owner Dashboard & Analytics |
| **Feature** | Feature 1.5 - Owner Portal Infrastructure |
| **Priority** | Medium |
| **Story Points** | 5 |
| **Status** | Ready for Development |
| **Dependencies** | Story 1.17 (Layout Shell), Story 1.21 (Settings API) |

---

## User Story

**As an** Owner,
**I want** to configure notification preferences and system settings
**so that** I receive relevant information and customize my experience.

---

## Acceptance Criteria

### AC1: Settings Page Structure
- [ ] Settings page organized in collapsible sections:
  - **Notifications:** Email, SMS, Push toggles
  - **Notification Types:** Booking, Payment, System alerts toggles
  - **System:** Language, Timezone, Default view dropdowns
  - **Privacy:** Profile visibility toggle
- [ ] Each section clearly labeled with icons
- [ ] Sections expandable/collapsible (accordion pattern)
- [ ] Clean, organized layout with visual hierarchy

### AC2: Notification Preferences
- [ ] Toggle switches for:
  - Email Notifications (on/off)
  - SMS Notifications (on/off)
  - Push Notifications (on/off)
- [ ] Each toggle has description text
- [ ] Toggles visually indicate current state (on=blue, off=gray)
- [ ] Changes auto-save with debounce (500ms)

### AC3: Notification Types
- [ ] Toggle switches for each notification type:
  - Booking Notifications (new bookings, cancellations)
  - Payment Reminders (upcoming/overdue payments)
  - System Alerts (maintenance, updates)
- [ ] Each toggle independent
- [ ] Auto-save on change

### AC4: System Preferences
- [ ] **Language** dropdown:
  - Options: English, Spanish, French (or as per requirements)
  - Current selection highlighted
  - Auto-save on change
- [ ] **Timezone** dropdown:
  - Common timezones (US/Eastern, US/Pacific, UTC, etc.)
  - Auto-save on change
- [ ] **Default View** dropdown:
  - Options: Dashboard, Seat Map
  - Sets landing page after login
  - Auto-save on change

### AC5: Privacy Settings
- [ ] **Profile Visibility** toggle:
  - Options: Public (visible to students), Private (hidden)
  - Description explaining what visibility means
  - Auto-save on change

### AC6: Auto-Save Functionality
- [ ] All changes auto-save via PUT `/owner/settings`
- [ ] Loading spinner shown during save
- [ ] Success indicator (checkmark icon) after save
- [ ] Error message if save fails
- [ ] Debounce rapid changes (500ms delay)
- [ ] No explicit "Save" button needed

### AC7: Restore Defaults
- [ ] "Restore Defaults" button at bottom of page
- [ ] Confirmation modal: "Reset all settings to defaults?"
- [ ] On confirm: Reset all settings to system defaults
- [ ] Success message: "Settings restored to defaults"

### AC8: Settings Load on Page Load
- [ ] Fetch settings from GET `/owner/settings` on component init
- [ ] Display loading state while fetching
- [ ] Populate all form controls with current values
- [ ] Handle API errors gracefully

### AC9: Responsive Design
- [ ] Mobile (<768px): Single column, full-width sections
- [ ] Tablet (768px-1023px): Single column with better spacing
- [ ] Desktop (â‰¥1024px): Single column with max-width constraint (800px)

---

## Tasks / Subtasks

- [ ] Task 1: Create settings component structure (AC: All)
  - [ ] Generate `settings` component using Angular CLI
  - [ ] Set up component as standalone with required imports
  - [ ] Import ReactiveFormsModule for form handling
  - [ ] Create SettingsService for API integration
  - [ ] Set up component files (.ts, .html, .scss, .spec.ts)

- [ ] Task 2: Implement settings page structure (AC: 1)
  - [ ] Create collapsible sections (accordion pattern)
  - [ ] Add Notifications section
  - [ ] Add Notification Types section
  - [ ] Add System Preferences section
  - [ ] Add Privacy Settings section
  - [ ] Style with icons and clear labels

- [ ] Task 3: Implement notification preferences (AC: 2)
  - [ ] Add toggle switches for email, SMS, push
  - [ ] Create form controls for each toggle
  - [ ] Add description text for each toggle
  - [ ] Style toggles with visual state (on/off)
  - [ ] Connect toggles to form model

- [ ] Task 4: Implement notification types (AC: 3)
  - [ ] Add toggles for booking, payment, system alerts
  - [ ] Create independent form controls
  - [ ] Add descriptions for each type
  - [ ] Connect toggles to form model

- [ ] Task 5: Implement system preferences (AC: 4)
  - [ ] Add Language dropdown (en, es, fr)
  - [ ] Add Timezone dropdown (US timezones, UTC)
  - [ ] Add Default View dropdown (dashboard, seat-map)
  - [ ] Create form controls for each dropdown
  - [ ] Connect dropdowns to form model

- [ ] Task 6: Implement privacy settings (AC: 5)
  - [ ] Add Profile Visibility toggle (public/private)
  - [ ] Add description explaining visibility
  - [ ] Create form control
  - [ ] Connect toggle to form model

- [ ] Task 7: Implement auto-save functionality (AC: 6)
  - [ ] Set up form valueChanges observable
  - [ ] Add debounceTime(500ms) operator
  - [ ] Add distinctUntilChanged operator
  - [ ] Trigger save on form changes
  - [ ] Show loading spinner during save
  - [ ] Show success indicator after save
  - [ ] Handle save errors with toast notifications

- [ ] Task 8: Implement restore defaults (AC: 7)
  - [ ] Add "Restore Defaults" button
  - [ ] Create confirmation modal
  - [ ] Call restoreDefaults API
  - [ ] Update form with default values
  - [ ] Show success message

- [ ] Task 9: Implement settings load on init (AC: 8)
  - [ ] Fetch settings via GET `/owner/settings`
  - [ ] Display loading state
  - [ ] Populate form with current settings
  - [ ] Handle API errors

- [ ] Task 10: Implement responsive design (AC: 9)
  - [ ] Mobile layout: single column, full-width
  - [ ] Tablet layout: single column with spacing
  - [ ] Desktop layout: max-width 800px, centered
  - [ ] Test all breakpoints

- [ ] Task 11: Implement unit tests
  - [ ] Test form initialization
  - [ ] Test settings loading
  - [ ] Test toggle switches
  - [ ] Test dropdowns
  - [ ] Test auto-save debounce logic
  - [ ] Test restore defaults
  - [ ] Achieve 90%+ code coverage

- [ ] Task 12: Implement Playwright E2E tests (AC: All)
  - [ ] Test all settings sections display
  - [ ] Test toggle email notifications
  - [ ] Test change language setting
  - [ ] Test restore defaults
  - [ ] Test auto-save with debounce
  - [ ] Verify zero console errors

- [ ] Task 13: Integration and polish (AC: All)
  - [ ] Integrate with Layout Shell (Story 1.17)
  - [ ] Integrate with Settings API (Story 1.21)
  - [ ] Polish styling and UX
  - [ ] Code review and fixes
  - [ ] Documentation updates

---

## Technical Implementation

**File:** `owner/settings/settings.component.ts`

```typescript
import { Component, OnInit, inject, signal } from '@angular/core';
import { FormBuilder, FormGroup, ReactiveFormsModule } from '@angular/forms';
import { SettingsService } from '@/core/services/settings.service';
import { ToastService } from '@/shared/services/toast.service';
import { debounceTime, distinctUntilChanged } from 'rxjs/operators';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-owner-settings',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './settings.component.html'
})
export class SettingsComponent implements OnInit {
  private fb = inject(FormBuilder);
  private settingsService = inject(SettingsService);
  private toastService = inject(ToastService);

  settingsForm!: FormGroup;
  loading = signal(false);
  saving = signal(false);
  saveSuccess = signal(false);

  languages = [
    { value: 'en', label: 'English' },
    { value: 'es', label: 'Spanish' },
    { value: 'fr', label: 'French' }
  ];

  timezones = [
    { value: 'America/New_York', label: 'Eastern Time (ET)' },
    { value: 'America/Chicago', label: 'Central Time (CT)' },
    { value: 'America/Denver', label: 'Mountain Time (MT)' },
    { value: 'America/Los_Angeles', label: 'Pacific Time (PT)' },
    { value: 'UTC', label: 'UTC' }
  ];

  defaultViews = [
    { value: 'dashboard', label: 'Dashboard' },
    { value: 'seat-map', label: 'Seat Map' }
  ];

  ngOnInit() {
    this.initForm();
    this.loadSettings();
    this.setupAutoSave();
  }

  initForm() {
    this.settingsForm = this.fb.group({
      emailNotifications: [true],
      smsNotifications: [false],
      pushNotifications: [true],
      notificationBooking: [true],
      notificationPayment: [true],
      notificationSystem: [true],
      language: ['en'],
      timezone: ['America/New_York'],
      defaultView: ['dashboard'],
      profileVisibility: ['public']
    });
  }

  loadSettings() {
    this.loading.set(true);
    this.settingsService.getSettings().subscribe({
      next: (settings) => {
        this.settingsForm.patchValue(settings, { emitEvent: false });
        this.loading.set(false);
      },
      error: () => {
        this.toastService.error('Failed to load settings');
        this.loading.set(false);
      }
    });
  }

  setupAutoSave() {
    this.settingsForm.valueChanges
      .pipe(
        debounceTime(500),
        distinctUntilChanged()
      )
      .subscribe(() => {
        this.saveSettings();
      });
  }

  saveSettings() {
    this.saving.set(true);
    this.saveSuccess.set(false);

    this.settingsService.updateSettings(this.settingsForm.value).subscribe({
      next: () => {
        this.saving.set(false);
        this.saveSuccess.set(true);
        setTimeout(() => this.saveSuccess.set(false), 2000);
      },
      error: () => {
        this.toastService.error('Failed to save settings');
        this.saving.set(false);
      }
    });
  }

  async restoreDefaults() {
    const confirmed = await this.confirmDialog('Reset all settings to defaults?');
    if (!confirmed) return;

    this.settingsService.restoreDefaults().subscribe({
      next: (defaults) => {
        this.settingsForm.patchValue(defaults);
        this.toastService.success('Settings restored to defaults');
      },
      error: () => {
        this.toastService.error('Failed to restore defaults');
      }
    });
  }
}
```

---

## Testing Requirements

### Playwright E2E Tests

```typescript
test.describe('Owner Settings Page', () => {
  test.beforeEach(async ({ page }) => {
    await loginAsOwner(page);
    await page.goto('/owner/settings');
  });

  test('should display all settings sections', async ({ page }) => {
    await expect(page.locator('text=Notifications')).toBeVisible();
    await expect(page.locator('text=Notification Types')).toBeVisible();
    await expect(page.locator('text=System')).toBeVisible();
    await expect(page.locator('text=Privacy')).toBeVisible();
  });

  test('should toggle email notifications', async ({ page }) => {
    const toggle = page.locator('input[name="emailNotifications"]');

    const initialState = await toggle.isChecked();
    await toggle.click();

    await page.waitForTimeout(600); // Wait for auto-save debounce

    await expect(page.locator('text=âœ“')).toBeVisible(); // Success indicator
  });

  test('should change language setting', async ({ page }) => {
    await page.selectOption('select[name="language"]', 'es');

    await page.waitForTimeout(600);

    await expect(page.locator('text=âœ“')).toBeVisible();
  });

  test('should restore defaults', async ({ page }) => {
    await page.click('button:has-text("Restore Defaults")');

    await page.click('button:has-text("Confirm")'); // Confirmation modal

    await expect(page.locator('text=Settings restored to defaults')).toBeVisible();
  });

  test('should auto-save with debounce', async ({ page }) => {
    // Rapidly toggle multiple times
    const toggle = page.locator('input[name="emailNotifications"]');

    await toggle.click();
    await toggle.click();
    await toggle.click();

    // Should only save once after debounce
    await page.waitForTimeout(600);

    const saveRequests = page.context().getCookies(); // Check API calls
    // Verify only 1 PUT request made (debounced)
  });
});
```

---

## Definition of Done

- [ ] All acceptance criteria met (AC1-AC9)
- [ ] Component implemented with reactive forms
- [ ] Auto-save with debounce functional
- [ ] All tests passing (unit + E2E)
- [ ] Responsive design validated
- [ ] Zero console errors/warnings
- [ ] Code reviewed and approved

---

## References

- **Context7 MCP:** `"use context7 - Angular 20 reactive forms auto-save debounce"`
- **Coding Standards:** [docs/guidelines/coding-standard-guidelines/angular-rules.md](../guidelines/coding-standard-guidelines/angular-rules.md)

---

## Estimated Effort: ~20 hours (5 SP)

---

**Status:** Ready for Development
**Dependencies:** Stories 1.17, 1.21 must be complete

---

## Dev Notes

### Previous Story Insights

**Story 1.17** (Layout Shell) provides routing and layout:
- Settings page renders in `<router-outlet>` at `/owner/settings`
- Layout Shell handles header, footer, and navigation
- Route protected by AuthGuard and RoleGuard

**Story 1.21** (Settings API) provides backend endpoints:
- GET `/owner/settings` - Fetch settings data
- PUT `/owner/settings` - Update settings (partial updates allowed)

**Story 1.18** (Profile Page) provides form patterns:
- Reactive forms with validation
- Loading states and error handling
- Toast notifications for feedback

**Key Learning:** Settings with auto-save require careful debounce handling to avoid excessive API calls.

### Architecture Overview

[Source: docs/architecture/studymate-system-architecture-blueprint.md]
- **Frontend**: Angular 20 with Reactive Forms, Signals, RxJS operators
- **State Management**: Component-level state with Signals
- **Backend**: Spring Boot REST API (Story 1.21)

### RxJS Debounce Pattern

**Auto-save with debounce:**
```typescript
this.settingsForm.valueChanges
  .pipe(
    debounceTime(500),  // Wait 500ms after last change
    distinctUntilChanged()  // Only emit if value actually changed
  )
  .subscribe(() => {
    this.saveSettings();
  });
```

### File Locations

**Component Files:**
- `studymate-frontend/src/app/owner/settings/settings.component.ts`
- `studymate-frontend/src/app/owner/settings/settings.component.html`
- `studymate-frontend/src/app/owner/settings/settings.component.scss`
- `studymate-frontend/src/app/owner/settings/settings.component.spec.ts`

**Service:**
- `studymate-frontend/src/app/core/services/settings.service.ts`
- `studymate-frontend/src/app/core/services/settings.service.spec.ts`

**E2E Tests:**
- `studymate-frontend/e2e/owner-settings.spec.ts`

### API Integration

**Endpoints (from Story 1.21):**
- `GET /owner/settings` - Returns settings DTO
- `PUT /owner/settings` - Updates settings (partial updates supported)
- `POST /owner/settings/restore-defaults` - Restores default settings (if implemented)

**Error Handling:**
- 400: Validation errors (display error message)
- 401: Unauthorized (redirect to login)
- 500: Server error (generic error message)

### Testing Requirements

[Source: docs/architecture/studymate-system-architecture-blueprint.md#5-testing-architecture--quality-assurance]

#### Unit Testing
- **Framework**: Jasmine/Karma
- **Coverage**: 90%+ required
- **Focus**: Form controls, auto-save debounce logic, settings load/save

#### E2E Testing
- **Framework**: Playwright
- **Focus**: Complete settings workflow, auto-save behavior, restore defaults

### context7 MCP Integration (MANDATORY)

[Source: docs/architecture/studymate-system-architecture-blueprint.md#context7-mcp-integration-mandatory]
- **Pre-Implementation**: Consult context7 for Angular 20 reactive forms best practices
- **Required Query**: `"use context7 - Angular 20 reactive forms auto-save debounce"`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Story created for Owner Settings Page | Bob (Scrum Master) |
| 2025-10-12 | 1.1 | Added Tasks/Subtasks and Dev Notes sections | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent during implementation:_
- Document auto-save debounce implementation
- Note any SettingsService methods created
- Describe accordion/collapsible sections approach
- List any shared components created (toggle, dropdown)
- Note any deviations from technical specs

### File List

**Files to Create:**
- `studymate-frontend/src/app/owner/settings/settings.component.ts`
- `studymate-frontend/src/app/owner/settings/settings.component.html`
- `studymate-frontend/src/app/owner/settings/settings.component.scss`
- `studymate-frontend/src/app/owner/settings/settings.component.spec.ts`
- `studymate-frontend/src/app/core/services/settings.service.ts`
- `studymate-frontend/src/app/core/services/settings.service.spec.ts`
- `studymate-frontend/e2e/owner-settings.spec.ts`

**Files to Modify:**
- None (route already configured in Story 1.17)

---

## QA Results

_To be filled by QA Agent_
