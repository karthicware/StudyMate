# Story 2.5-Backend: Implement Check-in/Check-out & QR APIs

## Status
Draft

## Story
**As a** Backend Developer,
**I want** check-in/check-out and QR code APIs implemented,
**so that** students can check in/out via QR codes and track attendance.

## Acceptance Criteria
1. GET `/booking/qr-code/{bookingId}` - Generate QR code
2. POST `/booking/check-in` - Log check-in with QR validation
3. POST `/booking/check-out` - Log check-out timestamp
4. QR codes unique per booking and time-limited
5. Check-in only allowed within time window (±15 min of start time)
6. PostgreSQL MCP validation

## Tasks / Subtasks
- [ ] Create QRCodeController with endpoints
- [ ] Create QRCodeService for generation and validation
- [ ] Use ZXing library for QR code generation
- [ ] Generate unique hash per booking for QR
- [ ] Implement check-in validation (time window, QR match)
- [ ] Update booking record with check-in/check-out timestamps
- [ ] Return QR code as base64 image or PNG
- [ ] Create tests including invalid QR scenarios
- [ ] Validate with PostgreSQL MCP

## Dev Notes

### QR Code Generation
```java
public String generateQRCode(Long bookingId) {
    Booking booking = bookingRepository.findById(bookingId)
        .orElseThrow(() -> new ResourceNotFoundException("Booking not found"));

    // Generate unique hash
    String qrData = generateHash(bookingId, booking.getUserId(), booking.getStartTime());
    booking.setQrCodeHash(qrData);
    bookingRepository.save(booking);

    // Generate QR image
    byte[] qrImage = qrCodeGenerator.generate(qrData, 300, 300);
    return Base64.getEncoder().encodeToString(qrImage);
}
```

### Check-in Validation
```java
public CheckInResponse checkIn(String qrCodeHash) {
    Booking booking = bookingRepository.findByQrCodeHash(qrCodeHash)
        .orElseThrow(() -> new InvalidQRException("Invalid QR code"));

    // Verify time window (±15 minutes of start time)
    LocalDateTime now = LocalDateTime.now();
    LocalDateTime allowedStart = booking.getStartTime().minusMinutes(15);
    LocalDateTime allowedEnd = booking.getStartTime().plusMinutes(15);

    if (now.isBefore(allowedStart) || now.isAfter(allowedEnd)) {
        throw new CheckInTimeWindowException("Check-in outside allowed window");
    }

    if (booking.getCheckInTime() != null) {
        throw new AlreadyCheckedInException("Already checked in");
    }

    booking.setCheckInTime(now);
    bookingRepository.save(booking);

    return new CheckInResponse(booking.getId(), now);
}
```

### Dependencies
```xml
<!-- ZXing for QR Code Generation -->
<dependency>
    <groupId>com.google.zxing</groupId>
    <artifactId>core</artifactId>
    <version>3.5.1</version>
</dependency>
<dependency>
    <groupId>com.google.zxing</groupId>
    <artifactId>javase</artifactId>
    <version>3.5.1</version>
</dependency>
```

### File Locations
- Controller: `controller/QRCodeController.java`
- Service: `service/QRCodeService.java`, `service/CheckInService.java`
- Util: `util/QRCodeGenerator.java`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | QR and check-in APIs backend story | Bob (Scrum Master) |
