# Story 1.22-Backend: Hall Amenities API Implementation (Backend)

## Story Metadata

| Field | Value |
|-------|-------|
| **Story ID** | 1.22-backend |
| **Story Name** | Hall Amenities API Implementation (Backend) |
| **Epic** | Epic 1: Owner Dashboard & Analytics |
| **Feature** | Feature 1.5: Hall Amenities Configuration |
| **Story Type** | Backend Development (Spring Boot 3.5.6, Java 17) |
| **Priority** | Medium |
| **Status** | Approved |
| **Estimated Story Points** | 6 SP |
| **Sprint** | TBD |
| **Assigned To** | Unassigned |
| **Created Date** | 2025-10-17 |
| **Updated Date** | 2025-10-17 |
| **Related Change Proposal** | Sprint Change Proposal B: Space Types & Amenities (SCP-2025-10-16-001) |

---

## User Story

**As a** Backend Developer,
**I want** hall amenities API endpoints implemented
**so that** owners can configure amenities (AC, Wi-Fi) for their study halls and students can filter halls by amenities.

---

## Story Description

This story implements backend REST API endpoints for managing hall amenities configuration. The implementation includes two endpoints: `PUT /owner/halls/{hallId}/amenities` for updating amenities and `GET /owner/halls/{hallId}/amenities` for retrieving current configuration. Amenities are stored in the existing `study_halls.amenities` JSONB column and will be consumed by the student discovery interface (Epic 2).

**Context**:
- Part of Sprint Change Proposal B (SCP-2025-10-16-001) - Space Types & Amenities
- Extends existing StudyHall entity with amenities management
- Predefined amenities: "AC" (Air Conditioning) and "WiFi" (Wi-Fi)
- JSONB column already exists in database schema (no migration needed)
- Frontend implementation is in Story 1.22 (Hall Amenities Configuration UI)

**User Impact**:
- Enables 15% increase in new bookings through amenity-based hall discovery
- Reduces student search friction by providing accurate amenity information
- Improves owner experience with simple amenity management

[Source: Sprint Change Proposal B, Epic 1 Feature 1.5]

---

## Acceptance Criteria

### AC1: GET /owner/halls/{hallId}/amenities Endpoint
**Given** an authenticated owner requests hall amenities
**When** GET `/owner/halls/{hallId}/amenities` is called with valid hallId
**Then** the system:
- Returns 200 OK with amenities DTO
- Response includes: `hallId`, `hallName`, `amenities` array
- Amenities array contains predefined values: `["AC", "WiFi"]` or empty array `[]`
- Verifies owner owns the hall (403 Forbidden if not owner)
- Returns 404 Not Found if hall doesn't exist

**Response Example**:
```json
{
  "hallId": "uuid",
  "hallName": "Downtown Study Hall",
  "amenities": ["AC", "WiFi"]
}
```

**Testing**:
- [ ] GET request returns correct DTO structure
- [ ] Amenities array populated from database JSONB column
- [ ] Owner authorization enforced (403 if not owner)
- [ ] 404 returned for non-existent hall
- [ ] Empty array returned if no amenities configured

[Source: Epic 1 API Endpoints table, Feature 1.5 AC1]

---

### AC2: PUT /owner/halls/{hallId}/amenities Endpoint
**Given** an authenticated owner updates hall amenities
**When** PUT `/owner/halls/{hallId}/amenities` is called with amenities array
**Then** the system:
- Accepts request with `amenities` array: `["AC", "WiFi"]` or empty `[]`
- Validates amenity codes (only "AC" and "WiFi" allowed for MVP)
- Updates `study_halls.amenities` JSONB column
- Returns 200 OK with updated amenities DTO
- Verifies owner owns the hall (403 Forbidden if not owner)
- Returns 404 Not Found if hall doesn't exist
- Returns 400 Bad Request for invalid amenity codes

**Request Payload**:
```json
{
  "amenities": ["AC", "WiFi"]
}
```

**Response Example**:
```json
{
  "hallId": "uuid",
  "hallName": "Downtown Study Hall",
  "amenities": ["AC", "WiFi"]
}
```

**Testing**:
- [ ] PUT request updates database JSONB column
- [ ] Validation rejects invalid amenity codes (e.g., "POOL", "GYM")
- [ ] Empty array `[]` allowed (removes all amenities)
- [ ] Owner authorization enforced (403 if not owner)
- [ ] 404 returned for non-existent hall
- [ ] Transaction committed successfully

[Source: Epic 1 API Endpoints table, Feature 1.5 AC3]

---

### AC3: Amenity Validation
**Given** an owner submits amenities update request
**When** the request contains invalid or unsupported amenity codes
**Then** the system:
- Validates each amenity code against predefined list: `["AC", "WiFi"]`
- Returns 400 Bad Request with error message: "Invalid amenity code: {code}"
- Lists valid amenity codes in error response
- Does not persist invalid data to database

**Valid Amenity Codes** (MVP):
- `"AC"` - Air Conditioning
- `"WiFi"` - Wi-Fi

**Testing**:
- [ ] Validation accepts "AC" and "WiFi"
- [ ] Validation rejects unknown codes (e.g., "POOL", "GYM", "PARKING")
- [ ] Validation rejects empty strings
- [ ] Validation rejects null values in array
- [ ] Error message clearly indicates invalid code

[Source: Feature 1.5 AC2 - Predefined amenity options]

---

### AC4: Owner Authorization
**Given** a request to get or update hall amenities
**When** the authenticated user is not the owner of the hall
**Then** the system:
- Verifies hall ownership at service layer (in addition to `@PreAuthorize`)
- Returns 403 Forbidden with error message: "You do not have permission to access this hall"
- Logs unauthorized access attempt with user ID and hall ID
- Does not expose hall details in error response

**Testing**:
- [ ] Owner can access their own hall amenities
- [ ] Non-owner receives 403 Forbidden
- [ ] Unauthorized access logged for security audit
- [ ] Error response doesn't leak hall information

[Source: Epic 1 Testing Requirements - Owner authorization, Story 1.4-backend AC5 pattern]

---

### AC5: Database Persistence
**Given** amenities are updated via PUT endpoint
**When** the transaction commits successfully
**Then** the system:
- Persists amenities to `study_halls.amenities` JSONB column
- Uses JPA `@Type(JsonBinaryType.class)` for JSONB mapping
- Stores amenities as JSON array: `["AC", "WiFi"]`
- Updates `study_halls.updated_at` timestamp
- Ensures transaction atomicity (rollback on errors)

**Database Schema** (existing):
```sql
CREATE TABLE study_halls (
    id UUID PRIMARY KEY,
    -- ... other columns
    amenities JSONB,  -- ["AC", "WiFi"]
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Testing**:
- [ ] JSONB column updated correctly
- [ ] Array stored as JSON: `["AC", "WiFi"]`
- [ ] Empty array `[]` stored correctly
- [ ] `updated_at` timestamp updated
- [ ] PostgreSQL MCP validation confirms data persistence

[Source: docs/architecture/data-models.md - study_halls table]

---

### AC6: Integration with Student Discovery (Future Epic 2)
**Given** amenities are configured for a hall
**When** students search for halls via `GET /student/search/halls` (Epic 2)
**Then** the system:
- Includes `amenities` array in each hall object
- Allows filtering by amenity query params: `?amenities=AC,WiFi`
- Returns halls matching ALL specified amenities (AND logic)

**Note**: Student-facing endpoint is implemented in Epic 2 (Story 2.2), but this story ensures amenities data is properly stored and accessible.

**Testing**:
- [ ] Amenities saved in this story are accessible via StudyHall entity
- [ ] PostgreSQL MCP query confirms amenities retrievable
- [ ] Documentation notes integration point for Epic 2

[Source: Epic 1 Feature 1.5 AC4, AC5]

---

## Tasks / Subtasks

### Task 1: Create DTOs (AC: 1, 2)
- [x] Create `HallAmenitiesDTO.java` in `dto` package:
  - Fields: `String hallId`, `String hallName`, `List<String> amenities`
  - Add JavaDoc comments
  - Add `@Schema` annotations for OpenAPI documentation
- [x] Create `UpdateHallAmenitiesRequest.java` in `dto` package:
  - Field: `@NotNull List<String> amenities`
  - Add Bean Validation: `@NotNull`, custom validator for amenity codes
  - Add JavaDoc comments
- [x] Write DTO unit tests (field validation, serialization/deserialization)

### Task 2: Create Custom Amenity Validator (AC: 3)
- [x] Create `AmenityValidator.java` in `validation` package
- [x] Implement custom constraint annotation `@ValidAmenities`
- [x] Define predefined amenity codes: `Set.of("AC", "WiFi")`
- [x] Validate each amenity in list against predefined set
- [x] Return validation error for invalid codes with clear message
- [x] Write unit tests for validator (valid codes, invalid codes, empty array, null) - 12 tests

### Task 3: Update StudyHall Entity (AC: 5)
- [x] Open `studymate-backend/src/main/java/com/studymate/backend/model/StudyHall.java`
- [x] Added `amenities` field with JSONB mapping:
  ```java
  @Type(JsonBinaryType.class)
  @Column(columnDefinition = "jsonb")
  private List<String> amenities;
  ```
- [x] Getters/setters generated via Lombok
- [x] Verified `updatedAt` field auto-updates on save via @PreUpdate
- [x] Created migration V13__add_amenities_to_study_halls.sql

### Task 4: Create HallAmenitiesService (AC: 1, 2, 4)
- [x] Create `HallAmenitiesService.java` in `service` package
- [x] Implement `getHallAmenities(Long hallId, String ownerEmail)`:
  - Fetch StudyHall by ID
  - Verify ownership (throw ForbiddenException if not owner)
  - Map to HallAmenitiesDTO
  - Return DTO
- [x] Implement `updateHallAmenities(Long hallId, UpdateHallAmenitiesRequest request, String ownerEmail)`:
  - Fetch StudyHall by ID
  - Verify ownership (throw ForbiddenException if not owner)
  - Update amenities field with request.amenities
  - Save entity (triggers `updatedAt` update)
  - Return updated HallAmenitiesDTO
- [x] Add `@Transactional` annotation to update method
- [x] Add comprehensive logging (INFO for success, WARN for unauthorized access)
- [x] Write 9 unit tests covering all scenarios

### Task 5: Create HallAmenitiesController (AC: 1, 2, 4)
- [x] Create `HallAmenitiesController.java` in `controller` package
- [x] Add `@RestController` and `@RequestMapping("/owner/halls")`
- [x] Implement GET endpoint with Long hallId (matching entity ID type)
- [x] Implement PUT endpoint with Long hallId
- [x] Add OpenAPI annotations (`@Operation`, `@ApiResponse`, `@Tag`)
- [x] Add comprehensive error handling (404, 403, 400)
- [x] Write 12 integration tests using MockMvc (including unauthenticated test)

### Task 6: Exception Handling (AC: 1, 2, 4)
- [x] Created `HallNotFoundException` (throw 404)
- [x] Verified `ForbiddenException` exists (throw 403)
- [x] Added handler in GlobalExceptionHandler for HallNotFoundException
- [x] Tested all exception scenarios in controller tests

### Task 7: Unit Testing - Service Layer (AC: All)
- [x] Write test: `getHallAmenities_Success()` - Owner retrieves amenities
- [x] Write test: `getHallAmenities_EmptyAmenities_ReturnsEmptyList()` - Null amenities returns empty list
- [x] Write test: `getHallAmenities_HallNotFound()` - 404 when hall doesn't exist
- [x] Write test: `getHallAmenities_NotOwner()` - 403 when user doesn't own hall
- [x] Write test: `updateHallAmenities_Success()` - Owner updates amenities
- [x] Write test: `updateHallAmenities_EmptyArray()` - Owner removes all amenities
- [x] Write test: `updateHallAmenities_HallNotFound()` - 404 when hall doesn't exist
- [x] Write test: `updateHallAmenities_NotOwner()` - 403 when user doesn't own hall
- [x] Write test: `updateHallAmenities_BothAmenities()` - Both AC and WiFi
- [x] Achieved high service test coverage (9 tests)

### Task 8: Integration Testing - Controller Layer (AC: All)
- [x] Write test: `getHallAmenities_ReturnsAmenities()` - GET returns 200 with DTO
- [x] Write test: `getHallAmenities_EmptyAmenities_ReturnsEmptyArray()`
- [x] Write test: `getHallAmenities_HallNotFound_Returns404()`
- [x] Write test: `getHallAmenities_NotOwner_Returns403()`
- [x] Write test: `updateHallAmenities_Success_Returns200()` - PUT updates amenities
- [x] Write test: `updateHallAmenities_EmptyArray_Success()`
- [x] Write test: `updateHallAmenities_InvalidAmenity_Returns400()` - Bean validation
- [x] Write test: `updateHallAmenities_NullAmenities_Returns400()`
- [x] Write test: `updateHallAmenities_HallNotFound_Returns404()`
- [x] Write test: `updateHallAmenities_NotOwner_Returns403()`
- [x] Write test: `updateHallAmenities_BothAmenities_Success()`
- [x] Write test: `updateHallAmenities_Unauthenticated_Returns401()`
- [x] Used `@WebMvcTest` with mocked JWT security beans
- [x] Verified JSON request/response serialization (12 tests)

### Task 9: PostgreSQL MCP Validation (AC: 5, 6)
- [x] Created Flyway migration V13__add_amenities_to_study_halls.sql
- [x] Verified amenities column exists with JSONB type
- [x] Tested amenities JSONB with `["AC", "WiFi"]` - SUCCESS
- [x] Tested empty amenities `[]` - SUCCESS
- [x] Tested single amenity `["AC"]` - SUCCESS
- [x] Verified JSONB type returns "array" - SUCCESS
- [x] Verified JSONB containment query with @> operator - SUCCESS
- [x] All PostgreSQL MCP validation complete

### Task 10: OpenAPI Documentation (AC: All)
- [x] Added springdoc-openapi dependency (version 2.3.0)
- [x] Added `@Tag(name = "Hall Amenities")` to controller
- [x] Added `@Operation` to GET endpoint
- [x] Added `@Operation` to PUT endpoint
- [x] Added `@ApiResponse` annotations for status codes (200, 400, 403, 404)
- [x] Added `@Schema` annotations to all DTO fields
- [x] OpenAPI annotations complete

### Task 11: Code Review and Documentation
- [x] All acceptance criteria met (AC1-AC6)
- [x] All unit tests passing (9 service + 12 validator = 21 tests)
- [x] All integration tests passing (12 controller tests)
- [x] PostgreSQL MCP validation complete (migration + validation)
- [x] JavaDoc comments added to all public methods
- [x] Total test count: 33 tests (all passing)
- [x] Story implementation complete

---

## Dev Notes

### Previous Story Insights

**From Story 1.4-backend (Seat Configuration API):**
- Multi-layered authorization: `@PreAuthorize` + service-level ownership verification
- Transaction management with `@Transactional` for data integrity
- Bean Validation on DTOs for request validation
- Comprehensive test coverage: 8 service unit tests + 8 controller integration tests
- PostgreSQL MCP validation mandatory for all database changes
- Location: `studymate-backend/src/main/java/com/studymate/backend/controller/`

**From docs/architecture/data-models.md:**
- `study_halls.amenities` JSONB column already exists in schema
- StudyHall entity has `List<String> amenities` field with `@Type(JsonBinaryType.class)`
- No database migration required for this story
- Owner authorization pattern: Verify `studyHall.getOwner().getId()` matches authenticated user

**From Epic 1 Feature 1.5:**
- Predefined amenities for MVP: AC (Air Conditioning), WiFi (Wi-Fi)
- Extensible design for future amenities (Parking, Lounge, Library, etc.)
- Students filter halls by amenities in Epic 2 (Story 2.1, 2.2)
- 15% increase in new bookings expected from amenity filtering

### Data Models

**Database Schema - study_halls table**:
[Source: docs/architecture/data-models.md]
```sql
CREATE TABLE study_halls (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    hall_name VARCHAR(255) NOT NULL,
    -- ... other columns
    amenities JSONB,  -- ["AC", "WiFi"] or []
    -- ... other columns
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- No indexes needed on JSONB column for MVP (future optimization)
```

**Backend Java - StudyHall Entity**:
[Source: docs/architecture/data-models.md]
```java
@Entity
@Table(name = "study_halls")
public class StudyHall {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "owner_id", nullable = false)
    private User owner;

    @Column(nullable = false)
    private String hallName;

    // NEW: Amenities field (already exists in entity)
    @Type(JsonBinaryType.class)
    @Column(columnDefinition = "jsonb")
    private List<String> amenities;  // ["AC", "WiFi"]

    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt = LocalDateTime.now();

    private LocalDateTime updatedAt = LocalDateTime.now();

    // Getters and setters...
}
```

**DTOs**:
```java
// HallAmenitiesDTO.java
@Schema(description = "Hall amenities configuration")
public class HallAmenitiesDTO {
    @Schema(description = "Hall ID", example = "uuid")
    private String hallId;

    @Schema(description = "Hall name", example = "Downtown Study Hall")
    private String hallName;

    @Schema(description = "List of amenity codes", example = "[\"AC\", \"WiFi\"]")
    private List<String> amenities;

    // Constructor, getters, setters
}

// UpdateHallAmenitiesRequest.java
@Schema(description = "Request to update hall amenities")
public class UpdateHallAmenitiesRequest {
    @NotNull(message = "Amenities list cannot be null")
    @ValidAmenities(message = "Invalid amenity codes. Valid codes: AC, WiFi")
    @Schema(description = "List of amenity codes to set", example = "[\"AC\", \"WiFi\"]")
    private List<String> amenities;

    // Constructor, getters, setters
}
```

### API Specifications

**GET /owner/halls/{hallId}/amenities** - Retrieve Hall Amenities
[Source: Epic 1 API Endpoints table]
- **Purpose**: Fetch current amenity configuration for a hall
- **Authorization**: Owner must own the hall
- **Request**: No body, hallId in URL path
- **Response** (200 OK):
  ```json
  {
    "hallId": "uuid",
    "hallName": "Downtown Study Hall",
    "amenities": ["AC", "WiFi"]
  }
  ```
- **Error Responses**:
  - 401 Unauthorized: User not authenticated
  - 403 Forbidden: User doesn't own this hall
  - 404 Not Found: Hall doesn't exist

**PUT /owner/halls/{hallId}/amenities** - Update Hall Amenities
[Source: Epic 1 API Endpoints table]
- **Purpose**: Update amenity configuration for a hall
- **Authorization**: Owner must own the hall
- **Request**:
  ```json
  {
    "amenities": ["AC", "WiFi"]  // Empty array [] removes all amenities
  }
  ```
- **Response** (200 OK):
  ```json
  {
    "hallId": "uuid",
    "hallName": "Downtown Study Hall",
    "amenities": ["AC", "WiFi"]
  }
  ```
- **Error Responses**:
  - 400 Bad Request: Invalid amenity codes
  - 401 Unauthorized: User not authenticated
  - 403 Forbidden: User doesn't own this hall
  - 404 Not Found: Hall doesn't exist

### Custom Validator Implementation

**@ValidAmenities Constraint**:
```java
@Target({ ElementType.FIELD, ElementType.PARAMETER })
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = AmenityValidator.class)
public @interface ValidAmenities {
    String message() default "Invalid amenity codes";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

// AmenityValidator.java
public class AmenityValidator implements ConstraintValidator<ValidAmenities, List<String>> {
    private static final Set<String> VALID_AMENITIES = Set.of("AC", "WiFi");

    @Override
    public boolean isValid(List<String> amenities, ConstraintValidatorContext context) {
        if (amenities == null) {
            return false;  // @NotNull handles null, but double-check
        }

        for (String amenity : amenities) {
            if (amenity == null || !VALID_AMENITIES.contains(amenity)) {
                context.disableDefaultConstraintViolation();
                context.buildConstraintViolationWithTemplate(
                    "Invalid amenity code: " + amenity + ". Valid codes: AC, WiFi"
                ).addConstraintViolation();
                return false;
            }
        }
        return true;
    }
}
```

### File Locations

**Backend Files to Create**:
- `studymate-backend/src/main/java/com/studymate/backend/dto/HallAmenitiesDTO.java` (NEW)
- `studymate-backend/src/main/java/com/studymate/backend/dto/UpdateHallAmenitiesRequest.java` (NEW)
- `studymate-backend/src/main/java/com/studymate/backend/validation/ValidAmenities.java` (NEW - constraint annotation)
- `studymate-backend/src/main/java/com/studymate/backend/validation/AmenityValidator.java` (NEW - validator)
- `studymate-backend/src/main/java/com/studymate/backend/service/HallAmenitiesService.java` (NEW)
- `studymate-backend/src/main/java/com/studymate/backend/controller/HallAmenitiesController.java` (NEW)

**Backend Files to Verify (Already Exist)**:
- `studymate-backend/src/main/java/com/studymate/backend/model/StudyHall.java` (verify amenities field)
- `studymate-backend/src/main/java/com/studymate/backend/repository/StudyHallRepository.java` (no changes needed)
- `studymate-backend/src/main/java/com/studymate/backend/exception/HallNotFoundException.java` (verify exists)
- `studymate-backend/src/main/java/com/studymate/backend/exception/ForbiddenException.java` (create if missing)

**Test Files**:
- `studymate-backend/src/test/java/com/studymate/backend/service/HallAmenitiesServiceTest.java` (NEW - 8+ unit tests)
- `studymate-backend/src/test/java/com/studymate/backend/controller/HallAmenitiesControllerTest.java` (NEW - 8+ integration tests)
- `studymate-backend/src/test/java/com/studymate/backend/validation/AmenityValidatorTest.java` (NEW - validator tests)

### Technical Constraints

**Backend**:
- Spring Boot 3.5.6, Java 17
- JPA with Hibernate for ORM
- JSONB type mapping with `@Type(JsonBinaryType.class)`
- Bean Validation for request validation
- Multi-layered authorization: `@PreAuthorize` + service-level ownership check
- Transaction management with `@Transactional`

**Database**:
- PostgreSQL JSONB column: `study_halls.amenities`
- Store as JSON array: `["AC", "WiFi"]`
- Empty array `[]` is valid (no amenities)
- No database migration needed (column already exists)

**Validation**:
- Predefined amenity codes: `AC`, `WiFi` (case-sensitive)
- Custom `@ValidAmenities` constraint validator
- Empty array `[]` is valid
- Null array is invalid (Bean Validation `@NotNull`)
- Null elements in array are invalid

**Error Handling**:
- 400 Bad Request: Invalid amenity codes, validation errors
- 401 Unauthorized: User not authenticated
- 403 Forbidden: User doesn't own the hall
- 404 Not Found: Hall doesn't exist
- 500 Internal Server Error: Unexpected errors (logged)

### Testing Standards

**Unit Testing - Service Layer**:
[Source: Story 1.4-backend testing patterns]
- Framework: JUnit 5 with Mockito
- Test file location: `src/test/java/com/studymate/backend/service/`
- Coverage requirement: 90%+ for new code
- Test patterns:
  - `getHallAmenities_Success()` - Owner retrieves amenities
  - `getHallAmenities_HallNotFound()` - Hall doesn't exist
  - `getHallAmenities_NotOwner()` - Ownership violation
  - `updateHallAmenities_Success()` - Owner updates amenities
  - `updateHallAmenities_EmptyArray()` - Remove all amenities
  - `updateHallAmenities_InvalidAmenity()` - Validation error
  - `updateHallAmenities_HallNotFound()` - Hall doesn't exist
  - `updateHallAmenities_NotOwner()` - Ownership violation

**Integration Testing - Controller Layer**:
[Source: Story 1.4-backend testing patterns]
- Framework: Spring Boot Test with MockMvc
- Test file location: `src/test/java/com/studymate/backend/controller/`
- Coverage requirement: All HTTP endpoints tested
- Test patterns:
  - `@WebMvcTest(HallAmenitiesController.class)`
  - `@MockBean` for service layer
  - Verify JSON request/response serialization
  - Verify HTTP status codes (200, 400, 403, 404)
  - Verify Bean Validation constraints
  - Verify security annotations (`@PreAuthorize`)

**PostgreSQL MCP Validation**:
[Source: Epic 1 Testing Requirements]
- MANDATORY for all database changes
- Validate JSONB column updated correctly
- Validate data integrity after operations
- Validate empty array `[]` stored correctly
- Use queries from "PostgreSQL MCP Validation" section

### Integration Notes

**Integration Point 1**: Frontend (Story 1.22 - UNBLOCKS)
- Frontend depends on these backend endpoints
- Frontend sends `["AC", "WiFi"]` array format (matches backend)
- Frontend displays success/error messages based on HTTP status codes
- Type safety: Both use `string[]` for amenities array

**Integration Point 2**: Student Discovery (Epic 2 - FUTURE)
- Amenities saved here will be visible in `GET /student/search/halls` API
- Students can filter halls by amenity query params: `?amenities=AC,WiFi`
- Epic 2 implementation reads from `study_halls.amenities` JSONB column
- MUST work for student search and hall preview cards

**Integration Point 3**: Database Schema
- `study_halls.amenities` JSONB column already exists (no migration)
- JPA entity already has field with `@Type(JsonBinaryType.class)` mapping
- `updated_at` timestamp auto-updates on entity save
- No foreign keys or constraints on amenities field

### Assumptions

1. **StudyHall entity amenities field exists**: Field already present with JSONB mapping
2. **No database migration needed**: JSONB column already exists in schema
3. **Predefined amenities for MVP**: Only "AC" and "WiFi" (extensible in future)
4. **Case-sensitive amenity codes**: "AC" and "WiFi" (not "ac" or "wifi")
5. **No business logic for amenity validation**: Any hall can have any amenity combination
6. **No approval workflow**: Amenity changes are immediate
7. **No audit log required**: Standard `updated_at` timestamp sufficient for MVP
8. **No l10n/i18n for amenity names**: English codes only ("AC", "WiFi")

### Project Structure Notes

[Source: docs/architecture/unified-project-structure.md]
- Spring Boot 3.5.6, Java 17
- PostgreSQL with JPA/Hibernate
- Bean Validation for DTOs
- Constructor injection (no `@Autowired` field injection)
- SLF4J for logging
- OpenAPI/Swagger for API documentation
- Context7 MCP MUST be used for Spring Boot 3.5.6 API documentation

---

## Technical Implementation Details

### Service Implementation

**File**: `studymate-backend/src/main/java/com/studymate/backend/service/HallAmenitiesService.java`

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class HallAmenitiesService {
    private final StudyHallRepository studyHallRepository;

    /**
     * Retrieves hall amenities for the specified hall.
     *
     * @param hallId Hall ID
     * @param ownerEmail Authenticated owner's email
     * @return HallAmenitiesDTO with current amenities
     * @throws HallNotFoundException if hall doesn't exist
     * @throws ForbiddenException if user doesn't own the hall
     */
    @Transactional(readOnly = true)
    public HallAmenitiesDTO getHallAmenities(UUID hallId, String ownerEmail) {
        log.debug("Fetching amenities for hall: {}", hallId);

        StudyHall hall = studyHallRepository.findById(hallId)
            .orElseThrow(() -> new HallNotFoundException("Hall not found: " + hallId));

        verifyHallOwnership(hall, ownerEmail);

        List<String> amenities = hall.getAmenities() != null ? hall.getAmenities() : List.of();

        log.info("Retrieved amenities for hall {}: {}", hallId, amenities);

        return new HallAmenitiesDTO(
            hall.getId().toString(),
            hall.getHallName(),
            amenities
        );
    }

    /**
     * Updates hall amenities configuration.
     *
     * @param hallId Hall ID
     * @param request Update request with amenities array
     * @param ownerEmail Authenticated owner's email
     * @return Updated HallAmenitiesDTO
     * @throws HallNotFoundException if hall doesn't exist
     * @throws ForbiddenException if user doesn't own the hall
     */
    @Transactional
    public HallAmenitiesDTO updateHallAmenities(
            UUID hallId,
            UpdateHallAmenitiesRequest request,
            String ownerEmail) {

        log.debug("Updating amenities for hall: {}", hallId);

        StudyHall hall = studyHallRepository.findById(hallId)
            .orElseThrow(() -> new HallNotFoundException("Hall not found: " + hallId));

        verifyHallOwnership(hall, ownerEmail);

        hall.setAmenities(request.getAmenities());
        hall.setUpdatedAt(LocalDateTime.now());

        studyHallRepository.save(hall);

        log.info("Updated amenities for hall {}: {}", hallId, request.getAmenities());

        return new HallAmenitiesDTO(
            hall.getId().toString(),
            hall.getHallName(),
            hall.getAmenities()
        );
    }

    private void verifyHallOwnership(StudyHall hall, String ownerEmail) {
        if (!hall.getOwner().getEmail().equals(ownerEmail)) {
            log.warn("Unauthorized access attempt: User {} tried to access hall {}",
                ownerEmail, hall.getId());
            throw new ForbiddenException("You do not have permission to access this hall");
        }
    }
}
```

---

### Controller Implementation

**File**: `studymate-backend/src/main/java/com/studymate/backend/controller/HallAmenitiesController.java`

```java
@RestController
@RequestMapping("/owner/halls")
@RequiredArgsConstructor
@Tag(name = "Hall Amenities", description = "Manage hall amenities configuration")
@Slf4j
public class HallAmenitiesController {
    private final HallAmenitiesService hallAmenitiesService;

    @GetMapping("/{hallId}/amenities")
    @PreAuthorize("hasRole('OWNER')")
    @Operation(summary = "Get hall amenities", description = "Retrieve current amenities configuration for a hall")
    @ApiResponse(responseCode = "200", description = "Amenities retrieved successfully")
    @ApiResponse(responseCode = "403", description = "User doesn't own this hall")
    @ApiResponse(responseCode = "404", description = "Hall not found")
    public ResponseEntity<HallAmenitiesDTO> getHallAmenities(
            @PathVariable UUID hallId,
            @AuthenticationPrincipal UserDetails userDetails) {

        log.debug("GET /owner/halls/{}/amenities by user: {}", hallId, userDetails.getUsername());

        HallAmenitiesDTO response = hallAmenitiesService.getHallAmenities(
            hallId,
            userDetails.getUsername()
        );

        return ResponseEntity.ok(response);
    }

    @PutMapping("/{hallId}/amenities")
    @PreAuthorize("hasRole('OWNER')")
    @Operation(summary = "Update hall amenities", description = "Update amenities configuration for a hall")
    @ApiResponse(responseCode = "200", description = "Amenities updated successfully")
    @ApiResponse(responseCode = "400", description = "Invalid amenity codes")
    @ApiResponse(responseCode = "403", description = "User doesn't own this hall")
    @ApiResponse(responseCode = "404", description = "Hall not found")
    public ResponseEntity<HallAmenitiesDTO> updateHallAmenities(
            @PathVariable UUID hallId,
            @Valid @RequestBody UpdateHallAmenitiesRequest request,
            @AuthenticationPrincipal UserDetails userDetails) {

        log.debug("PUT /owner/halls/{}/amenities by user: {} with amenities: {}",
            hallId, userDetails.getUsername(), request.getAmenities());

        HallAmenitiesDTO response = hallAmenitiesService.updateHallAmenities(
            hallId,
            request,
            userDetails.getUsername()
        );

        return ResponseEntity.ok(response);
    }
}
```

[Source: Sprint Change Proposal B, Story 1.4-backend patterns]

---

## Testing Requirements

### Service Unit Tests

**File**: `studymate-backend/src/test/java/com/studymate/backend/service/HallAmenitiesServiceTest.java`

```java
@ExtendWith(MockitoExtension.class)
class HallAmenitiesServiceTest {
    @Mock
    private StudyHallRepository studyHallRepository;

    @InjectMocks
    private HallAmenitiesService hallAmenitiesService;

    private StudyHall testHall;
    private User owner;

    @BeforeEach
    void setUp() {
        owner = new User();
        owner.setEmail("owner@test.com");

        testHall = new StudyHall();
        testHall.setId(UUID.randomUUID());
        testHall.setHallName("Test Hall");
        testHall.setOwner(owner);
        testHall.setAmenities(List.of("AC", "WiFi"));
    }

    @Test
    void getHallAmenities_Success() {
        when(studyHallRepository.findById(testHall.getId()))
            .thenReturn(Optional.of(testHall));

        HallAmenitiesDTO result = hallAmenitiesService.getHallAmenities(
            testHall.getId(),
            "owner@test.com"
        );

        assertThat(result.getHallId()).isEqualTo(testHall.getId().toString());
        assertThat(result.getAmenities()).containsExactly("AC", "WiFi");
    }

    @Test
    void getHallAmenities_HallNotFound() {
        when(studyHallRepository.findById(any()))
            .thenReturn(Optional.empty());

        assertThrows(HallNotFoundException.class, () ->
            hallAmenitiesService.getHallAmenities(UUID.randomUUID(), "owner@test.com")
        );
    }

    @Test
    void getHallAmenities_NotOwner() {
        when(studyHallRepository.findById(testHall.getId()))
            .thenReturn(Optional.of(testHall));

        assertThrows(ForbiddenException.class, () ->
            hallAmenitiesService.getHallAmenities(testHall.getId(), "other@test.com")
        );
    }

    @Test
    void updateHallAmenities_Success() {
        when(studyHallRepository.findById(testHall.getId()))
            .thenReturn(Optional.of(testHall));
        when(studyHallRepository.save(any())).thenReturn(testHall);

        UpdateHallAmenitiesRequest request = new UpdateHallAmenitiesRequest(List.of("AC"));

        HallAmenitiesDTO result = hallAmenitiesService.updateHallAmenities(
            testHall.getId(),
            request,
            "owner@test.com"
        );

        assertThat(result.getAmenities()).containsExactly("AC");
        verify(studyHallRepository).save(testHall);
    }

    @Test
    void updateHallAmenities_EmptyArray() {
        when(studyHallRepository.findById(testHall.getId()))
            .thenReturn(Optional.of(testHall));
        when(studyHallRepository.save(any())).thenReturn(testHall);

        UpdateHallAmenitiesRequest request = new UpdateHallAmenitiesRequest(List.of());

        HallAmenitiesDTO result = hallAmenitiesService.updateHallAmenities(
            testHall.getId(),
            request,
            "owner@test.com"
        );

        assertThat(result.getAmenities()).isEmpty();
    }

    // Additional tests: NotOwner, HallNotFound scenarios...
}
```

---

### Controller Integration Tests

**File**: `studymate-backend/src/test/java/com/studymate/backend/controller/HallAmenitiesControllerTest.java`

```java
@WebMvcTest(HallAmenitiesController.class)
class HallAmenitiesControllerTest {
    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private HallAmenitiesService hallAmenitiesService;

    @Test
    @WithMockUser(username = "owner@test.com", roles = "OWNER")
    void getHallAmenities_ReturnsAmenities() throws Exception {
        UUID hallId = UUID.randomUUID();
        HallAmenitiesDTO dto = new HallAmenitiesDTO(
            hallId.toString(),
            "Test Hall",
            List.of("AC", "WiFi")
        );

        when(hallAmenitiesService.getHallAmenities(hallId, "owner@test.com"))
            .thenReturn(dto);

        mockMvc.perform(get("/owner/halls/{hallId}/amenities", hallId))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.hallId").value(hallId.toString()))
            .andExpect(jsonPath("$.amenities").isArray())
            .andExpect(jsonPath("$.amenities[0]").value("AC"))
            .andExpect(jsonPath("$.amenities[1]").value("WiFi"));
    }

    @Test
    @WithMockUser(username = "owner@test.com", roles = "OWNER")
    void updateHallAmenities_Success_Returns200() throws Exception {
        UUID hallId = UUID.randomUUID();
        HallAmenitiesDTO dto = new HallAmenitiesDTO(
            hallId.toString(),
            "Test Hall",
            List.of("AC")
        );

        when(hallAmenitiesService.updateHallAmenities(any(), any(), any()))
            .thenReturn(dto);

        String requestBody = "{\"amenities\": [\"AC\"]}";

        mockMvc.perform(put("/owner/halls/{hallId}/amenities", hallId)
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestBody))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.amenities[0]").value("AC"));
    }

    @Test
    @WithMockUser(username = "owner@test.com", roles = "OWNER")
    void updateHallAmenities_InvalidAmenity_Returns400() throws Exception {
        UUID hallId = UUID.randomUUID();

        String requestBody = "{\"amenities\": [\"POOL\"]}";

        mockMvc.perform(put("/owner/halls/{hallId}/amenities", hallId)
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestBody))
            .andExpect(status().isBadRequest());
    }

    // Additional tests: 403 Forbidden, 404 Not Found scenarios...
}
```

---

### PostgreSQL MCP Validation

```sql
-- Verify amenities updated in database
SELECT id, hall_name, amenities, updated_at
FROM study_halls
WHERE id = '<test_hall_id>';

-- Expected result:
-- amenities: ["AC", "WiFi"]

-- Test empty amenities (no amenities configured)
SELECT amenities FROM study_halls WHERE id = '<test_hall_id>';
-- Expected: []

-- Test single amenity (only AC)
SELECT amenities FROM study_halls WHERE id = '<test_hall_id>';
-- Expected: ["AC"]

-- Verify JSONB structure
SELECT jsonb_typeof(amenities) FROM study_halls WHERE id = '<test_hall_id>';
-- Expected: "array"

-- Verify updated_at timestamp changes
SELECT updated_at FROM study_halls WHERE id = '<test_hall_id>';
-- Expected: Timestamp updated after PUT request

-- Verify amenities accessible for student discovery (future Epic 2)
SELECT id, hall_name, amenities
FROM study_halls
WHERE amenities @> '["AC"]'::jsonb;
-- Expected: Returns halls with AC amenity
```

[Source: Sprint Change Proposal B, Epic 1 Testing Requirements]

---

## Definition of Done

- [x] All acceptance criteria met (AC1-AC6)
- [x] DTOs created with Bean Validation
- [x] Custom `@ValidAmenities` validator implemented (12 tests)
- [x] Service layer implemented with ownership verification (9 tests)
- [x] Controller implemented with `@PreAuthorize` security (12 tests)
- [x] All unit tests passing (21 tests: 9 service + 12 validator)
- [x] All integration tests passing (12 controller tests)
- [x] PostgreSQL MCP validation complete (migration V13 + validation)
- [x] OpenAPI documentation added (springdoc-openapi 2.3.0)
- [x] Code ready for review
- [x] Zero critical or high-severity bugs

---

## Dependencies & Blockers

### Blocked By:
- Epic 0.1 (Authentication & Onboarding) - Owner authentication required

### Depends On:
- StudyHall entity with `amenities` field (ALREADY EXISTS in data-models.md)
- PostgreSQL database schema (ALREADY EXISTS)

### Unblocks:
- ✅ **Story 1.22 (Hall Amenities Configuration UI - Frontend)** - CRITICAL DEPENDENCY
  - Frontend requires these backend endpoints
  - Frontend displays amenities via GET endpoint
  - Frontend updates amenities via PUT endpoint
- ✅ Epic 2 Story 2.1 (Google Maps API Integration) - Students filter halls by amenities
- ✅ Epic 2 Story 2.2 (Study Hall Search Service) - Amenity filtering in search

[Source: Epic 1 Dependencies, Sprint Change Proposal B]

---

## References

- **Context7 MCP:** MANDATORY - Use for Spring Boot 3.5.6, Java 17, Bean Validation documentation
- **Coding Standards:** [docs/guidelines/coding-standard-guidelines/java-spring-rules.md](../guidelines/coding-standard-guidelines/java-spring-rules.md)
- **Sprint Change Proposal B:** [docs/proposals/sprint-change-proposal-b.md](../proposals/sprint-change-proposal-b.md)
- **Data Models:** [docs/architecture/data-models.md](../architecture/data-models.md)
- **Story 1.4-backend (API Pattern Reference):** [docs/epics/1.4-backend.story.md](1.4-backend.story.md)

---

## Estimated Effort: ~24 hours (6 SP)

---

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### File List
**New Files Created:**
- `studymate-backend/src/main/java/com/studymate/backend/dto/HallAmenitiesDTO.java`
- `studymate-backend/src/main/java/com/studymate/backend/dto/UpdateHallAmenitiesRequest.java`
- `studymate-backend/src/main/java/com/studymate/backend/validation/ValidAmenities.java`
- `studymate-backend/src/main/java/com/studymate/backend/validation/AmenityValidator.java`
- `studymate-backend/src/main/java/com/studymate/backend/service/HallAmenitiesService.java`
- `studymate-backend/src/main/java/com/studymate/backend/controller/HallAmenitiesController.java`
- `studymate-backend/src/main/java/com/studymate/backend/exception/HallNotFoundException.java`
- `studymate-backend/src/test/java/com/studymate/backend/service/HallAmenitiesServiceTest.java`
- `studymate-backend/src/test/java/com/studymate/backend/controller/HallAmenitiesControllerTest.java`
- `studymate-backend/src/test/java/com/studymate/backend/validation/AmenityValidatorTest.java`
- `studymate-backend/src/main/resources/db/migration/V13__add_amenities_to_study_halls.sql`

**Modified Files:**
- `studymate-backend/src/main/java/com/studymate/backend/model/StudyHall.java` (added amenities field)
- `studymate-backend/src/main/java/com/studymate/backend/exception/GlobalExceptionHandler.java` (added HallNotFoundException handler)
- `studymate-backend/pom.xml` (added springdoc-openapi dependency)

### Completion Notes
- ✅ All 6 acceptance criteria met
- ✅ 33 tests written and passing (9 service + 12 controller + 12 validator)
- ✅ PostgreSQL migration created and applied (V13)
- ✅ JSONB validation complete with PostgreSQL MCP
- ✅ OpenAPI documentation complete with springdoc-openapi 2.3.0
- ✅ Custom validation for amenity codes ("AC", "WiFi")
- ✅ Multi-layer authorization (JWT + ownership verification)
- ✅ All endpoints tested: GET /owner/halls/{id}/amenities, PUT /owner/halls/{id}/amenities
- **Note**: Used Long for hallId (matching existing StudyHall entity ID type)

### Debug Log
No critical issues encountered. Minor adjustments:
- Added springdoc-openapi dependency for @Schema annotations
- Mocked JWT security beans in controller tests (@WebMvcTest pattern)
- Fixed Mockito unnecessary stubbing warnings in validator tests

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Story created from Sprint Change Proposal B for Hall Amenities API Implementation (Backend) | Bob (SM) |
| 2025-10-18 | 2.0 | Implementation complete - All tasks, tests, and validations passed | James (Dev Agent) |

---

**Story Status**: Ready for Review
**Last Updated**: 2025-10-18
**Next Steps**: Code review, merge to main, deploy to staging

---

## QA Results

### Review Date: 2025-10-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Grade: EXCELLENT**

This implementation demonstrates exceptional quality across all dimensions. The code exhibits clean architecture, comprehensive test coverage, proper security patterns, and production-ready standards compliance.

**Strengths:**
- **Clean Architecture**: Well-structured Controller → Service → Repository pattern with proper separation of concerns
- **Comprehensive Testing**: 33 tests covering all acceptance criteria (9 service + 12 controller + 12 validator)
- **Security Excellence**: Multi-layer authorization (JWT `@PreAuthorize` + service-level ownership verification)
- **Production-Ready**: Comprehensive error handling, transaction management, security audit logging
- **Code Quality**: Constructor injection, appropriate Lombok usage, comprehensive JavaDoc documentation
- **Best Practices**: Read-only transactions on queries, null-safe operations, proper logging levels

### Refactoring Performed

No refactoring was necessary. The implementation already follows all coding standards and best practices.

### Compliance Check

- **Coding Standards** (java-spring-rules.md): ✅ PASS
  - Constructor injection (no field `@Autowired`)
  - Proper exception handling hierarchy
  - Bean Validation on DTOs
  - Lombok usage follows best practices
  - SLF4J logging with appropriate levels

- **Project Structure** (unified-project-structure.md): ✅ PASS
  - Files in correct packages (`controller`, `service`, `dto`, `validation`)
  - Test files mirror source structure
  - Database migration numbered correctly (V13)

- **Testing Strategy**: ✅ PASS
  - Unit tests with mocked dependencies (9 service tests)
  - Integration tests with `@WebMvcTest` (12 controller tests)
  - Validator unit tests (12 tests)
  - PostgreSQL MCP validation complete
  - Total: 33 tests, 100% passing

- **All ACs Met**: ✅ PASS
  - AC1-AC6 fully implemented and tested
  - See Requirements Traceability Matrix below

### Requirements Traceability Matrix

| AC | Requirement | Test Coverage | Status |
|----|-------------|---------------|---------|
| **AC1** | GET /owner/halls/{id}/amenities | `getHallAmenities_ReturnsAmenities()`, `getHallAmenities_EmptyAmenities()`, `getHallAmenities_HallNotFound()`, `getHallAmenities_NotOwner()` | ✅ FULLY COVERED |
| **AC2** | PUT /owner/halls/{id}/amenities | `updateHallAmenities_Success()`, `updateHallAmenities_EmptyArray()`, `updateHallAmenities_BothAmenities()`, `updateHallAmenities_HallNotFound()`, `updateHallAmenities_NotOwner()` | ✅ FULLY COVERED |
| **AC3** | Amenity Validation | `AmenityValidatorTest` (12 tests), `updateHallAmenities_InvalidAmenity()`, `updateHallAmenities_NullAmenities()` | ✅ FULLY COVERED |
| **AC4** | Owner Authorization | `getHallAmenities_NotOwner()`, `updateHallAmenities_NotOwner()`, `updateHallAmenities_Unauthenticated()` | ✅ FULLY COVERED |
| **AC5** | Database Persistence | Migration V13 + JPA mapping + service tests | ✅ FULLY COVERED |
| **AC6** | Epic 2 Integration | Entity accessible + PostgreSQL MCP validation | ✅ FULLY COVERED |

### Security Review

**Status: PASS** ✅

- **Multi-Layer Authorization**:
  - `@PreAuthorize("hasRole('OWNER')")` at controller level
  - Service-level ownership verification via `verifyHallOwnership()`
  - Security audit logging for unauthorized access attempts (studymate-backend/src/main/java/com/studymate/backend/service/HallAmenitiesService.java:103)

- **Input Validation**:
  - Custom `@ValidAmenities` constraint validator
  - Null-safe operations throughout
  - Bean Validation on DTOs (`@NotNull`, `@Valid`)

- **Error Handling**:
  - No sensitive data leakage in error responses
  - Proper HTTP status codes (400/401/403/404)
  - Clear error messages for validation failures

- **Data Protection**:
  - No SQL injection risk (JPA parameterized queries)
  - Transaction atomicity prevents data corruption
  - JSONB column properly sanitized

### Performance Considerations

**Status: PASS** ✅

- Read operations use `@Transactional(readOnly=true)` for optimization
- Lazy loading on `ManyToOne` relationships (`FetchType.LAZY`)
- JSONB column supports efficient querying (future student search)
- Simple CRUD operations (expected response time < 100ms)

**Future Optimization (Low Priority)**:
- Consider adding JSONB GIN index if student amenity search becomes slow
  - Query: `CREATE INDEX idx_study_halls_amenities ON study_halls USING GIN (amenities);`
  - Only needed when student search volume increases (Epic 2)

### Reliability Assessment

**Status: PASS** ✅

- **Error Handling**: Comprehensive coverage for all failure modes (404, 403, 400)
- **Transaction Management**: `@Transactional` ensures atomicity on updates
- **Null Safety**: Amenities default to `List.of()` if null
- **Timestamp Consistency**: `@PreUpdate` ensures `updated_at` always reflects changes
- **Test Coverage**: 100% of acceptance criteria validated

### Files Modified During Review

No files were modified during review. Implementation was production-ready.

### Gate Status

**Gate: PASS** ✅

Gate file: `docs/qa/gates/1.22-backend-hall-amenities-api-implementation.yml`

**Summary**: Excellent implementation with comprehensive test coverage (33 tests), proper architecture, multi-layer security, and full AC compliance. Low risk profile (2/10), production-ready code.

**Quality Score**: 100/100

**Evidence**:
- Tests reviewed: 33 (all passing)
- Risks identified: 0 critical/high, 2 low (future optimizations)
- AC coverage: 6/6 (100%)

### Recommended Status

**✅ Ready for Done**

This story is production-ready and meets all quality standards. No changes required before merging to main.

**Optional Future Enhancements** (Not Blocking):
1. Add JSONB GIN index on amenities column if Epic 2 student search queries become slow
2. Consider adding audit trail for amenity changes (who/when) if compliance requires it
3. Consider extracting VALID_AMENITIES to database table for dynamic management without code deployment

### Test Execution Summary

```
Total Tests: 33
- Service Layer (HallAmenitiesServiceTest): 9 tests ✅
- Controller Layer (HallAmenitiesControllerTest): 12 tests ✅
- Validation Layer (AmenityValidatorTest): 12 tests ✅

Failures: 0
Errors: 0
Skipped: 0

Status: ALL PASSING ✅
```

### PostgreSQL MCP Validation

✅ Migration V13 applied successfully
✅ Amenities column exists (type: JSONB)
✅ JSONB array storage validated
✅ Empty array storage validated
✅ JSONB containment queries validated (@> operator)

---
