# Story 1.1-Backend: Implement Dashboard API Endpoint

## Status
Draft

## Story
**As a** Backend Developer,
**I want** the dashboard metrics API endpoint implemented,
**so that** the frontend can retrieve real-time hall metrics and seat occupancy data.

## Acceptance Criteria
1. GET `/owner/dashboard/{hallId}` endpoint created
2. Dashboard metrics calculated (totalSeats, occupancyPercentage, currentRevenue)
3. Seat map data with current status returned
4. Owner authorization enforced (only hall owner can access)
5. Performance optimized (query execution < 500ms)
6. PostgreSQL MCP validation completed

## Tasks / Subtasks
- [ ] Task 1: Create OwnerDashboardController (AC: 1)
  - [ ] Create `com.studymate.backend.controller.OwnerDashboardController`
  - [ ] Add @RestController and @RequestMapping("/owner/dashboard")
  - [ ] Implement GET `/{hallId}` endpoint
  - [ ] Add @PreAuthorize for OWNER role
  - [ ] Return ResponseEntity<DashboardResponse>
- [ ] Task 2: Create DashboardService (AC: 2, 3)
  - [ ] Create `com.studymate.backend.service.DashboardService`
  - [ ] Implement getDashboardMetrics(Long hallId, Long ownerId)
  - [ ] Query total seats count from seats table
  - [ ] Calculate occupancy from bookings table (active bookings / total seats)
  - [ ] Calculate revenue from confirmed bookings
  - [ ] Fetch seat map with current status
- [ ] Task 3: Create database queries (AC: 2, 3)
  - [ ] Create custom query in SeatRepository: countByHallId
  - [ ] Create custom query in BookingRepository: countActiveBookingsByHallId
  - [ ] Create custom query in BookingRepository: sumRevenueByHallId
  - [ ] Create query to fetch seats with current booking status
  - [ ] Optimize with proper indexing
- [ ] Task 4: Create DTOs (AC: 1, 3)
  - [ ] Create DashboardResponse DTO with metrics and seatMap
  - [ ] Create SeatStatusDTO (id, seatNumber, xCoord, yCoord, status)
  - [ ] Add validation annotations
  - [ ] Add JSON property mappings
- [ ] Task 5: Implement authorization (AC: 4)
  - [ ] Verify authenticated user is OWNER
  - [ ] Verify hallId belongs to the authenticated owner
  - [ ] Return 403 Forbidden if not authorized
  - [ ] Return 404 Not Found if hall doesn't exist
- [ ] Task 6: Optimize performance (AC: 5)
  - [ ] Use JOIN FETCH to avoid N+1 queries
  - [ ] Add database indexes on foreign keys
  - [ ] Implement caching for seat count (rarely changes)
  - [ ] Test query performance with explain analyze
- [ ] Task 7: Create unit tests
  - [ ] Test DashboardService calculations
  - [ ] Mock repository responses
  - [ ] Test edge cases (no seats, no bookings, 100% occupancy)
  - [ ] Test revenue calculation accuracy
- [ ] Task 8: Create integration tests
  - [ ] Test complete endpoint with MockMvc
  - [ ] Test with real database (@SpringBootTest)
  - [ ] Test authorization (owner vs non-owner)
  - [ ] Test 404 for non-existent hall
- [ ] Task 9: Validate with PostgreSQL MCP (AC: 6)
  - [ ] Insert test data via MCP
  - [ ] Query seats count via MCP
  - [ ] Query active bookings via MCP
  - [ ] Verify API response matches database state
  - [ ] Clean up test data

## Dev Notes

### Previous Story Insights
**From Epic 0:** Backend scaffolding complete, auth framework in place
**Story 1.1 (Frontend):** Expects this endpoint to exist

### API Specification
[Source: docs/epics/epic-1-owner-dashboard-analytics.md#api-endpoints]

**Endpoint:** `GET /owner/dashboard/{hallId}`
**Authentication:** Required (JWT Bearer token)
**Authorization:** OWNER role, must own the hall

**Request:**
```
GET /owner/dashboard/1
Authorization: Bearer <jwt-token>
```

**Response (200 OK):**
```json
{
  "totalSeats": 50,
  "occupancyPercentage": 75.0,
  "currentRevenue": 15000.00,
  "seatMap": [
    {
      "id": 1,
      "seatNumber": "A1",
      "xCoord": 10,
      "yCoord": 20,
      "status": "OCCUPIED"
    },
    {
      "id": 2,
      "seatNumber": "A2",
      "xCoord": 10,
      "yCoord": 40,
      "status": "AVAILABLE"
    }
  ]
}
```

**Error Responses:**
- 401 Unauthorized: No valid token
- 403 Forbidden: User is not owner of hall
- 404 Not Found: Hall doesn't exist

### Controller Implementation
```java
@RestController
@RequestMapping("/owner/dashboard")
@RequiredArgsConstructor
@Slf4j
public class OwnerDashboardController {

    private final DashboardService dashboardService;

    @GetMapping("/{hallId}")
    @PreAuthorize("hasRole('OWNER')")
    public ResponseEntity<DashboardResponse> getDashboard(
            @PathVariable Long hallId,
            @AuthenticationPrincipal UserDetails userDetails) {

        log.debug("Fetching dashboard for hall: {}, user: {}", hallId, userDetails.getUsername());

        DashboardResponse response = dashboardService.getDashboardMetrics(hallId, userDetails);
        return ResponseEntity.ok(response);
    }
}
```

### Service Implementation
```java
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class DashboardService {

    private final StudyHallRepository hallRepository;
    private final SeatRepository seatRepository;
    private final BookingRepository bookingRepository;
    private final UserRepository userRepository;

    public DashboardResponse getDashboardMetrics(Long hallId, UserDetails userDetails) {
        // Verify hall exists and user is owner
        StudyHall hall = hallRepository.findById(hallId)
            .orElseThrow(() -> new ResourceNotFoundException("Hall not found"));

        User owner = userRepository.findByEmail(userDetails.getUsername())
            .orElseThrow(() -> new ResourceNotFoundException("User not found"));

        if (!hall.getOwner().getId().equals(owner.getId())) {
            throw new ForbiddenException("You don't have access to this hall");
        }

        // Calculate metrics
        int totalSeats = seatRepository.countByHallId(hallId);
        int activeBookings = bookingRepository.countActiveBookingsByHallId(hallId);
        double occupancyPercentage = totalSeats > 0 ? (activeBookings * 100.0 / totalSeats) : 0.0;
        BigDecimal currentRevenue = bookingRepository.sumRevenueByHallId(hallId);

        // Fetch seat map with status
        List<SeatStatusDTO> seatMap = seatRepository.findSeatMapByHallId(hallId);

        return DashboardResponse.builder()
            .totalSeats(totalSeats)
            .occupancyPercentage(occupancyPercentage)
            .currentRevenue(currentRevenue)
            .seatMap(seatMap)
            .build();
    }
}
```

### Repository Queries
```java
public interface SeatRepository extends JpaRepository<Seat, Long> {

    @Query("SELECT COUNT(s) FROM Seat s WHERE s.hall.id = :hallId")
    int countByHallId(@Param("hallId") Long hallId);

    @Query("SELECT new com.studymate.backend.dto.SeatStatusDTO(" +
           "s.id, s.seatNumber, s.xCoord, s.yCoord, " +
           "CASE WHEN b.id IS NOT NULL THEN 'OCCUPIED' ELSE s.status END) " +
           "FROM Seat s LEFT JOIN Booking b ON s.id = b.seat.id " +
           "AND b.status = 'CONFIRMED' AND b.endTime > CURRENT_TIMESTAMP " +
           "WHERE s.hall.id = :hallId")
    List<SeatStatusDTO> findSeatMapByHallId(@Param("hallId") Long hallId);
}

public interface BookingRepository extends JpaRepository<Booking, Long> {

    @Query("SELECT COUNT(b) FROM Booking b " +
           "WHERE b.seat.hall.id = :hallId " +
           "AND b.status = 'CONFIRMED' " +
           "AND b.endTime > CURRENT_TIMESTAMP")
    int countActiveBookingsByHallId(@Param("hallId") Long hallId);

    @Query("SELECT COALESCE(SUM(b.amount), 0) FROM Booking b " +
           "WHERE b.seat.hall.id = :hallId " +
           "AND b.status = 'CONFIRMED'")
    BigDecimal sumRevenueByHallId(@Param("hallId") Long hallId);
}
```

### DTOs
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class DashboardResponse {
    private int totalSeats;
    private double occupancyPercentage;
    private BigDecimal currentRevenue;
    private List<SeatStatusDTO> seatMap;
}

@Data
@NoArgsConstructor
@AllArgsConstructor
public class SeatStatusDTO {
    private Long id;
    private String seatNumber;
    private Integer xCoord;
    private Integer yCoord;
    private String status; // AVAILABLE, OCCUPIED, LOCKED, MAINTENANCE
}
```

### Database Schema
[Source: docs/epics/epic-0-project-foundation-setup.md#initial-database-schema]
Tables used: users, study_halls, seats, bookings

### Performance Considerations
- Use JOIN FETCH to load seat map in single query
- Index on bookings.seat_id, bookings.status, bookings.end_time
- Consider caching dashboard metrics (refresh every 30 seconds)
- Use database view for complex seat status calculation

### Testing Requirements
[Source: docs/architecture/studymate-system-architecture-blueprint.md#testing]
- Unit tests: 90%+ coverage
- Integration tests: MockMvc + @SpringBootTest
- PostgreSQL MCP: Validate all queries

### File Locations
- Controller: `src/main/java/com/studymate/backend/controller/OwnerDashboardController.java`
- Service: `src/main/java/com/studymate/backend/service/DashboardService.java`
- DTOs: `src/main/java/com/studymate/backend/dto/DashboardResponse.java`, `SeatStatusDTO.java`
- Tests: `src/test/java/com/studymate/backend/controller/OwnerDashboardControllerTest.java`

## Testing

### Unit Tests
- Test service calculates metrics correctly
- Test occupancy percentage edge cases (0 seats, 100% occupied)
- Test revenue calculation with multiple bookings
- Mock all repository calls

### Integration Tests
- Test endpoint returns 200 with valid owner token
- Test endpoint returns 403 for non-owner
- Test endpoint returns 404 for non-existent hall
- Test response structure matches API spec

### PostgreSQL MCP Validation
- Insert test hall with owner
- Insert 10 test seats
- Insert 7 active bookings
- Call API endpoint
- Verify occupancy is 70%
- Verify seat map shows correct statuses
- Clean up test data

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Backend story created for dashboard API | Bob (Scrum Master) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
