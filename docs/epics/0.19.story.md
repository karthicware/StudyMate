# Story 0.19: Configure Spring Security with JWT

## Status
Draft

## Story
**As a** Developer,
**I want** Spring Security configured with JWT authentication,
**so that** API endpoints are secured with token-based authentication.

## Acceptance Criteria
1. Spring Security configured with JWT tokens
2. Security filter chain created for JWT validation
3. JWT utilities created (generate, validate, parse)
4. Public endpoints allow anonymous access (/auth/**, /health)
5. Protected endpoints require valid JWT
6. CORS configured for Angular frontend

## Tasks / Subtasks
- [ ] Task 1: Create JWT configuration class
  - [ ] Add JWT secret to application.properties
  - [ ] Configure token expiration (24 hours)
  - [ ] Create JwtConfig properties class
- [ ] Task 2: Create JwtUtil service (AC: 3)
  - [ ] Implement generateToken(UserDetails)
  - [ ] Implement validateToken(String token)
  - [ ] Implement extractUsername(String token)
  - [ ] Implement extractClaims(String token)
  - [ ] Add expiration checking
- [ ] Task 3: Create JwtAuthenticationFilter (AC: 2)
  - [ ] Extend OncePerRequestFilter
  - [ ] Extract JWT from Authorization header
  - [ ] Validate token and set SecurityContext
  - [ ] Handle invalid/expired tokens
- [ ] Task 4: Update SecurityConfig (AC: 1, 4, 5)
  - [ ] Configure HttpSecurity with JWT filter
  - [ ] Allow /auth/**, /health without authentication
  - [ ] Require authentication for /api/**
  - [ ] Disable session management (stateless)
  - [ ] Configure CORS for http://localhost:4200
- [ ] Task 5: Create UserDetailsService implementation (AC: 1)
  - [ ] Implement loadUserByUsername
  - [ ] Load user from UserRepository
  - [ ] Return UserDetails with roles
  - [ ] Handle user not found
- [ ] Task 6: Create integration tests
  - [ ] Test JWT generation
  - [ ] Test token validation
  - [ ] Test protected endpoint access
  - [ ] Test anonymous access to public endpoints

## Dev Notes

### Previous Story Insights
**From Story 0.7:** Temporary SecurityConfig with permitAll needs to be replaced

### JWT Configuration
```java
@Configuration
@ConfigurationProperties(prefix = "jwt")
@Data
public class JwtConfig {
    private String secret = "your-256-bit-secret-key-change-in-production";
    private long expiration = 86400000; // 24 hours in milliseconds
}
```

### Security Filter Chain
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .csrf(csrf -> csrf.disable())
        .cors(cors -> cors.configurationSource(corsConfigurationSource()))
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/auth/**", "/health").permitAll()
            .requestMatchers("/api/**").authenticated()
            .anyRequest().authenticated()
        )
        .sessionManagement(session -> session
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        )
        .addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);
    return http.build();
}
```

### File Locations
- `config/JwtConfig.java`
- `config/SecurityConfig.java` (update)
- `security/JwtUtil.java`
- `security/JwtAuthenticationFilter.java`
- `security/CustomUserDetailsService.java`

## Testing
- Test JWT generation and validation
- Test protected vs public endpoints
- Test CORS for Angular frontend

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 0, Feature 0.5 | Bob (Scrum Master) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
