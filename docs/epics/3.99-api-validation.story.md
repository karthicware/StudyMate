# Story 3.99: Epic 3 API Validation with PostgreSQL MCP

## Status
Draft

## Story
**As a** QA Engineer,
**I want** all Epic 3 APIs validated end-to-end using PostgreSQL MCP with dummy data,
**so that** I can verify all payment and subscription endpoints work correctly with real database interactions and capture evidence.

## Acceptance Criteria
1. Test data created in database using PostgreSQL MCP (users, subscriptions, payments, invoices)
2. All Epic 3 endpoints tested with MCP-sourced data
3. Test results captured and documented in this story file
4. Razorpay payment integration tested with webhook validation
5. Subscription lifecycle tested (creation, renewal, expiration)
6. Payment verification tested with signature validation
7. Scheduled subscription expiration task tested
8. All edge cases tested (expired subscriptions, failed payments, invalid signatures)
9. Database state verified after each operation

## Tasks / Subtasks
- [ ] Task 1: Setup test data using PostgreSQL MCP (AC: 1)
  - [ ] Create test owner and student users
  - [ ] Create test subscriptions in various states (ACTIVE, EXPIRED, CANCELLED)
  - [ ] Create test payments with various statuses (PENDING, COMPLETED, FAILED)
  - [ ] Create test invoices linked to subscriptions
  - [ ] Capture INSERT results with row counts
- [ ] Task 2: Test authentication with owner user (AC: 2)
  - [ ] Query test owner credentials from database
  - [ ] Call POST /api/auth/login with database owner user
  - [ ] Capture JWT token response
  - [ ] Verify token contains correct user info and OWNER role
  - [ ] Document login response in story file
- [ ] Task 3: Test POST /owner/payments/order (AC: 2, 9)
  - [ ] Prepare order creation request with amount and subscription details
  - [ ] Call endpoint with owner JWT token
  - [ ] Verify Razorpay order creation response
  - [ ] Query database to verify payment record created with PENDING status
  - [ ] Verify order_id stored in database
  - [ ] Capture API response and database verification
- [ ] Task 4: Test POST /owner/payments/verify (AC: 4, 6, 9)
  - [ ] Prepare payment verification request with razorpay_order_id, razorpay_payment_id, razorpay_signature
  - [ ] Call endpoint to verify payment
  - [ ] Verify signature validation logic (HMAC SHA256)
  - [ ] Query database to confirm payment status updated to COMPLETED
  - [ ] Verify subscription status updated to ACTIVE
  - [ ] Test with invalid signature (should fail with 400)
  - [ ] Capture verification response and database state
- [ ] Task 5: Test webhook signature validation (AC: 4, 6)
  - [ ] Create test webhook payload from Razorpay
  - [ ] Generate valid webhook signature using webhook secret
  - [ ] Call webhook endpoint with valid signature
  - [ ] Verify payment status updated via webhook
  - [ ] Test with invalid signature (should reject)
  - [ ] Document signature validation logic
- [ ] Task 6: Test GET /owner/subscriptions (AC: 2)
  - [ ] Call endpoint with owner JWT token
  - [ ] Verify response includes all subscriptions for owner's study hall
  - [ ] Query database to validate subscription list
  - [ ] Test filtering by status (status=ACTIVE)
  - [ ] Test pagination (page=0, size=10)
  - [ ] Capture response and SQL query results
- [ ] Task 7: Test POST /owner/subscriptions (AC: 2, 5, 9)
  - [ ] Prepare subscription creation request with user_id and plan details
  - [ ] Call endpoint with owner JWT token
  - [ ] Query database to verify subscription created with ACTIVE status
  - [ ] Verify start_date and end_date calculated correctly
  - [ ] Verify invoice generated with correct amount
  - [ ] Test creating subscription for non-existent user (404)
  - [ ] Capture subscription creation response and database state
- [ ] Task 8: Test PUT /owner/subscriptions/{subscriptionId} (AC: 2, 5, 9)
  - [ ] Update subscription plan or end date
  - [ ] Call endpoint with owner JWT token
  - [ ] Query database to verify subscription updated
  - [ ] Verify updated fields match request
  - [ ] Test updating non-existent subscription (404)
  - [ ] Test updating another owner's subscription (403)
  - [ ] Capture update response and SQL verification
- [ ] Task 9: Test DELETE /owner/subscriptions/{subscriptionId} (AC: 2, 9)
  - [ ] Call endpoint to cancel subscription
  - [ ] Query database to verify status changed to CANCELLED
  - [ ] Verify end_date updated to current date
  - [ ] Test cancelling already cancelled subscription (400)
  - [ ] Capture cancellation response and database state
- [ ] Task 10: Test GET /owner/subscriptions/{subscriptionId}/invoices (AC: 2)
  - [ ] Query database for subscription with invoices
  - [ ] Call endpoint to get invoice history
  - [ ] Verify response matches database records
  - [ ] Test pagination on invoice history
  - [ ] Capture response and SQL query results
- [ ] Task 11: Test GET /student/subscriptions (AC: 2)
  - [ ] Call endpoint with student JWT token
  - [ ] Verify response shows only authenticated student's subscriptions
  - [ ] Query database to confirm subscription matches
  - [ ] Test student with no subscriptions
  - [ ] Capture response and SQL verification
- [ ] Task 12: Test subscription renewal logic (AC: 5, 9)
  - [ ] Create test subscription expiring soon (end_date in 1 day)
  - [ ] Create payment record for renewal
  - [ ] Call renewal endpoint or trigger auto-renewal
  - [ ] Query database to verify end_date extended by plan duration
  - [ ] Verify new invoice generated
  - [ ] Capture renewal response and database state
- [ ] Task 13: Test scheduled subscription expiration task (AC: 7, 9)
  - [ ] Create test subscription with past end_date
  - [ ] Wait for scheduled task to run (or trigger manually)
  - [ ] Query database to verify subscription status changed to EXPIRED
  - [ ] Verify expired subscriptions no longer appear as active
  - [ ] Document scheduled task behavior
- [ ] Task 14: Test authorization failures (AC: 8)
  - [ ] Test owner accessing another owner's subscriptions (403)
  - [ ] Test student creating subscriptions (403)
  - [ ] Test accessing subscription without JWT token (401)
  - [ ] Test with expired token (401)
  - [ ] Capture error responses
- [ ] Task 15: Test edge cases (AC: 8)
  - [ ] Test payment verification with expired order
  - [ ] Test subscription creation with invalid plan duration
  - [ ] Test renewal of cancelled subscription (should fail)
  - [ ] Test invoice generation for zero-amount subscription
  - [ ] Query database to set up edge case scenarios
  - [ ] Capture responses for each scenario
- [ ] Task 16: Document all results in story file (AC: 3)
  - [ ] Add all SQL queries used
  - [ ] Add all API responses
  - [ ] Add database verification queries
  - [ ] Add Razorpay webhook payload examples
  - [ ] Add screenshots or formatted output

## Dev Notes

### PostgreSQL MCP Integration
[Source: docs/architecture/studymate-system-architecture-blueprint.md#7-postgresql-mcp-integration-mandatory]
- **Database**: studymate_user
- **Credentials**: user=studymate_user, pwd=studymate_user
- **Tool**: `mcp__postgres__query`

### Razorpay Integration Details
- **Webhook Secret**: Use test webhook secret for signature validation
- **Signature Algorithm**: HMAC SHA256
- **Order ID Format**: `order_<random_string>`
- **Payment ID Format**: `pay_<random_string>`

### Test Data Setup Queries
Execute these via PostgreSQL MCP:

```sql
-- 1. Create test owner user
INSERT INTO users (email, password_hash, first_name, last_name, role)
VALUES ('owner@test.com', '$2a$10$...bcrypt_hash...', 'Test', 'Owner', 'OWNER')
RETURNING id, email, role;

-- 2. Create test student users
INSERT INTO users (email, password_hash, first_name, last_name, role)
VALUES
  ('student1@test.com', '$2a$10$...', 'Alice', 'Student', 'STUDENT'),
  ('student2@test.com', '$2a$10$...', 'Bob', 'Student', 'STUDENT'),
  ('student3@test.com', '$2a$10$...', 'Charlie', 'Student', 'STUDENT')
RETURNING id, email;

-- 3. Create test study hall (use owner_id from step 1)
INSERT INTO study_halls (owner_id, hall_name, seat_count, address)
VALUES (1, 'Test Study Hall', 30, '789 Payment Test Street, Test City')
RETURNING id, hall_name, seat_count;

-- 4. Create test subscriptions in various states
INSERT INTO subscriptions (user_id, hall_id, start_date, end_date, status, plan_type, amount)
VALUES
  -- Active subscription
  (2, 1, '2025-10-01', '2025-11-01', 'ACTIVE', 'MONTHLY', 1500.00),
  -- Expiring soon (for renewal testing)
  (3, 1, '2025-09-12', '2025-10-12', 'ACTIVE', 'MONTHLY', 1500.00),
  -- Expired subscription
  (4, 1, '2025-08-01', '2025-09-01', 'EXPIRED', 'MONTHLY', 1500.00)
RETURNING id, user_id, status, start_date, end_date;

-- 5. Create test payments with various statuses
INSERT INTO payments (user_id, subscription_id, razorpay_order_id, razorpay_payment_id, amount, status, created_at)
VALUES
  -- Completed payment
  (2, 1, 'order_test123', 'pay_test456', 1500.00, 'COMPLETED', '2025-10-01 10:00:00'),
  -- Pending payment
  (3, 2, 'order_test789', NULL, 1500.00, 'PENDING', '2025-10-11 09:00:00'),
  -- Failed payment
  (4, 3, 'order_testfail', NULL, 1500.00, 'FAILED', '2025-09-01 10:00:00')
RETURNING id, razorpay_order_id, status, amount;

-- 6. Create test invoices linked to subscriptions
INSERT INTO invoices (subscription_id, invoice_number, amount, issue_date, due_date, status)
VALUES
  (1, 'INV-2025-001', 1500.00, '2025-10-01', '2025-10-05', 'PAID'),
  (2, 'INV-2025-002', 1500.00, '2025-09-12', '2025-09-16', 'PAID'),
  (3, 'INV-2025-003', 1500.00, '2025-08-01', '2025-08-05', 'OVERDUE')
RETURNING id, invoice_number, status, amount;
```

### Validation Queries

**Verify Payment Record Creation:**
```sql
-- Check payment created with PENDING status
SELECT
  p.id,
  p.razorpay_order_id,
  p.amount,
  p.status,
  p.created_at,
  s.user_id,
  s.hall_id
FROM payments p
JOIN subscriptions s ON p.subscription_id = s.id
WHERE p.razorpay_order_id = ?;
```

**Verify Payment Completion:**
```sql
-- Confirm payment status updated to COMPLETED
SELECT
  p.id,
  p.razorpay_order_id,
  p.razorpay_payment_id,
  p.razorpay_signature,
  p.status,
  p.completed_at,
  s.status as subscription_status
FROM payments p
JOIN subscriptions s ON p.subscription_id = s.id
WHERE p.razorpay_payment_id = ?;
```

**Verify Subscription Status:**
```sql
-- Check subscription is ACTIVE after payment
SELECT
  s.id,
  s.user_id,
  s.hall_id,
  s.start_date,
  s.end_date,
  s.status,
  s.plan_type,
  s.amount
FROM subscriptions s
WHERE s.id = ?;
```

**Verify Subscription Renewal:**
```sql
-- Confirm end_date extended after renewal
SELECT
  s.id,
  s.start_date,
  s.end_date,
  s.status,
  s.plan_type,
  EXTRACT(DAY FROM (s.end_date - s.start_date)) as duration_days
FROM subscriptions s
WHERE s.id = ?;
```

**Verify Invoice Generation:**
```sql
-- Check invoice created for subscription
SELECT
  i.id,
  i.subscription_id,
  i.invoice_number,
  i.amount,
  i.issue_date,
  i.due_date,
  i.status
FROM invoices i
WHERE i.subscription_id = ?
ORDER BY i.issue_date DESC;
```

**Verify Expired Subscriptions:**
```sql
-- Find subscriptions that should be expired
SELECT
  s.id,
  s.user_id,
  s.end_date,
  s.status,
  CASE
    WHEN s.end_date < CURRENT_DATE AND s.status = 'ACTIVE' THEN 'NEEDS_EXPIRATION'
    WHEN s.end_date < CURRENT_DATE AND s.status = 'EXPIRED' THEN 'CORRECTLY_EXPIRED'
    ELSE 'STILL_ACTIVE'
  END as expiration_status
FROM subscriptions s
WHERE s.end_date < CURRENT_DATE;
```

**Verify Webhook Signature:**
```sql
-- Get payment details for webhook verification
SELECT
  p.id,
  p.razorpay_order_id,
  p.razorpay_payment_id,
  p.amount,
  p.status
FROM payments p
WHERE p.razorpay_order_id = ?;
```

### API Testing Template

For each endpoint, document:
1. **Setup**: SQL queries to prepare test data
2. **Request**: HTTP method, URL, headers, body
3. **Response**: Status code, response body
4. **Verification**: SQL queries to verify database state
5. **Razorpay Simulation**: Mock Razorpay responses if needed

## Test Results

### Test Data Setup Results
```
_To be filled by QA Agent during testing_

Example format:
=================================================
SQL Query:
INSERT INTO subscriptions (user_id, hall_id, start_date, end_date, status, plan_type, amount)
VALUES (2, 1, '2025-10-01', '2025-11-01', 'ACTIVE', 'MONTHLY', 1500.00)
RETURNING id, user_id, status, start_date, end_date;

Result:
 id | user_id | status  | start_date | end_date
----+---------+---------+------------+-----------
  1 |       2 | ACTIVE  | 2025-10-01 | 2025-11-01
(1 row)
=================================================
```

### Authentication Test Results (Owner User)
```
_To be filled by QA Agent_

Request:
POST /api/auth/login
Content-Type: application/json

{
  "email": "owner@test.com",
  "password": "test123"
}

Response (200 OK):
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "email": "owner@test.com",
  "role": "OWNER"
}

Verification SQL:
SELECT email, role FROM users WHERE email = 'owner@test.com';

Result: ✅ User found, credentials match, OWNER role confirmed
```

### POST /owner/payments/order Test Results
```
_To be filled by QA Agent_

Request:
POST /owner/payments/order
Authorization: Bearer <owner_token>
Content-Type: application/json

{
  "userId": 2,
  "subscriptionId": 1,
  "amount": 1500.00,
  "currency": "INR"
}

Response (200 OK):
{
  "orderId": "order_MN3kQ5r7Z8X9YA",
  "amount": 1500.00,
  "currency": "INR",
  "status": "created"
}

Verification SQL:
SELECT id, razorpay_order_id, amount, status
FROM payments
WHERE razorpay_order_id = 'order_MN3kQ5r7Z8X9YA';

Result: ✅ Payment record created with PENDING status, order_id stored
```

### POST /owner/payments/verify Test Results
```
_To be filled by QA Agent_

Request:
POST /owner/payments/verify
Authorization: Bearer <owner_token>
Content-Type: application/json

{
  "razorpayOrderId": "order_MN3kQ5r7Z8X9YA",
  "razorpayPaymentId": "pay_ABC123DEF456",
  "razorpaySignature": "generated_hmac_sha256_signature"
}

Response (200 OK):
{
  "status": "verified",
  "message": "Payment verified successfully",
  "subscriptionStatus": "ACTIVE"
}

Verification SQL:
SELECT p.status as payment_status, p.razorpay_payment_id,
       s.status as subscription_status
FROM payments p
JOIN subscriptions s ON p.subscription_id = s.id
WHERE p.razorpay_order_id = 'order_MN3kQ5r7Z8X9YA';

Result: ✅ Payment status COMPLETED, subscription status ACTIVE, signature validated

Test: Invalid Signature
Request: POST /owner/payments/verify (with invalid signature)
Response: 400 Bad Request - "Invalid payment signature"
Result: ✅ Signature validation working correctly
```

### Webhook Signature Validation Test Results
```
_To be filled by QA Agent_

Request:
POST /webhooks/razorpay
Content-Type: application/json
X-Razorpay-Signature: <valid_hmac_sha256_signature>

{
  "event": "payment.captured",
  "payload": {
    "payment": {
      "entity": {
        "id": "pay_ABC123DEF456",
        "order_id": "order_MN3kQ5r7Z8X9YA",
        "amount": 150000,
        "status": "captured"
      }
    }
  }
}

Response (200 OK):
{
  "status": "ok"
}

Verification SQL:
SELECT status, razorpay_payment_id, completed_at
FROM payments
WHERE razorpay_order_id = 'order_MN3kQ5r7Z8X9YA';

Result: ✅ Webhook processed, payment status updated via webhook

Test: Invalid Webhook Signature
Request: POST /webhooks/razorpay (with invalid signature)
Response: 401 Unauthorized
Result: ✅ Invalid signatures rejected
```

### GET /owner/subscriptions Test Results
```
_To be filled by QA Agent_
```

### POST /owner/subscriptions Test Results
```
_To be filled by QA Agent_

Request:
POST /owner/subscriptions
Authorization: Bearer <owner_token>
Content-Type: application/json

{
  "userId": 2,
  "hallId": 1,
  "planType": "MONTHLY",
  "amount": 1500.00,
  "startDate": "2025-10-11"
}

Response (201 Created):
{
  "subscriptionId": 10,
  "userId": 2,
  "status": "ACTIVE",
  "startDate": "2025-10-11",
  "endDate": "2025-11-11",
  "invoiceNumber": "INV-2025-010"
}

Verification SQL:
SELECT s.id, s.status, s.start_date, s.end_date,
       i.invoice_number, i.amount, i.status as invoice_status
FROM subscriptions s
LEFT JOIN invoices i ON s.id = i.subscription_id
WHERE s.id = 10;

Result: ✅ Subscription created with ACTIVE status, dates calculated correctly, invoice generated
```

### PUT /owner/subscriptions/{subscriptionId} Test Results
```
_To be filled by QA Agent_
```

### DELETE /owner/subscriptions/{subscriptionId} Test Results
```
_To be filled by QA Agent_
```

### GET /owner/subscriptions/{subscriptionId}/invoices Test Results
```
_To be filled by QA Agent_
```

### GET /student/subscriptions Test Results
```
_To be filled by QA Agent_
```

### Subscription Renewal Test Results
```
_To be filled by QA Agent_

Setup SQL:
UPDATE subscriptions
SET end_date = CURRENT_DATE + INTERVAL '1 day'
WHERE id = 2;

Request:
POST /owner/subscriptions/2/renew
Authorization: Bearer <owner_token>

Response (200 OK):
{
  "subscriptionId": 2,
  "newEndDate": "2025-11-12",
  "invoiceNumber": "INV-2025-011",
  "amount": 1500.00
}

Verification SQL:
SELECT s.end_date, s.status,
       i.invoice_number, i.amount, i.issue_date
FROM subscriptions s
LEFT JOIN invoices i ON s.id = i.subscription_id
WHERE s.id = 2
ORDER BY i.issue_date DESC LIMIT 1;

Result: ✅ End date extended by 30 days, new invoice generated, subscription remains ACTIVE
```

### Scheduled Subscription Expiration Test Results
```
_To be filled by QA Agent_

Setup SQL:
UPDATE subscriptions
SET end_date = CURRENT_DATE - INTERVAL '1 day'
WHERE id = 3;

Wait: [Trigger scheduled task or wait for next run]

Verification SQL:
SELECT id, user_id, end_date, status
FROM subscriptions
WHERE end_date < CURRENT_DATE;

Result: ✅ Expired subscriptions status changed to EXPIRED by scheduled task
```

### Authorization Failure Tests
```
_To be filled by QA Agent_

Test: Owner accessing another owner's subscriptions
Request: GET /owner/subscriptions?hallId=999
Response: 403 Forbidden
Result: ✅ Authorization prevents access to other owners' data

Test: Student creating subscriptions
Request: POST /owner/subscriptions (with student token)
Response: 403 Forbidden
Result: ✅ Role-based authorization working

Test: No JWT token
Request: GET /owner/subscriptions (no Authorization header)
Response: 401 Unauthorized
Result: ✅ Authentication required
```

### Edge Case Tests
```
_To be filled by QA Agent_

Test: Payment verification with expired order
Setup: Create payment order older than 1 hour
Response: 400 Bad Request - "Order expired"
Result: ✅ Expired orders rejected

Test: Subscription creation with invalid plan duration
Request: POST /owner/subscriptions (with planType='INVALID')
Response: 400 Bad Request - "Invalid plan type"
Result: ✅ Validation working

Test: Renewal of cancelled subscription
Request: POST /owner/subscriptions/{cancelled_id}/renew
Response: 400 Bad Request - "Cannot renew cancelled subscription"
Result: ✅ Business logic prevents invalid renewals

Test: Invoice generation for zero-amount subscription
Request: POST /owner/subscriptions (with amount=0)
Response: 400 Bad Request or invoice with 0 amount
Result: ✅ Handles edge case appropriately
```

## Testing Checklist

- [ ] All test data created successfully in database
- [ ] All SQL queries documented with results
- [ ] All API requests documented with responses
- [ ] All database verifications performed
- [ ] Razorpay order creation tested
- [ ] Payment signature validation tested (both API and webhook)
- [ ] Subscription lifecycle tested (creation, renewal, expiration)
- [ ] Invoice generation verified
- [ ] Scheduled expiration task tested
- [ ] All edge cases tested
- [ ] All authorization scenarios tested
- [ ] All results captured in this story file
- [ ] Database cleaned up after testing (optional)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-11 | 1.0 | Epic 3 API validation story created | Bob (Scrum Master) |

## QA Agent Record

### Test Execution Date
_To be filled by QA Agent_

### Test Environment
- Database: studymate_user (PostgreSQL)
- Backend URL: http://localhost:8080
- PostgreSQL MCP: Connected ✅
- Razorpay: Test Mode ✅
- Webhook Secret: [Test webhook secret]

### Overall Test Results
- Total Endpoints Tested: __/9
- Passed: __
- Failed: __
- Blocked: __

### Issues Found
_To be filled by QA Agent_

### Evidence Files
_Screenshots, exported SQL results, API response logs, Razorpay webhook payloads_
