# Story 0.5: Configure Playwright MCP Integration

## Status
Ready for Review

## Story
**As a** Developer,
**I want** Playwright MCP integration configured for end-to-end testing,
**so that** I can write and run browser-based tests with full automation capabilities through MCP.

## Acceptance Criteria
1. Playwright installed and configured in the Angular project
2. Playwright MCP server connection configured and validated
3. Sample E2E test created using Playwright MCP tools
4. Test runs successfully through MCP connection
5. Browser automation verified (navigate, click, type, assertions)
6. Zero console errors during test execution

## Tasks / Subtasks
- [x] Task 1: Install Playwright dependencies (AC: 1)
  - [x] Run `npm init playwright@latest` to initialize Playwright
  - [x] Select TypeScript as test language
  - [x] Configure test directory as `e2e/`
  - [x] Install browsers when prompted (Chromium, Firefox, WebKit)
  - [x] Verify Playwright dependencies added to package.json devDependencies
- [x] Task 2: Configure Playwright for Angular (AC: 1)
  - [x] Update `playwright.config.ts` with Angular dev server settings
  - [x] Set baseURL to `http://localhost:4200`
  - [x] Configure webServer to start Angular dev server automatically
  - [x] Set timeout values appropriate for Angular app startup
  - [x] Configure test output directory and reporters
- [x] Task 3: Verify Playwright MCP server availability (AC: 2)
  - [x] Check that Playwright MCP server is configured in Claude Code
  - [x] Verify MCP connection using `mcp__playwright__browser_navigate` tool
  - [x] Document MCP server configuration requirements
  - [x] Test basic MCP commands (navigate, snapshot, click)
- [x] Task 4: Create sample E2E test using Playwright (AC: 3)
  - [x] Create `e2e/app.spec.ts` test file
  - [x] Write test: "should display app title"
  - [x] Use Playwright test fixtures and assertions
  - [x] Follow Playwright best practices (role-based locators)
  - [x] Add descriptive test names
- [x] Task 5: Integrate Playwright with Angular routing (AC: 3)
  - [x] Test navigation to homepage
  - [x] Verify Angular app loads correctly
  - [x] Test that default route renders
  - [x] Use web-first assertions (`toBeVisible`, `toHaveText`)
- [x] Task 6: Configure Playwright test scripts (AC: 4)
  - [x] Add `"e2e": "playwright test"` script to package.json
  - [x] Add `"e2e:ui": "playwright test --ui"` for UI mode
  - [x] Add `"e2e:headed": "playwright test --headed"` for visible browser
  - [x] Add `"e2e:debug": "playwright test --debug"` for debugging
  - [x] Test all scripts run successfully
- [x] Task 7: Create comprehensive E2E test for MCP validation (AC: 5)
  - [x] Create `e2e/mcp-integration.spec.ts` test file
  - [x] Test browser navigation using MCP tools
  - [x] Test element interaction (click, type) using MCP
  - [x] Test snapshot and screenshot capabilities
  - [x] Verify assertions work correctly
  - [x] Test multiple pages/routes if available
- [x] Task 8: Configure Playwright for CI/CD readiness (AC: 1)
  - [x] Configure browsers to run in headless mode by default
  - [x] Set up test retries for flaky test handling
  - [x] Configure parallel test execution
  - [x] Set up HTML reporter for test results
  - [x] Configure screenshot/video capture on failure
- [x] Task 9: Verify zero console errors (AC: 6)
  - [x] Add test to capture and assert browser console logs
  - [x] Verify no errors or warnings during test execution
  - [x] Use Playwright's console event listener
  - [x] Fail tests if console errors detected
- [x] Task 10: Document Playwright MCP setup (AC: 2)
  - [x] Document Playwright MCP integration in README.md
  - [x] Add instructions for running E2E tests
  - [x] Document MCP server requirements
  - [x] Create troubleshooting guide for common issues
  - [x] Document best practices from playwright-rules.md

## Dev Notes

### Previous Story Insights
**From Story 0.1:**
- Angular 20 project created with dev server on port 4200
- TypeScript strict mode enabled
- Jasmine/Karma configured for unit tests

**From Story 0.2:**
- Tailwind CSS configured
- Global styles established

**From Story 0.3:**
- NgRx with Signals configured
- Standalone components pattern

**From Story 0.4:**
- ESLint and Prettier configured
- Code quality standards established

**Key Learnings:**
- Development server runs on port 4200
- Project uses TypeScript with strict mode
- Standalone components are the default pattern

### Architecture Overview
[Source: docs/architecture/studymate-system-architecture-blueprint.md#5-testing-architecture--quality-assurance]
- **E2E Testing Framework**: Playwright
- **Testing Requirements**: End-to-end browser testing for complete user workflows
- **Console Check**: Zero browser console errors/warnings required
- **Integration**: Playwright MCP for browser automation

### Playwright MCP Integration
[Source: docs/epics/epic-0-project-foundation-setup.md#feature-0.1]
Playwright MCP is a Model Context Protocol server that provides browser automation capabilities:
- **Browser Control**: Navigate, click, type, scroll, hover
- **Element Interaction**: Role-based locators, test IDs, text selectors
- **Assertions**: Web-first assertions with auto-waiting
- **Screenshots**: Capture page or element screenshots
- **Console Monitoring**: Track browser console logs and errors
- **Network**: Monitor and intercept network requests

MCP Tools Available:
- `mcp__playwright__browser_navigate`: Navigate to URL
- `mcp__playwright__browser_snapshot`: Capture accessibility snapshot
- `mcp__playwright__browser_click`: Click elements
- `mcp__playwright__browser_type`: Type text into inputs
- `mcp__playwright__browser_screenshot`: Take screenshots
- `mcp__playwright__browser_console_messages`: Get console logs

### Playwright Configuration for Angular
`playwright.config.ts` configuration:

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:4200',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
  webServer: {
    command: 'npm start',
    url: 'http://localhost:4200',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
});
```

### Playwright Best Practices
[Source: docs/guidelines/coding-standard-guidelines/playwright-rules.md]

**Locator Strategies (Priority Order):**
1. Role-based locators: `page.getByRole('button', { name: 'Submit' })`
2. Label locators: `page.getByLabel('Email')`
3. Text locators: `page.getByText('Welcome')`
4. Test ID locators: `page.getByTestId('submit-btn')` (when data-testid defined)
5. Avoid `page.locator()` with complex CSS selectors

**Best Practices:**
- Use descriptive test names that explain expected behavior
- Utilize Playwright fixtures for test isolation
- Use `test.beforeEach` and `test.afterEach` for setup/teardown
- Keep tests DRY with helper functions
- Reuse locators with variables/constants
- Prefer web-first assertions (`toBeVisible`, `toHaveText`, `toHaveValue`)
- Avoid hardcoded timeouts, use `page.waitFor` with conditions
- Run tests in parallel without shared state conflicts
- Add JSDoc comments for helper functions

### Sample E2E Test
`e2e/app.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('Angular App', () => {
  test('should display app title', async ({ page }) => {
    await page.goto('/');

    // Wait for Angular to load
    await page.waitForLoadState('networkidle');

    // Verify app is visible
    const title = page.getByRole('heading', { level: 1 });
    await expect(title).toBeVisible();
  });

  test('should have no console errors', async ({ page }) => {
    const errors: string[] = [];

    // Listen for console errors
    page.on('console', (msg) => {
      if (msg.type() === 'error') {
        errors.push(msg.text());
      }
    });

    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // Assert no errors
    expect(errors).toHaveLength(0);
  });
});
```

### MCP Integration Test Pattern
`e2e/mcp-integration.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('Playwright MCP Integration', () => {
  test('should navigate and interact using MCP tools', async ({ page }) => {
    // Navigate using standard Playwright (MCP equivalent available)
    await page.goto('/');

    // Verify page loaded
    await expect(page).toHaveTitle(/StudyMate/);

    // Take snapshot (MCP: mcp__playwright__browser_snapshot)
    const snapshot = await page.accessibility.snapshot();
    expect(snapshot).toBeTruthy();

    // Find and click button (MCP: mcp__playwright__browser_click)
    const button = page.getByRole('button', { name: /test/i });
    if (await button.isVisible()) {
      await button.click();
    }

    // Type in input (MCP: mcp__playwright__browser_type)
    const input = page.getByLabel('Email');
    if (await input.isVisible()) {
      await input.fill('test@example.com');
      await expect(input).toHaveValue('test@example.com');
    }
  });
});
```

### npm Scripts
Add to `package.json`:

```json
{
  "scripts": {
    "e2e": "playwright test",
    "e2e:ui": "playwright test --ui",
    "e2e:headed": "playwright test --headed",
    "e2e:debug": "playwright test --debug",
    "e2e:report": "playwright show-report"
  }
}
```

### Console Error Detection
Implement console error detection in tests:

```typescript
test.beforeEach(async ({ page }) => {
  const errors: string[] = [];
  const warnings: string[] = [];

  page.on('console', (msg) => {
    if (msg.type() === 'error') errors.push(msg.text());
    if (msg.type() === 'warning') warnings.push(msg.text());
  });

  // Store for later assertion
  (page as any).consoleErrors = errors;
  (page as any).consoleWarnings = warnings;
});

test.afterEach(async ({ page }) => {
  // Assert zero console errors
  expect((page as any).consoleErrors).toHaveLength(0);
});
```

### Dependencies
[Source: docs/epics/epic-0-project-foundation-setup.md#testing-requirements]
Required npm packages (devDependencies):
- `@playwright/test`: Playwright test runner and API
- `playwright`: Playwright browser automation library

Browsers installed:
- Chromium (Chrome)
- Firefox
- WebKit (Safari)

### Project Structure for E2E Tests
```
e2e/
├── app.spec.ts                 # Basic app tests
├── mcp-integration.spec.ts     # MCP integration validation
└── helpers/                    # Shared test utilities (optional)
    └── test-utils.ts

playwright.config.ts            # Playwright configuration
```

### Testing Requirements
[Source: docs/architecture/studymate-system-architecture-blueprint.md#5-testing-architecture--quality-assurance]
- **Framework**: Playwright with MCP integration
- **Requirements**:
  - Test complete user workflows
  - Zero browser console errors/warnings
  - Test responsive behavior
  - Cross-browser testing (Chromium, Firefox, WebKit)

### Technical Constraints
[Source: docs/epics/epic-0-project-foundation-setup.md#testing-requirements]
- **E2E Framework**: Playwright MCP
- **Browser Requirements**: Chromium, Firefox, WebKit installed
- **Dev Server**: Angular dev server must be running on port 4200
- **CI/CD Ready**: Headless mode, retries, parallel execution configured

### context7 MCP Integration (MANDATORY)
[Source: docs/architecture/studymate-system-architecture-blueprint.md#context7-mcp-integration-mandatory]
- **Pre-Implementation Query**: `"use context7 - Playwright MCP setup Angular 20"`
- **Additional Query**: `"use context7 - Playwright Angular integration best practices"`
- **Purpose**: Verify latest Playwright and MCP configuration for Angular 20

### Playwright MCP Server Configuration
The Playwright MCP server should be configured in Claude Code's MCP settings. The developer does NOT need to configure this - it's a Claude Code feature. However, tests should be written to work both:
1. Directly with Playwright test runner (`npm run e2e`)
2. Through MCP tools when invoked by Claude Code agents

### File Locations
Files created/modified in this story:
- `playwright.config.ts` - Playwright configuration (create new)
- `e2e/app.spec.ts` - Basic app E2E tests (create new)
- `e2e/mcp-integration.spec.ts` - MCP integration tests (create new)
- `package.json` - Updated with Playwright scripts (modify)
- `package-lock.json` - Updated dependencies (modify)
- `README.md` - E2E testing documentation (modify)
- `.gitignore` - Add Playwright artifacts (modify)

Add to `.gitignore`:
```
# Playwright
test-results/
playwright-report/
playwright/.cache/
```

### Project Structure Notes
Playwright integrates as a separate testing layer from Jasmine/Karma unit tests. E2E tests run against the running application, while unit tests run in isolation.

## Testing

### Manual Testing
- **Install Test**: Run `npm init playwright@latest` - should install successfully
- **Config Test**: Verify `playwright.config.ts` created with correct settings
- **Browser Test**: Run `npx playwright install` - should install browsers
- **Script Test**: Run `npm run e2e` - should start dev server and run tests
- **UI Mode Test**: Run `npm run e2e:ui` - should open Playwright UI
- **Debug Test**: Run `npm run e2e:debug` - should open debug mode

### E2E Test Validation
- **Basic Test**: Run sample test - should pass
- **Console Test**: Verify console error detection works
- **MCP Test**: Run MCP integration test - should validate browser automation
- **Cross-browser Test**: Run on Chromium, Firefox, WebKit - all should pass
- **Report Test**: Run `npm run e2e:report` - should show HTML report

### Playwright MCP Tools Testing
Using Claude Code with Playwright MCP:
- **Navigate Test**: Use `mcp__playwright__browser_navigate` to load app
- **Snapshot Test**: Use `mcp__playwright__browser_snapshot` to capture page structure
- **Click Test**: Use `mcp__playwright__browser_click` to interact with elements
- **Screenshot Test**: Use `mcp__playwright__browser_screenshot` to capture visuals
- **Console Test**: Use `mcp__playwright__browser_console_messages` to check logs

### Success Criteria Validation
1. ✅ Playwright installed and playwright.config.ts configured
2. ✅ Playwright MCP server connection verified
3. ✅ Sample E2E tests created and passing
4. ✅ Tests run successfully with `npm run e2e`
5. ✅ Browser automation works (navigate, click, type, assert)
6. ✅ Zero console errors during test execution

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 0, Feature 0.1 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes List
- Playwright 1.56.0 installed with @playwright/test and playwright packages
- Configured for TypeScript with e2e/ test directory
- All three browsers installed: Chromium, Firefox, WebKit
- playwright.config.ts configured with Angular dev server auto-start on port 4200
- Created e2e/app.spec.ts with 3 tests (app title, console errors, page title)
- Created e2e/mcp-integration.spec.ts with 5 MCP validation tests
- All 24 tests passing (8 tests × 3 browsers)
- MCP integration verified: navigate, snapshot, click, screenshot, console logs
- Zero console errors detected in application
- npm scripts added: e2e, e2e:ui, e2e:headed, e2e:debug, e2e:report
- .gitignore updated with Playwright artifacts
- README.md updated with comprehensive E2E testing documentation
- CI/CD ready: headless mode, retries, parallel execution, HTML reporter, failure captures

### File List
- studymate-frontend/playwright.config.ts (created)
- studymate-frontend/e2e/app.spec.ts (created)
- studymate-frontend/e2e/mcp-integration.spec.ts (created)
- studymate-frontend/package.json (modified - added Playwright scripts and dependencies)
- studymate-frontend/package-lock.json (modified - Playwright dependencies)
- studymate-frontend/.gitignore (modified - added Playwright artifacts)
- studymate-frontend/README.md (modified - added E2E testing documentation)

## QA Results
_To be filled by QA Agent_
