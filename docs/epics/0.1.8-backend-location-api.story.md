# Story 0.1.8-backend: Location Management API (Backend)

## Status
Ready for development

## Story
**As a** backend system,
**I want** to provide APIs for updating hall location and activating halls,
**so that** owners can complete onboarding and make halls discoverable to students.

## Acceptance Criteria

### AC1: PUT /owner/halls/{hallId}/location updates location
**Given** authenticated owner sends PUT to `/owner/halls/{hallId}/location`
**When** request includes latitude, longitude, region
**Then** the system:
- Validates hallId exists and belongs to owner
- Updates latitude, longitude, region columns
- Changes hall status from DRAFT to ACTIVE
- Sets updated_at timestamp
- Returns 200 OK with updated hall details

### AC2: Hall status changes to ACTIVE after location setup
**Given** owner completes location configuration
**When** location is saved
**Then** the system:
- Updates status column to 'ACTIVE'
- Makes hall discoverable in student search
- Enables all hall features

### AC3: Location validation enforced
**Given** owner sends invalid location data
**When** latitude/longitude out of range or region invalid
**Then** the system returns 400 Bad Request with validation errors

### AC4: Owner authorization enforced
**Given** request to update location
**When** hallId does not belong to authenticated owner
**Then** the system returns 403 Forbidden

## Tasks / Subtasks

### Task 1: Create LocationUpdateRequest DTO (AC: 1, 3)
- [ ] Create `LocationUpdateRequest.java`:
  - latitude (BigDecimal, @NotNull, @Min(-90), @Max(90))
  - longitude (BigDecimal, @NotNull, @Min(-180), @Max(180))
  - region (String, @NotBlank, @Pattern for enum values)

### Task 2: Update HallService (AC: 1, 2, 4)
- [ ] Implement `updateLocation(UUID hallId, UUID ownerId, LocationUpdateRequest request): HallResponse`
- [ ] Verify hall exists and belongs to owner
- [ ] Update latitude, longitude, region fields
- [ ] Update status to 'ACTIVE'
- [ ] Update updated_at timestamp
- [ ] Save to database
- [ ] Return HallResponse

### Task 3: Update HallController (AC: 1)
- [ ] Add PUT endpoint: `/owner/halls/{hallId}/location`
- [ ] `@PreAuthorize("hasRole('OWNER')")`
- [ ] Extract ownerId from JWT
- [ ] Call `hallService.updateLocation()`
- [ ] Return 200 OK

### Task 4: Testing (AC: All)
- [ ] Unit tests: service, controller
- [ ] Integration tests: end-to-end location update and activation
- [ ] PostgreSQL MCP: verify status change to ACTIVE

## Dev Notes

### Database Update
No migration needed - `latitude`, `longitude`, `region`, `status` columns already exist in study_halls table.

### Validation
- Latitude: -90 to 90 (decimal degrees)
- Longitude: -180 to 180 (decimal degrees)
- Region: enum (NORTH_ZONE, SOUTH_ZONE, EAST_ZONE, WEST_ZONE, CENTRAL)
- Status: automatically set to 'ACTIVE' after location saved

### File Locations
- DTO: `studymate-backend/src/main/java/com/studymate/dto/LocationUpdateRequest.java`
- Service: Update `HallService.java` (add updateLocation method)
- Controller: Update `HallController.java` (add PUT endpoint)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Story created from Epic 0.1, Feature 0.1.8 | Sarah (PO) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
