# Story 2.18.1: Gender-Based Seat Selection Validation (Frontend)

## Story Metadata

| Field | Value |
|-------|-------|
| **Story ID** | 2.18.1 |
| **Story Name** | Gender-Based Seat Selection Validation (Frontend) |
| **Epic** | Epic 2: Student Booking & Seat Management |
| **Feature** | Feature 2.18: Booking Validation & Error Handling (Enhancement) |
| **Story Type** | Frontend Development |
| **Priority** | High (Phase 4 of Ladies-Only Implementation) |
| **Status** | Draft |
| **Estimated Story Points** | 3 SP |
| **Sprint** | TBD (Phase 4 of Ladies-Only Implementation) |
| **Assigned To** | Unassigned |
| **Created Date** | 2025-10-14 |
| **Updated Date** | 2025-10-14 |
| **Related Change Proposal** | Sprint Change Proposal A: Ladies-Only Seats (SCP-2025-10-14-001) |

---

## User Story

**As a** Student,
**I want** to be prevented from selecting ladies-only seats if I am not female
**so that** I receive clear feedback before attempting to book an ineligible seat.

---

## Story Description

This story implements frontend validation to prevent non-female students from selecting ladies-only seats during the booking process. When a male or non-female student attempts to click a ladies-only seat, the system displays a modal error message explaining the restriction. The validation occurs before the booking API call, providing immediate feedback and preventing unnecessary API errors.

**Context**:
- Part of Sprint Change Proposal A: Ladies-Only Seats Configuration
- Depends on Stories 0.1.5-backend, 0.1.6, 1.4.1, and 2.16.1 being complete
- Provides client-side validation before backend validation (Story 2.1.1-backend)
- Improves UX by preventing invalid booking attempts

**User Gender Source**:
- User's gender retrieved from JWT token claims (`gender` field)
- JWT token decoded on frontend via AuthService
- Gender value: MALE | FEMALE | OTHER | PREFER_NOT_TO_SAY | null/undefined

**Validation Logic**:
- **FEMALE users**: Can book any seat (including ladies-only)
- **MALE users**: Cannot book ladies-only seats (show error modal)
- **OTHER users**: Cannot book ladies-only seats (show error modal)
- **PREFER_NOT_TO_SAY users**: Cannot book ladies-only seats (show error modal)
- **No gender set (null/undefined)**: Cannot book ladies-only seats (show error modal)

[Source: Sprint Change Proposal A, Section 8 - Phase 4]

---

## Acceptance Criteria

### AC1: Female Students Can Select Ladies-Only Seats
**Given** a student with gender "FEMALE" is viewing seat selection
**When** the student clicks on a ladies-only seat
**Then** the system:
- Allows seat selection
- Highlights the selected seat
- Does NOT show any error modal
- Allows user to proceed to booking

**Testing**:
- [ ] Female students can click ladies-only seats
- [ ] Selected seat highlighted correctly
- [ ] No error modal displayed
- [ ] Proceed to booking button enabled

[Source: Sprint Change Proposal A, Section 6 - Frontend Validation]

---

### AC2: Male Students Cannot Select Ladies-Only Seats
**Given** a student with gender "MALE" is viewing seat selection
**When** the student clicks on a ladies-only seat
**Then** the system:
- Does NOT select the seat
- Displays error modal with title: "Ladies Only Seat"
- Displays message: "This seat is reserved for female users only. Please select a different seat."
- Modal has "Close" button
- Modal has pink accent color (#FF69B4)
- No API call made

**Testing**:
- [ ] Male students cannot select ladies-only seats
- [ ] Error modal displayed with correct message
- [ ] Seat not highlighted as selected
- [ ] Modal dismisses on "Close" button click
- [ ] No API call triggered

[Source: Sprint Change Proposal A, Section 6 - Frontend Validation]

---

### AC3: Users Without Gender or "PREFER_NOT_TO_SAY" Cannot Select Ladies-Only Seats
**Given** a student with gender set to null, undefined, "OTHER", or "PREFER_NOT_TO_SAY"
**When** the student clicks on a ladies-only seat
**Then** the system:
- Does NOT select the seat
- Displays error modal with title: "Ladies Only Seat"
- Displays message: "This seat is reserved for female users only. Please select a different seat or update your gender in your profile."
- Modal has "Close" button
- Modal has "Update Profile" link (navigates to /student/profile)
- No API call made

**Testing**:
- [ ] Users without gender cannot select ladies-only seats
- [ ] Users with "OTHER" cannot select ladies-only seats
- [ ] Users with "PREFER_NOT_TO_SAY" cannot select ladies-only seats
- [ ] Error modal displayed with profile update option
- [ ] "Update Profile" link navigates correctly
- [ ] No API call triggered

[Source: Sprint Change Proposal A, Section 6 - Frontend Validation]

---

### AC4: Validation Does Not Affect Regular Seats
**Given** a student of any gender is viewing seat selection
**When** the student clicks on a regular (non-ladies-only) available seat
**Then** the system:
- Allows seat selection regardless of user gender
- Highlights the selected seat
- No error modal displayed
- Allows user to proceed to booking

**Testing**:
- [ ] Male students can select regular seats
- [ ] Female students can select regular seats
- [ ] Users without gender can select regular seats
- [ ] No validation errors for regular seats

[Source: Sprint Change Proposal A, Section 6 - Frontend Validation]

---

### AC5: User Gender Retrieved from JWT Token
**Given** a student is logged in and viewing seat selection
**When** the component initializes
**Then** the system:
- Retrieves JWT token from AuthService
- Decodes token to extract `gender` claim
- Stores gender value in component state
- Handles missing/null gender gracefully
- Logs error if JWT decoding fails

**JWT Token Payload Example**:
```json
{
  "sub": "user-id",
  "email": "student@example.com",
  "role": "STUDENT",
  "gender": "FEMALE",
  "exp": 1234567890
}
```

**Testing**:
- [ ] Component retrieves gender from JWT
- [ ] Gender stored in component state
- [ ] Missing gender handled (defaults to null)
- [ ] Invalid JWT handled gracefully
- [ ] Error logged if JWT decode fails

[Source: Sprint Change Proposal A, Section 6 - Frontend Validation]

---

### AC6: Error Modal Follows Design System
**Given** the error modal is displayed for ladies-only seat restriction
**When** the modal is rendered
**Then** the system displays:
- Modal overlay (dark semi-transparent background)
- White modal card (max-width: 400px)
- Pink border-top (4px solid #FF69B4)
- Female symbol ♀ icon in modal header (color: #FF1493)
- Title: "Ladies Only Seat" (font-size: 20px, font-weight: 600)
- Body message (font-size: 14px, color: #6b7280)
- "Close" button (gray button)
- "Update Profile" link (if user has no gender set) - pink color (#FF69B4)
- Modal dismisses on overlay click

**Testing**:
- [ ] Modal design matches specifications
- [ ] Pink accent color applied
- [ ] Female symbol icon visible
- [ ] Buttons functional
- [ ] Modal dismisses on overlay click
- [ ] Modal dismisses on Close button click

[Source: Sprint Change Proposal A, Section 9 - Design System Compliance]

---

## Technical Implementation Details

### Frontend Implementation

**1. Auth Service Update (Extract Gender from JWT)**

File: `studymate-frontend/src/app/core/services/auth.service.ts`
```typescript
import { Injectable, inject, signal } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Router } from '@angular/router';
import { jwtDecode } from 'jwt-decode';

interface JwtPayload {
  sub: string;
  email: string;
  role: string;
  gender?: 'MALE' | 'FEMALE' | 'OTHER' | 'PREFER_NOT_TO_SAY';
  exp: number;
}

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private http = inject(HttpClient);
  private router = inject(Router);

  private readonly TOKEN_KEY = 'auth_token';

  isAuthenticated = signal(false);
  currentUser = signal<any>(null);

  constructor() {
    this.checkAuthStatus();
  }

  private checkAuthStatus(): void {
    const token = this.getToken();
    if (token && !this.isTokenExpired(token)) {
      this.isAuthenticated.set(true);
      this.currentUser.set(this.decodeToken(token));
    }
  }

  getToken(): string | null {
    return localStorage.getItem(this.TOKEN_KEY);
  }

  decodeToken(token: string): JwtPayload | null {
    try {
      return jwtDecode<JwtPayload>(token);
    } catch (error) {
      console.error('Failed to decode JWT token:', error);
      return null;
    }
  }

  /**
   * NEW: Get user gender from JWT token
   */
  getUserGender(): 'MALE' | 'FEMALE' | 'OTHER' | 'PREFER_NOT_TO_SAY' | null {
    const token = this.getToken();
    if (!token) {
      return null;
    }

    const decoded = this.decodeToken(token);
    return decoded?.gender || null;
  }

  private isTokenExpired(token: string): boolean {
    try {
      const decoded = jwtDecode<JwtPayload>(token);
      const currentTime = Date.now() / 1000;
      return decoded.exp < currentTime;
    } catch {
      return true;
    }
  }

  logout(): void {
    localStorage.removeItem(this.TOKEN_KEY);
    this.isAuthenticated.set(false);
    this.currentUser.set(null);
    this.router.navigate(['/login']);
  }
}
```

**2. Seat Selection Component Logic Update**

File: `studymate-frontend/src/app/features/student/seat-selection/seat-selection.component.ts`
```typescript
import { Component, OnInit, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { BookingService } from '@core/services/booking.service';
import { AuthService } from '@core/services/auth.service';
import { Seat } from '@core/models/seat.model';

@Component({
  selector: 'app-seat-selection',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './seat-selection.component.html',
  styleUrls: ['./seat-selection.component.scss']
})
export class SeatSelectionComponent implements OnInit {
  private bookingService = inject(BookingService);
  private authService = inject(AuthService);
  private router = inject(Router);

  seats: Seat[] = [];
  selectedSeat = signal<Seat | null>(null);
  userGender = signal<'MALE' | 'FEMALE' | 'OTHER' | 'PREFER_NOT_TO_SAY' | null>(null);

  // NEW: Modal state
  showLadiesOnlyErrorModal = signal(false);
  canUpdateProfile = signal(false); // True if user has no gender set

  ngOnInit(): void {
    this.loadSeats();
    this.loadUserGender();
  }

  loadSeats(): void {
    const hallId = this.getHallIdFromRoute();
    this.bookingService.getAvailableSeats(hallId).subscribe({
      next: (seats) => {
        this.seats = seats;
      },
      error: (error) => {
        console.error('Failed to load seats:', error);
      }
    });
  }

  /**
   * NEW: Load user gender from JWT token
   */
  loadUserGender(): void {
    const gender = this.authService.getUserGender();
    this.userGender.set(gender);
  }

  /**
   * NEW: Validate if user can select a ladies-only seat
   */
  canSelectLadiesOnlySeat(seat: Seat): boolean {
    if (!seat.isLadiesOnly) {
      return true; // Regular seats can be selected by anyone
    }

    const gender = this.userGender();
    return gender === 'FEMALE';
  }

  /**
   * Updated: Select seat with ladies-only validation
   */
  selectSeat(seat: Seat): void {
    if (seat.status !== 'available') {
      return; // Cannot select unavailable seats
    }

    // NEW: Ladies-only validation
    if (seat.isLadiesOnly && !this.canSelectLadiesOnlySeat(seat)) {
      this.showLadiesOnlyError();
      return;
    }

    // Select the seat
    this.selectedSeat.set(seat);
  }

  /**
   * NEW: Show ladies-only error modal
   */
  showLadiesOnlyError(): void {
    const gender = this.userGender();
    this.canUpdateProfile.set(!gender || gender === 'PREFER_NOT_TO_SAY');
    this.showLadiesOnlyErrorModal.set(true);
  }

  /**
   * NEW: Close error modal
   */
  closeLadiesOnlyErrorModal(): void {
    this.showLadiesOnlyErrorModal.set(false);
  }

  /**
   * NEW: Navigate to profile to update gender
   */
  goToProfile(): void {
    this.closeLadiesOnlyErrorModal();
    this.router.navigate(['/student/profile']);
  }

  getSeatClasses(seat: Seat): string[] {
    const classes = ['seat'];

    if (seat.status === 'booked') {
      classes.push('seat-booked');
    } else if (seat.status === 'locked') {
      classes.push('seat-locked');
    } else if (seat.status === 'maintenance') {
      classes.push('seat-maintenance');
    } else if (seat.status === 'available') {
      classes.push('seat-available');

      if (seat.isLadiesOnly) {
        classes.push('seat-ladies-only');
      }
    }

    if (seat.isLadiesOnly) {
      classes.push('has-ladies-only-indicator');
    }

    return classes;
  }

  private getHallIdFromRoute(): string {
    return '';
  }
}
```

**3. Seat Selection Component Template with Error Modal**

File: `studymate-frontend/src/app/features/student/seat-selection/seat-selection.component.html`
```html
<div class="seat-map-container">
  <h2 class="text-2xl font-bold mb-4">Select Your Seat</h2>

  <!-- Seat Legend -->
  <div class="seat-legend mb-6 flex gap-4">
    <div class="legend-item flex items-center gap-2">
      <div class="seat seat-available w-8 h-8"></div>
      <span class="text-sm">Available</span>
    </div>
    <div class="legend-item flex items-center gap-2">
      <div class="seat seat-booked w-8 h-8"></div>
      <span class="text-sm">Booked</span>
    </div>
    <div class="legend-item flex items-center gap-2">
      <div class="seat seat-locked w-8 h-8"></div>
      <span class="text-sm">Locked</span>
    </div>
    <div class="legend-item flex items-center gap-2">
      <div class="seat seat-available seat-ladies-only has-ladies-only-indicator w-8 h-8"></div>
      <span class="text-sm">Ladies Only</span>
    </div>
  </div>

  <!-- Seat Map Grid -->
  <div class="seat-map-grid relative">
    @for (seat of seats; track seat.id) {
      <div
        [attr.data-seat]="seat.seatNumber"
        [ngClass]="getSeatClasses(seat)"
        [style.left.px]="seat.xCoord"
        [style.top.px]="seat.yCoord"
        (click)="selectSeat(seat)"
        [attr.title]="seat.isLadiesOnly ? 'Ladies Only - ' + seat.seatNumber : seat.seatNumber"
      >
        <span class="seat-number">{{ seat.seatNumber }}</span>
      </div>
    }
  </div>

  <!-- Selected Seat Info -->
  @if (selectedSeat()) {
    <div class="selected-seat-info mt-6 p-4 bg-blue-50 rounded-lg">
      <p class="text-lg font-semibold">Selected: {{ selectedSeat()!.seatNumber }}</p>
      @if (selectedSeat()!.isLadiesOnly) {
        <p class="text-sm text-pink-600 mt-1">
          ♀ Ladies Only Seat
        </p>
      }
      <button class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
        Proceed to Booking
      </button>
    </div>
  }
</div>

<!-- NEW: Ladies-Only Error Modal -->
@if (showLadiesOnlyErrorModal()) {
  <div class="modal-overlay" (click)="closeLadiesOnlyErrorModal()">
    <div class="modal-card ladies-only-modal" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="flex items-center gap-2">
          <span class="female-symbol">♀</span>
          <h3 class="modal-title">Ladies Only Seat</h3>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <p class="modal-message">
          This seat is reserved for female users only. Please select a different seat
          @if (canUpdateProfile()) {
            or update your gender in your profile.
          }
        </p>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button
          class="btn-secondary"
          (click)="closeLadiesOnlyErrorModal()"
        >
          Close
        </button>

        @if (canUpdateProfile()) {
          <button
            class="btn-primary-pink"
            (click)="goToProfile()"
          >
            Update Profile
          </button>
        }
      </div>
    </div>
  </div>
}
```

**4. Modal Styling**

File: `studymate-frontend/src/app/features/student/seat-selection/seat-selection.component.scss`
```scss
// ... existing seat styles ...

// NEW: Ladies-Only Error Modal Styling
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.2s ease-out;
}

.modal-card {
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  max-width: 400px;
  width: 90%;
  animation: slideUp 0.3s ease-out;

  &.ladies-only-modal {
    border-top: 4px solid #FF69B4; // Dark pink
  }
}

.modal-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid #e5e7eb;

  .female-symbol {
    font-size: 24px;
    color: #FF1493; // Deep pink
    font-weight: bold;
  }

  .modal-title {
    font-size: 20px;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
  }
}

.modal-body {
  padding: 20px 24px;

  .modal-message {
    font-size: 14px;
    color: #6b7280;
    line-height: 1.6;
    margin: 0;
  }
}

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
  gap: 12px;

  button {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;

    &.btn-secondary {
      background-color: #f3f4f6;
      color: #374151;

      &:hover {
        background-color: #e5e7eb;
      }
    }

    &.btn-primary-pink {
      background-color: #FF69B4;
      color: white;

      &:hover {
        background-color: #FF1493;
      }
    }
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

[Source: Sprint Change Proposal A, Section 6 - Frontend Validation]

---

## Testing Requirements

### Frontend Unit Tests

**Auth Service Tests**:
```typescript
describe('AuthService', () => {
  let service: AuthService;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    service = TestBed.inject(AuthService);
  });

  it('should extract gender from JWT token', () => {
    const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLWlkIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwicm9sZSI6IlNUVURFTlQiLCJnZW5kZXIiOiJGRU1BTEUiLCJleHAiOjk5OTk5OTk5OTl9.xxx';
    spyOn(service, 'getToken').and.returnValue(mockToken);

    const gender = service.getUserGender();

    expect(gender).toBe('FEMALE');
  });

  it('should return null if gender not in token', () => {
    const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLWlkIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwicm9sZSI6IlNUVURFTlQiLCJleHAiOjk5OTk5OTk5OTl9.xxx';
    spyOn(service, 'getToken').and.returnValue(mockToken);

    const gender = service.getUserGender();

    expect(gender).toBeNull();
  });

  it('should return null if no token exists', () => {
    spyOn(service, 'getToken').and.returnValue(null);

    const gender = service.getUserGender();

    expect(gender).toBeNull();
  });
});
```

**Component Tests**:
```typescript
describe('SeatSelectionComponent - Ladies-Only Validation', () => {
  let component: SeatSelectionComponent;
  let fixture: ComponentFixture<SeatSelectionComponent>;
  let authService: AuthService;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [SeatSelectionComponent]
    }).compileComponents();

    fixture = TestBed.createComponent(SeatSelectionComponent);
    component = fixture.componentInstance;
    authService = TestBed.inject(AuthService);
  });

  it('should allow female users to select ladies-only seats', () => {
    spyOn(authService, 'getUserGender').and.returnValue('FEMALE');
    component.loadUserGender();

    const ladiesOnlySeat: Seat = {
      id: '1',
      hallId: 'hall-1',
      seatNumber: 'A1',
      xCoord: 100,
      yCoord: 150,
      status: 'available',
      isLadiesOnly: true,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    component.selectSeat(ladiesOnlySeat);

    expect(component.selectedSeat()).toEqual(ladiesOnlySeat);
    expect(component.showLadiesOnlyErrorModal()).toBe(false);
  });

  it('should prevent male users from selecting ladies-only seats', () => {
    spyOn(authService, 'getUserGender').and.returnValue('MALE');
    component.loadUserGender();

    const ladiesOnlySeat: Seat = {
      id: '1',
      hallId: 'hall-1',
      seatNumber: 'A1',
      xCoord: 100,
      yCoord: 150,
      status: 'available',
      isLadiesOnly: true,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    component.selectSeat(ladiesOnlySeat);

    expect(component.selectedSeat()).toBeNull();
    expect(component.showLadiesOnlyErrorModal()).toBe(true);
  });

  it('should prevent users without gender from selecting ladies-only seats', () => {
    spyOn(authService, 'getUserGender').and.returnValue(null);
    component.loadUserGender();

    const ladiesOnlySeat: Seat = {
      id: '1',
      hallId: 'hall-1',
      seatNumber: 'A1',
      xCoord: 100,
      yCoord: 150,
      status: 'available',
      isLadiesOnly: true,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    component.selectSeat(ladiesOnlySeat);

    expect(component.selectedSeat()).toBeNull();
    expect(component.showLadiesOnlyErrorModal()).toBe(true);
    expect(component.canUpdateProfile()).toBe(true); // Should show "Update Profile" button
  });

  it('should allow all users to select regular seats', () => {
    spyOn(authService, 'getUserGender').and.returnValue('MALE');
    component.loadUserGender();

    const regularSeat: Seat = {
      id: '2',
      hallId: 'hall-1',
      seatNumber: 'B1',
      xCoord: 200,
      yCoord: 150,
      status: 'available',
      isLadiesOnly: false,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    component.selectSeat(regularSeat);

    expect(component.selectedSeat()).toEqual(regularSeat);
    expect(component.showLadiesOnlyErrorModal()).toBe(false);
  });
});
```

### E2E Tests (Playwright)

```typescript
import { test, expect } from '@playwright/test';

test.describe('Gender-Based Seat Selection Validation', () => {
  test('female student can select ladies-only seat', async ({ page }) => {
    // Login as female student
    await page.goto('/login');
    await page.fill('input[name="email"]', 'female@example.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // Navigate to seat selection
    await page.goto('/student/seat-selection?hallId=test-hall-1');
    await page.waitForSelector('.seat-map-grid');

    // Click ladies-only seat
    await page.click('[data-seat="A1"]');

    // Verify seat selected (no error modal)
    await expect(page.locator('.selected-seat-info')).toContainText('Selected: A1');
    await expect(page.locator('.modal-overlay')).not.toBeVisible();
  });

  test('male student cannot select ladies-only seat', async ({ page }) => {
    // Login as male student
    await page.goto('/login');
    await page.fill('input[name="email"]', 'male@example.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // Navigate to seat selection
    await page.goto('/student/seat-selection?hallId=test-hall-1');
    await page.waitForSelector('.seat-map-grid');

    // Click ladies-only seat
    await page.click('[data-seat="A1"]');

    // Verify error modal displayed
    await expect(page.locator('.modal-overlay')).toBeVisible();
    await expect(page.locator('.modal-title')).toContainText('Ladies Only Seat');
    await expect(page.locator('.modal-message')).toContainText('reserved for female users only');

    // Verify seat NOT selected
    await expect(page.locator('.selected-seat-info')).not.toBeVisible();
  });

  test('student without gender sees profile update option', async ({ page }) => {
    // Login as student without gender
    await page.goto('/login');
    await page.fill('input[name="email"]', 'nogender@example.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // Navigate to seat selection
    await page.goto('/student/seat-selection?hallId=test-hall-1');
    await page.waitForSelector('.seat-map-grid');

    // Click ladies-only seat
    await page.click('[data-seat="A1"]');

    // Verify error modal with profile update button
    await expect(page.locator('.modal-overlay')).toBeVisible();
    await expect(page.locator('.btn-primary-pink')).toContainText('Update Profile');

    // Click "Update Profile" button
    await page.click('.btn-primary-pink');

    // Verify navigation to profile page
    await expect(page).toHaveURL(/\/student\/profile/);
  });

  test('modal dismisses on close button click', async ({ page }) => {
    // Login as male student
    await page.goto('/login');
    await page.fill('input[name="email"]', 'male@example.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // Navigate to seat selection
    await page.goto('/student/seat-selection?hallId=test-hall-1');
    await page.waitForSelector('.seat-map-grid');

    // Click ladies-only seat to trigger error modal
    await page.click('[data-seat="A1"]');
    await expect(page.locator('.modal-overlay')).toBeVisible();

    // Click "Close" button
    await page.click('.btn-secondary');

    // Verify modal dismissed
    await expect(page.locator('.modal-overlay')).not.toBeVisible();
  });

  test('all users can select regular seats', async ({ page }) => {
    // Login as male student
    await page.goto('/login');
    await page.fill('input[name="email"]', 'male@example.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // Navigate to seat selection
    await page.goto('/student/seat-selection?hallId=test-hall-1');
    await page.waitForSelector('.seat-map-grid');

    // Click regular seat
    await page.click('[data-seat="B1"]');

    // Verify seat selected (no error modal)
    await expect(page.locator('.selected-seat-info')).toContainText('Selected: B1');
    await expect(page.locator('.modal-overlay')).not.toBeVisible();
  });
});
```

[Source: Sprint Change Proposal A, Section 11 - Testing Requirements]

---

## Definition of Done

- [ ] Female students can select ladies-only seats
- [ ] Male students cannot select ladies-only seats
- [ ] Users with "OTHER" cannot select ladies-only seats
- [ ] Users with "PREFER_NOT_TO_SAY" cannot select ladies-only seats
- [ ] Users without gender cannot select ladies-only seats
- [ ] Error modal displays with correct title and message
- [ ] Error modal shows "Update Profile" link for users without gender
- [ ] Modal dismisses on "Close" button click
- [ ] Modal dismisses on overlay click
- [ ] "Update Profile" link navigates to /student/profile
- [ ] Regular seats can be selected by all users
- [ ] User gender retrieved from JWT token
- [ ] JWT decoding errors handled gracefully
- [ ] Modal design follows design system (pink accent, female symbol)
- [ ] No API call made when validation fails
- [ ] Unit tests passing (95%+ coverage)
- [ ] E2E tests passing (Playwright)
- [ ] No console errors or warnings
- [ ] Code reviewed and approved
- [ ] Stories 0.1.5-backend, 0.1.6, 1.4.1, and 2.16.1 verified complete

---

## Dependencies & Blockers

### Blocked By:
- ⛔ Story 0.1.5-backend (Backend Gender Field) - MUST be complete
- ⛔ Story 0.1.6 (Frontend Gender UI) - MUST be complete
- ⛔ Story 1.4.1 (Ladies-Only Seat Configuration) - MUST be complete
- ⛔ Story 2.16.1 (Ladies-Only Visual Styling) - MUST be complete
- ⛔ JWT token includes gender claim

### Unblocks:
- ✅ Story 2.1.1-backend (Backend Booking Validation)
- ✅ Complete ladies-only seats feature (frontend validation complete)

[Source: Sprint Change Proposal A, Section 8 - Phase 4]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Story created from Sprint Change Proposal A | Bob (SM) |

---

**Story Status**: Draft
**Last Updated**: 2025-10-14
**Next Steps**: Review with PO, verify all dependencies complete, assign to frontend developer
