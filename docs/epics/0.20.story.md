# Story 0.20: Implement User Entity and Repository

## Status
Ready for Review

## Story
**As a** Developer,
**I want** User entity properly configured for authentication,
**so that** user credentials and roles are stored securely.

## Acceptance Criteria
1. User entity updated with password hashing support ✅
2. User roles enum created (OWNER, STUDENT) ✅
3. UserRepository updated with authentication queries ✅
4. Password encoder bean configured ✅
5. User entity validated against database schema ✅
6. Sample test users created for development ✅

## Tasks / Subtasks
- [x] Task 1: Update User entity (AC: 1)
  - [x] Ensure password_hash field exists
  - [x] Add email validation
  - [x] Update role field with enum
  - [x] Add account status fields (enabled, locked)
- [x] Task 2: Create UserRole enum (AC: 2)
  - [x] Define OWNER and STUDENT roles
  - [x] Add ROLE_ prefix for Spring Security
  - [x] Implement in User entity
- [x] Task 3: Update UserRepository (AC: 3)
  - [x] Add findByEmail method
  - [x] Add existsByEmail method
  - [x] Ensure @Repository annotation
- [x] Task 4: Configure PasswordEncoder (AC: 4)
  - [x] Create PasswordEncoder bean (BCrypt)
  - [x] Add to SecurityConfig
  - [x] Document encoding strength
- [x] Task 5: Verify against database schema (AC: 5)
  - [x] Use PostgreSQL MCP to check users table
  - [x] Verify column names match entity
  - [x] Verify constraints align
- [x] Task 6: Create test data script (AC: 6)
  - [x] Create V3__insert_test_users.sql migration
  - [x] Insert owner test user
  - [x] Insert student test user
  - [x] Use BCrypt hashed passwords

## Dev Notes
User entity from Story 0.7 needs authentication enhancements.

### UserRole Enum
```java
public enum UserRole {
    ROLE_OWNER,
    ROLE_STUDENT
}
```

### PasswordEncoder Bean
```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

## Testing
- Verify User entity maps to database
- Test password encoding/validation
- Test repository queries

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Notes

**1. Created UserRole Enum:**
- Defined `ROLE_OWNER` and `ROLE_STUDENT` with ROLE_ prefix for Spring Security
- Added helper methods (`getRoleName()`, `fromString()`)
- Located at: `model/UserRole.java`

**2. Updated User Entity:**
- Added `passwordHash` field (String, not null)
- Changed `role` from String to `UserRole` enum with `@Enumerated(EnumType.STRING)`
- Added `enabled` Boolean field (default true)
- Added `locked` Boolean field (default false)
- Enhanced `@PrePersist` to initialize account status fields
- All fields properly validated with Jakarta Bean Validation

**3. UserRepository:**
- Already had required methods (`findByEmail`, `existsByEmail`)
- No changes needed - repository was complete from Story 0.7

**4. PasswordEncoder Configuration:**
- Added `passwordEncoder()` bean to `SecurityConfig`
- Uses `BCryptPasswordEncoder` with default strength (10)
- Properly documented

**5. Database Schema Alignment:**
- Created `V2__add_user_account_status.sql` migration:
  - Adds `enabled` and `locked` columns
  - Updates role values to include ROLE_ prefix
  - Updates CHECK constraint for roles
  - Adds performance index for enabled users
- Schema now fully matches User entity

**6. Test Data:**
- Created `V3__insert_test_users.sql` migration:
  - 6 test users (2 owners, 2 students, 1 locked, 1 disabled)
  - All users have password "password" (BCrypt hashed)
  - Covers various account states for testing

### File List
- `model/UserRole.java` (new)
- `model/User.java` (updated)
- `config/SecurityConfig.java` (updated - added PasswordEncoder bean)
- `repository/UserRepository.java` (no changes - already complete)
- `db/migration/V2__add_user_account_status.sql` (new)
- `db/migration/V3__insert_test_users.sql` (new)

### Completion Notes
- All acceptance criteria met
- User entity ready for Spring Security integration
- Database migrations ensure schema consistency
- Test users available for development and testing
- Password encoding properly configured
- Ready for JWT authentication implementation (Story 0.19, 0.21)

### Debug Log References
None - implementation completed without issues

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 0, Feature 0.5 | Bob (Scrum Master) |
| 2025-10-11 | 1.1 | Story completed - User entity enhanced for authentication | James (Dev Agent) |
