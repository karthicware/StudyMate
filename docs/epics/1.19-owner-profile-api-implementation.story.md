# Story 1.19: Owner Profile API Implementation (Backend)

## Story Metadata

| Field | Value |
|-------|-------|
| **Story ID** | 1.19 |
| **Title** | Owner Profile API Implementation |
| **Epic** | Epic-1 - Owner Dashboard & Analytics |
| **Feature** | Feature 1.5 - Owner Portal Infrastructure |
| **Priority** | High |
| **Story Points** | 5 |
| **Status** | Ready for Development |
| **Dependencies** | Epic 0 (Auth, Database Schema) |
| **Blocks** | Story 1.18 (Profile Page Frontend) |

---

## User Story

**As a** Backend Developer,
**I need** to implement Owner profile management APIs
**so that** Owners can retrieve and update their profile information.

---

## Acceptance Criteria

### AC1: GET /owner/profile Endpoint
- [ ] Returns authenticated owner's profile data
- [ ] Requires valid JWT with OWNER role
- [ ] Response includes:
  ```json
  {
    "id": 1,
    "firstName": "John",
    "lastName": "Doe",
    "email": "john@example.com",
    "phone": "+1-555-123-4567",
    "profilePictureUrl": "https://...",
    "hallName": "Downtown Study Hall",
    "createdAt": "2025-01-15T10:30:00Z"
  }
  ```
- [ ] Returns 401 for unauthenticated requests
- [ ] Returns 403 for non-owner roles

### AC2: PUT /owner/profile Endpoint
- [ ] Updates authenticated owner's profile
- [ ] Requires valid JWT with OWNER role
- [ ] Accepts request body:
  ```json
  {
    "firstName": "Updated",
    "lastName": "Name",
    "phone": "+1-555-999-8888"
  }
  ```
- [ ] Validates input fields (Bean Validation):
  - firstName: NotBlank, max 100 chars
  - lastName: NotBlank, max 100 chars
  - phone: Optional, pattern validation
- [ ] Returns updated profile data
- [ ] Returns 400 for validation failures
- [ ] Returns 401 for unauthenticated requests

### AC3: POST /owner/profile/avatar Endpoint
- [ ] Uploads profile picture
- [ ] Requires valid JWT with OWNER role
- [ ] Accepts multipart/form-data
- [ ] File size limit: 5MB
- [ ] Supported formats: JPG, PNG, WEBP
- [ ] Stores file locally or in cloud storage
- [ ] Updates profilePictureUrl in database
- [ ] Returns updated profile with new avatar URL
- [ ] Returns 400 for invalid file type/size
- [ ] Returns 401 for unauthenticated

### AC4: Authorization
- [ ] Owners can only access/update their own profile
- [ ] JWT sub (subject) claim matches profile owner_id
- [ ] Attempting to access other owner's profile returns 403

### AC5: Error Handling
- [ ] 400: Validation errors with field-specific messages
- [ ] 401: Unauthenticated (missing/invalid JWT)
- [ ] 403: Unauthorized (wrong role or accessing other's profile)
- [ ] 404: Profile not found
- [ ] 500: Server errors with proper logging (no sensitive info exposed)

---

## Tasks / Subtasks

- [ ] Task 1: Create controller and service structure (AC: All)
  - [ ] Create `OwnerProfileController` with @RestController
  - [ ] Create `OwnerProfileService` with @Service
  - [ ] Set up dependency injection (UserRepository, FileStorageService)
  - [ ] Configure @RequestMapping("/owner/profile")

- [ ] Task 2: Implement GET /owner/profile endpoint (AC: 1, 5)
  - [ ] Create GET endpoint method
  - [ ] Extract owner ID from @AuthenticationPrincipal
  - [ ] Fetch owner from UserRepository
  - [ ] Map User entity to OwnerProfileDTO
  - [ ] Return ResponseEntity with profile data
  - [ ] Handle 404 if owner not found
  - [ ] Handle 401 for unauthenticated requests

- [ ] Task 3: Implement PUT /owner/profile endpoint (AC: 2, 5)
  - [ ] Create PUT endpoint method
  - [ ] Accept @Valid @RequestBody UpdateProfileRequest
  - [ ] Extract owner ID from @AuthenticationPrincipal
  - [ ] Validate request with Bean Validation
  - [ ] Update User entity fields
  - [ ] Save updated user to database
  - [ ] Return updated OwnerProfileDTO
  - [ ] Handle 400 for validation errors

- [ ] Task 4: Implement POST /owner/profile/avatar endpoint (AC: 3, 5)
  - [ ] Create POST endpoint method
  - [ ] Accept @RequestParam("file") MultipartFile
  - [ ] Validate file size (<5MB)
  - [ ] Validate file type (JPG, PNG, WEBP)
  - [ ] Store file using FileStorageService
  - [ ] Update User entity profilePictureUrl
  - [ ] Return updated OwnerProfileDTO
  - [ ] Handle 400 for invalid file

- [ ] Task 5: Implement authorization checks (AC: 4)
  - [ ] Verify JWT sub claim matches owner_id
  - [ ] Ensure owners can only access their own profile
  - [ ] Return 403 for unauthorized access attempts
  - [ ] Test role-based access control

- [ ] Task 6: Create DTOs and validation (AC: 2, 5)
  - [ ] Create OwnerProfileDTO with Lombok @Builder
  - [ ] Create UpdateProfileRequest with validation annotations
  - [ ] Add @NotBlank, @Size, @Pattern validators
  - [ ] Implement phone number regex validation
  - [ ] Test validation rules

- [ ] Task 7: Implement FileStorageService (AC: 3)
  - [ ] Create FileStorageService (if not exists)
  - [ ] Implement file storage logic (local or cloud)
  - [ ] Generate unique file names
  - [ ] Return public file URL
  - [ ] Handle storage errors

- [ ] Task 8: Implement unit tests (AC: All)
  - [ ] Test getProfile success case
  - [ ] Test updateProfile success case
  - [ ] Test updateProfile validation failures
  - [ ] Test uploadAvatar success case
  - [ ] Test uploadAvatar file type validation
  - [ ] Test uploadAvatar file size validation
  - [ ] Test 404 when profile not found
  - [ ] Achieve 90%+ code coverage

- [ ] Task 9: Implement integration tests
  - [ ] Test full API workflow with MockMvc
  - [ ] Test JWT authentication
  - [ ] Test role authorization
  - [ ] Test file upload with multipart/form-data
  - [ ] Test database persistence

- [ ] Task 10: PostgreSQL MCP validation (AC: All)
  - [ ] Verify profile data updated in database
  - [ ] Verify avatar URL stored correctly
  - [ ] Test data retrieval queries
  - [ ] Validate foreign key constraints

---

## Technical Implementation

### Controller

**File:** `OwnerProfileController.java`

```java
@RestController
@RequestMapping("/owner/profile")
@RequiredArgsConstructor
public class OwnerProfileController {

    private final OwnerProfileService profileService;

    @GetMapping
    public ResponseEntity<OwnerProfileDTO> getProfile(@AuthenticationPrincipal User currentUser) {
        OwnerProfileDTO profile = profileService.getProfile(currentUser.getId());
        return ResponseEntity.ok(profile);
    }

    @PutMapping
    public ResponseEntity<OwnerProfileDTO> updateProfile(
            @AuthenticationPrincipal User currentUser,
            @Valid @RequestBody UpdateProfileRequest request) {
        OwnerProfileDTO updated = profileService.updateProfile(currentUser.getId(), request);
        return ResponseEntity.ok(updated);
    }

    @PostMapping("/avatar")
    public ResponseEntity<OwnerProfileDTO> uploadAvatar(
            @AuthenticationPrincipal User currentUser,
            @RequestParam("file") MultipartFile file) {
        OwnerProfileDTO updated = profileService.uploadAvatar(currentUser.getId(), file);
        return ResponseEntity.ok(updated);
    }
}
```

### Service

**File:** `OwnerProfileService.java`

```java
@Service
@RequiredArgsConstructor
public class OwnerProfileService {

    private final UserRepository userRepository;
    private final FileStorageService fileStorageService;

    public OwnerProfileDTO getProfile(Long ownerId) {
        User owner = userRepository.findById(ownerId)
            .orElseThrow(() -> new ResourceNotFoundException("Owner not found"));

        return OwnerProfileDTO.builder()
            .id(owner.getId())
            .firstName(owner.getFirstName())
            .lastName(owner.getLastName())
            .email(owner.getEmail())
            .phone(owner.getPhone())
            .profilePictureUrl(owner.getProfilePictureUrl())
            .hallName(owner.getStudyHall().getHallName())
            .createdAt(owner.getCreatedAt())
            .build();
    }

    public OwnerProfileDTO updateProfile(Long ownerId, UpdateProfileRequest request) {
        User owner = userRepository.findById(ownerId)
            .orElseThrow(() -> new ResourceNotFoundException("Owner not found"));

        owner.setFirstName(request.getFirstName());
        owner.setLastName(request.getLastName());
        owner.setPhone(request.getPhone());

        userRepository.save(owner);

        return getProfile(ownerId);
    }

    public OwnerProfileDTO uploadAvatar(Long ownerId, MultipartFile file) {
        // Validate file
        if (file.getSize() > 5 * 1024 * 1024) {
            throw new BadRequestException("File size exceeds 5MB");
        }

        String contentType = file.getContentType();
        if (!Arrays.asList("image/jpeg", "image/png", "image/webp").contains(contentType)) {
            throw new BadRequestException("Invalid file type");
        }

        // Store file
        String fileUrl = fileStorageService.store(file, "avatars");

        // Update user
        User owner = userRepository.findById(ownerId)
            .orElseThrow(() -> new ResourceNotFoundException("Owner not found"));

        owner.setProfilePictureUrl(fileUrl);
        userRepository.save(owner);

        return getProfile(ownerId);
    }
}
```

### DTOs

```java
@Data
@Builder
public class OwnerProfileDTO {
    private Long id;
    private String firstName;
    private String lastName;
    private String email;
    private String phone;
    private String profilePictureUrl;
    private String hallName;
    private LocalDateTime createdAt;
}

@Data
public class UpdateProfileRequest {
    @NotBlank(message = "First name is required")
    @Size(max = 100, message = "First name must not exceed 100 characters")
    private String firstName;

    @NotBlank(message = "Last name is required")
    @Size(max = 100, message = "Last name must not exceed 100 characters")
    private String lastName;

    @Pattern(regexp = "^\\+?1?-?\\(?\\d{3}\\)?-?\\d{3}-?\\d{4}$", message = "Invalid phone format")
    private String phone;
}
```

---

## Testing Requirements

### JUnit Tests

```java
@SpringBootTest
class OwnerProfileServiceTest {

    @Test
    void getProfile_Success() {
        OwnerProfileDTO profile = profileService.getProfile(ownerId);
        assertNotNull(profile);
        assertEquals("John", profile.getFirstName());
    }

    @Test
    void updateProfile_Success() {
        UpdateProfileRequest request = new UpdateProfileRequest();
        request.setFirstName("Updated");
        request.setLastName("Name");

        OwnerProfileDTO updated = profileService.updateProfile(ownerId, request);
        assertEquals("Updated", updated.getFirstName());
    }

    @Test
    void updateProfile_ValidationFails() {
        UpdateProfileRequest request = new UpdateProfileRequest();
        request.setFirstName(""); // Blank - should fail

        assertThrows(MethodArgumentNotValidException.class, () ->
            profileService.updateProfile(ownerId, request));
    }
}
```

### PostgreSQL MCP Validation

```sql
-- Verify profile data updated
SELECT id, first_name, last_name, phone, profile_picture_url
FROM users
WHERE id = 1 AND role = 'OWNER';

-- Verify avatar URL stored correctly
SELECT profile_picture_url FROM users WHERE id = 1;
```

---

## Definition of Done

- [ ] All endpoints implemented with acceptance criteria met
- [ ] Unit and integration tests passing
- [ ] PostgreSQL MCP validation successful
- [ ] Code reviewed and approved
- [ ] API documentation updated (OpenAPI/Swagger)

---

## References

- **Context7 MCP:** `"use context7 - Spring Boot 3.5.6 file upload multipart"`
- **Coding Standards:** [docs/guidelines/coding-standard-guidelines/java-spring-rules.md](../guidelines/coding-standard-guidelines/java-spring-rules.md)

---

## Estimated Effort: ~20 hours (5 SP)

---

**Status:** Ready for Development
**Blocks:** Story 1.18 (Frontend needs these APIs)

---

## Dev Notes

### Previous Story Insights

**Story 1.18** (Frontend) depends on these APIs:
- Frontend ProfileService will consume these endpoints
- DTO structure must match frontend expectations
- Error responses must be consumable by Angular HttpClient

**Epic 0** Auth infrastructure:
- JWT authentication configured
- @AuthenticationPrincipal provides authenticated user
- Security filters handle 401/403 responses

**Key Learning:** Profile API is foundational - must be secure and well-validated.

### Architecture Overview

[Source: docs/architecture/studymate-system-architecture-blueprint.md]
- **Backend**: Spring Boot 3.5.6 with Java 17
- **Security**: JWT/OAuth 2.0 authentication
- **Database**: PostgreSQL (users table)
- **File Storage**: Local or cloud storage (S3, Azure Blob)

### Spring Boot Development Standards

[Source: docs/guidelines/coding-standard-guidelines/java-spring-rules.md]
- Use @RestController for REST endpoints
- Use @Service for business logic
- Use Lombok annotations (@Data, @Builder, @RequiredArgsConstructor)
- Use Bean Validation annotations (@NotBlank, @Size, @Pattern)
- Use ResponseEntity for HTTP responses
- Follow RESTful conventions

### File Locations

**Controller & Service:**
- `studymate-backend/src/main/java/com/studymate/owner/controller/OwnerProfileController.java`
- `studymate-backend/src/main/java/com/studymate/owner/service/OwnerProfileService.java`

**DTOs:**
- `studymate-backend/src/main/java/com/studymate/owner/dto/OwnerProfileDTO.java`
- `studymate-backend/src/main/java/com/studymate/owner/dto/UpdateProfileRequest.java`

**File Storage:**
- `studymate-backend/src/main/java/com/studymate/core/service/FileStorageService.java`

**Tests:**
- `studymate-backend/src/test/java/com/studymate/owner/service/OwnerProfileServiceTest.java`
- `studymate-backend/src/test/java/com/studymate/owner/controller/OwnerProfileControllerTest.java`

### Database Schema

**users table** (from Epic 0):
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    email VARCHAR(255) UNIQUE,
    phone VARCHAR(20),
    profile_picture_url VARCHAR(500),
    role VARCHAR(20),
    -- other fields...
);
```

### Testing Requirements

[Source: docs/architecture/studymate-system-architecture-blueprint.md#5-testing-architecture--quality-assurance]

#### Unit Testing
- **Framework**: JUnit 5, Mockito
- **Coverage**: 90%+ required
- **Focus**: Service logic, validation, error handling

#### Integration Testing
- **Framework**: Spring Boot Test with MockMvc
- **Focus**: Full API workflow, authentication, file upload

#### PostgreSQL MCP Validation
- **Tool**: PostgreSQL MCP server (MANDATORY)
- **Focus**: Data persistence, query validation

### context7 MCP Integration (MANDATORY)

[Source: docs/architecture/studymate-system-architecture-blueprint.md#context7-mcp-integration-mandatory]
- **Pre-Implementation**: Consult context7 for Spring Boot 3.5.6 best practices
- **Required Query**: `"use context7 - Spring Boot 3.5.6 file upload multipart"`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Story created for Owner Profile API Implementation | Bob (Scrum Master) |
| 2025-10-12 | 1.1 | Added Tasks/Subtasks and Dev Notes sections | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent during implementation:_
- Document file storage approach (local vs cloud)
- Note any UserRepository modifications
- Describe validation implementation
- List any FileStorageService methods created
- Note any deviations from technical specs

### File List

**Files to Create:**
- `studymate-backend/src/main/java/com/studymate/owner/controller/OwnerProfileController.java`
- `studymate-backend/src/main/java/com/studymate/owner/service/OwnerProfileService.java`
- `studymate-backend/src/main/java/com/studymate/owner/dto/OwnerProfileDTO.java`
- `studymate-backend/src/main/java/com/studymate/owner/dto/UpdateProfileRequest.java`
- `studymate-backend/src/main/java/com/studymate/core/service/FileStorageService.java` (if not exists)
- `studymate-backend/src/test/java/com/studymate/owner/service/OwnerProfileServiceTest.java`
- `studymate-backend/src/test/java/com/studymate/owner/controller/OwnerProfileControllerTest.java`

**Files to Modify:**
- None (users table already exists from Epic 0)

---

## QA Results

_To be filled by QA Agent_
