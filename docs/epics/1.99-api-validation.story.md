# Story 1.99: Epic 1 API Validation with PostgreSQL MCP

## Status
Draft

## Story
**As a** QA Engineer,
**I want** all Epic 1 APIs validated end-to-end using PostgreSQL MCP with dummy data,
**so that** I can verify all endpoints work correctly with real database interactions and capture evidence.

## Acceptance Criteria
1. Test data created in database using PostgreSQL MCP
2. All Epic 1 endpoints tested with MCP-sourced data
3. Test results captured and documented in this story file
4. Authentication tested with real users from database
5. Owner authorization verified with database ownership records
6. All edge cases tested (404s, 403s, validation errors)
7. Database state verified after each operation

## Tasks / Subtasks
- [ ] Task 1: Setup test data using PostgreSQL MCP (AC: 1)
  - [ ] Create test owner user in database
  - [ ] Create test student users (5 users)
  - [ ] Create test study hall owned by test owner
  - [ ] Create test seats (20 seats with coordinates)
  - [ ] Create test bookings (10 active, 5 completed)
  - [ ] Capture INSERT results with row counts
- [ ] Task 2: Test authentication flow (AC: 4)
  - [ ] Query test user credentials from database
  - [ ] Call POST /api/auth/login with database user
  - [ ] Capture JWT token response
  - [ ] Verify token contains correct user info
  - [ ] Document login response in story file
- [ ] Task 3: Test GET /owner/dashboard/{hallId} (AC: 2, 7)
  - [ ] Call endpoint with test owner's JWT token
  - [ ] Verify response contains correct metrics
  - [ ] Query database to validate occupancy calculation
  - [ ] Query database to validate revenue calculation
  - [ ] Verify seat map data matches database
  - [ ] Capture API response and SQL query results
- [ ] Task 4: Test POST /owner/seats/config/{hallId} (AC: 2, 7)
  - [ ] Prepare seat configuration request with 5 new seats
  - [ ] Call endpoint with owner JWT token
  - [ ] Query database to verify seats created
  - [ ] Test duplicate seat number (should fail)
  - [ ] Verify foreign key to hall exists
  - [ ] Capture API response and database verification
- [ ] Task 5: Test GET /owner/users (AC: 2, 7)
  - [ ] Call endpoint with pagination (page=0, size=10)
  - [ ] Query database to count total users
  - [ ] Verify response matches database count
  - [ ] Test filtering by role (role=STUDENT)
  - [ ] Test search functionality
  - [ ] Capture response and SQL query results
- [ ] Task 6: Test POST /owner/users (AC: 2, 7)
  - [ ] Create new user via API
  - [ ] Query database to verify user created
  - [ ] Verify password is hashed (not plain text)
  - [ ] Test duplicate email (should fail with 400)
  - [ ] Verify validation errors for missing fields
  - [ ] Capture creation response and database state
- [ ] Task 7: Test PUT /owner/users/{userId} (AC: 2, 7)
  - [ ] Update user's first name via API
  - [ ] Query database to verify change
  - [ ] Compare before/after states
  - [ ] Test updating non-existent user (404)
  - [ ] Capture update response and SQL verification
- [ ] Task 8: Test DELETE /owner/users/{userId} (AC: 2, 7)
  - [ ] Delete test user via API
  - [ ] Query database to verify soft delete (deleted_at set)
  - [ ] Verify user no longer appears in GET /owner/users
  - [ ] Verify row still exists in database (soft delete)
  - [ ] Capture delete response and database state
- [ ] Task 9: Test GET /owner/users/{userId}/bookings (AC: 2)
  - [ ] Query database for user with bookings
  - [ ] Call endpoint to get booking history
  - [ ] Verify response matches database records
  - [ ] Test pagination on booking history
  - [ ] Capture response and SQL query results
- [ ] Task 10: Test GET /owner/reports/{hallId} (AC: 2, 7)
  - [ ] Set date range for report (last 30 days)
  - [ ] Call endpoint with format=pdf
  - [ ] Verify PDF file downloads
  - [ ] Query database for same date range
  - [ ] Verify report data matches database aggregation
  - [ ] Capture SQL aggregation queries and results
- [ ] Task 11: Test authorization failures (AC: 5, 6)
  - [ ] Test non-owner accessing another hall's dashboard (403)
  - [ ] Test accessing non-existent hall (404)
  - [ ] Test without JWT token (401)
  - [ ] Test with expired token (401)
  - [ ] Capture error responses
- [ ] Task 12: Test edge cases (AC: 6)
  - [ ] Test dashboard with zero seats
  - [ ] Test dashboard with 100% occupancy
  - [ ] Test dashboard with no revenue
  - [ ] Query database to set up edge case scenarios
  - [ ] Capture responses for each scenario
- [ ] Task 13: Document all results in story file (AC: 3)
  - [ ] Add "Test Results" section below
  - [ ] Include all SQL queries used
  - [ ] Include all API responses
  - [ ] Include database verification queries
  - [ ] Add screenshots or formatted output

## Dev Notes

### PostgreSQL MCP Integration
[Source: docs/architecture/studymate-system-architecture-blueprint.md#7-postgresql-mcp-integration-mandatory]
- **Database**: studymate_user
- **Credentials**: user=studymate_user, pwd=studymate_user
- **Tool**: `mcp__postgres__query`

### Test Data Setup Queries
Execute these via PostgreSQL MCP:

```sql
-- 1. Create test owner user
INSERT INTO users (email, password_hash, first_name, last_name, role)
VALUES ('owner@test.com', '$2a$10$...bcrypt_hash...', 'Test', 'Owner', 'OWNER')
RETURNING id, email, role;

-- 2. Create test student users
INSERT INTO users (email, password_hash, first_name, last_name, role)
VALUES
  ('student1@test.com', '$2a$10$...', 'Student', 'One', 'STUDENT'),
  ('student2@test.com', '$2a$10$...', 'Student', 'Two', 'STUDENT'),
  ('student3@test.com', '$2a$10$...', 'Student', 'Three', 'STUDENT'),
  ('student4@test.com', '$2a$10$...', 'Student', 'Four', 'STUDENT'),
  ('student5@test.com', '$2a$10$...', 'Student', 'Five', 'STUDENT')
RETURNING id, email;

-- 3. Create test study hall (use owner_id from step 1)
INSERT INTO study_halls (owner_id, hall_name, seat_count, address)
VALUES (1, 'Test Study Hall', 20, '123 Test Street, Test City')
RETURNING id, hall_name, seat_count;

-- 4. Create test seats (use hall_id from step 3)
INSERT INTO seats (hall_id, seat_number, x_coord, y_coord, status)
VALUES
  (1, 'A1', 10, 20, 'AVAILABLE'),
  (1, 'A2', 10, 40, 'AVAILABLE'),
  (1, 'A3', 10, 60, 'AVAILABLE'),
  (1, 'B1', 30, 20, 'AVAILABLE'),
  (1, 'B2', 30, 40, 'AVAILABLE'),
  (1, 'B3', 30, 60, 'AVAILABLE'),
  (1, 'C1', 50, 20, 'AVAILABLE'),
  (1, 'C2', 50, 40, 'AVAILABLE'),
  (1, 'C3', 50, 60, 'AVAILABLE'),
  (1, 'C4', 50, 80, 'AVAILABLE')
RETURNING id, seat_number, status;

-- 5. Create test bookings
INSERT INTO bookings (user_id, seat_id, start_time, end_time, status, payment_id)
VALUES
  (2, 1, '2025-10-10 09:00:00', '2025-10-10 18:00:00', 'CONFIRMED', NULL),
  (3, 2, '2025-10-10 09:00:00', '2025-10-10 18:00:00', 'CONFIRMED', NULL),
  (4, 3, '2025-10-10 09:00:00', '2025-10-10 18:00:00', 'CONFIRMED', NULL),
  (5, 4, '2025-10-10 09:00:00', '2025-10-10 18:00:00', 'CONFIRMED', NULL),
  (6, 5, '2025-10-10 09:00:00', '2025-10-10 18:00:00', 'CONFIRMED', NULL)
RETURNING id, user_id, seat_id, status;
```

### Validation Queries

**Verify Occupancy Calculation:**
```sql
-- Total seats
SELECT COUNT(*) as total_seats FROM seats WHERE hall_id = 1;

-- Active bookings
SELECT COUNT(*) as active_bookings
FROM bookings b
JOIN seats s ON b.seat_id = s.id
WHERE s.hall_id = 1
  AND b.status = 'CONFIRMED'
  AND b.end_time > CURRENT_TIMESTAMP;

-- Calculate occupancy %
SELECT
  (SELECT COUNT(*) FROM bookings b JOIN seats s ON b.seat_id = s.id
   WHERE s.hall_id = 1 AND b.status = 'CONFIRMED' AND b.end_time > CURRENT_TIMESTAMP) * 100.0 /
  (SELECT COUNT(*) FROM seats WHERE hall_id = 1) as occupancy_percentage;
```

**Verify Revenue Calculation:**
```sql
SELECT COALESCE(SUM(b.amount), 0) as total_revenue
FROM bookings b
JOIN seats s ON b.seat_id = s.id
WHERE s.hall_id = 1 AND b.status = 'CONFIRMED';
```

**Verify Seat Map Status:**
```sql
SELECT
  s.id,
  s.seat_number,
  s.x_coord,
  s.y_coord,
  CASE
    WHEN b.id IS NOT NULL THEN 'OCCUPIED'
    ELSE s.status
  END as current_status
FROM seats s
LEFT JOIN bookings b ON s.id = b.seat_id
  AND b.status = 'CONFIRMED'
  AND b.end_time > CURRENT_TIMESTAMP
WHERE s.hall_id = 1
ORDER BY s.seat_number;
```

### API Testing Template

For each endpoint, document:
1. **Setup**: SQL queries to prepare test data
2. **Request**: HTTP method, URL, headers, body
3. **Response**: Status code, response body
4. **Verification**: SQL queries to verify database state
5. **Teardown**: SQL queries to clean up (if needed)

## Test Results

### Test Data Setup Results
```
_To be filled by QA Agent during testing_

Example format:
=================================================
SQL Query:
INSERT INTO users (email, password_hash, first_name, last_name, role)
VALUES ('owner@test.com', '$2a$10$...', 'Test', 'Owner', 'OWNER')
RETURNING id, email, role;

Result:
 id |      email        |  role
----+-------------------+--------
  1 | owner@test.com    | OWNER
(1 row)
=================================================
```

### Authentication Test Results
```
_To be filled by QA Agent_

Request:
POST /api/auth/login
Content-Type: application/json

{
  "email": "owner@test.com",
  "password": "test123"
}

Response (200 OK):
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "email": "owner@test.com",
  "role": "OWNER"
}

Verification SQL:
SELECT email, role FROM users WHERE email = 'owner@test.com';

Result: ✅ User found, credentials match
```

### GET /owner/dashboard/{hallId} Test Results
```
_To be filled by QA Agent_

Request:
GET /owner/dashboard/1
Authorization: Bearer <token>

Response (200 OK):
{
  "totalSeats": 20,
  "occupancyPercentage": 25.0,
  "currentRevenue": 5000.00,
  "seatMap": [...]
}

Verification SQL:
-- Total seats query
-- Active bookings query
-- Revenue query

Result: ✅ All metrics match database calculations
```

### POST /owner/seats/config/{hallId} Test Results
```
_To be filled by QA Agent_
```

### GET /owner/users Test Results
```
_To be filled by QA Agent_
```

### POST /owner/users Test Results
```
_To be filled by QA Agent_
```

### PUT /owner/users/{userId} Test Results
```
_To be filled by QA Agent_
```

### DELETE /owner/users/{userId} Test Results
```
_To be filled by QA Agent_
```

### GET /owner/users/{userId}/bookings Test Results
```
_To be filled by QA Agent_
```

### GET /owner/reports/{hallId} Test Results
```
_To be filled by QA Agent_
```

### Authorization Failure Tests
```
_To be filled by QA Agent_

Test: Non-owner accessing another hall
Request: GET /owner/dashboard/999
Response: 403 Forbidden
Result: ✅ Authorization working correctly

Test: No JWT token
Request: GET /owner/dashboard/1 (no Authorization header)
Response: 401 Unauthorized
Result: ✅ Authentication required
```

### Edge Case Tests
```
_To be filled by QA Agent_

Test: Dashboard with 0 seats
Setup SQL: DELETE FROM seats WHERE hall_id = 1;
Response: { "totalSeats": 0, "occupancyPercentage": 0, "currentRevenue": 0 }
Result: ✅ Handles empty hall correctly

Test: Dashboard with 100% occupancy
Setup SQL: [Create bookings for all seats]
Response: { "occupancyPercentage": 100.0 }
Result: ✅ Calculates 100% correctly
```

## Testing Checklist

- [ ] All test data created successfully in database
- [ ] All SQL queries documented with results
- [ ] All API requests documented with responses
- [ ] All database verifications performed
- [ ] All edge cases tested
- [ ] All authorization scenarios tested
- [ ] All results captured in this story file
- [ ] Database cleaned up after testing (optional)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Epic 1 API validation story created | Bob (Scrum Master) |

## QA Agent Record

### Test Execution Date
_To be filled by QA Agent_

### Test Environment
- Database: studymate_user (PostgreSQL)
- Backend URL: http://localhost:8080
- PostgreSQL MCP: Connected ✅

### Overall Test Results
- Total Endpoints Tested: __/10
- Passed: __
- Failed: __
- Blocked: __

### Issues Found
_To be filled by QA Agent_

### Evidence Files
_Screenshots, exported SQL results, API response logs_
