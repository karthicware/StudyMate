# Story 0.24: Implement Token Storage and Refresh

## Status
Ready for development

## Story
**As a** Developer,
**I want** token storage and refresh mechanism implemented,
**so that** users stay authenticated and tokens refresh before expiration.

## Acceptance Criteria
1. Token refresh endpoint created in backend
2. Angular service refreshes token automatically
3. Refresh happens before token expires
4. Expired tokens handled gracefully
5. Logout clears all stored tokens
6. Token refresh tested end-to-end

## Tasks / Subtasks
- [ ] Task 1: Create refresh token endpoint (AC: 1)
  - [ ] POST /api/auth/refresh
  - [ ] Accept current token
  - [ ] Validate and generate new token
  - [ ] Return new token
- [ ] Task 2: Implement refresh in AuthService (AC: 2)
  - [ ] Add refreshToken method
  - [ ] Call refresh endpoint
  - [ ] Update stored token
- [ ] Task 3: Add automatic refresh (AC: 3)
  - [ ] Calculate token expiration time
  - [ ] Set timer to refresh before expiration
  - [ ] Refresh 5 minutes before expiry
  - [ ] Handle refresh failures
- [ ] Task 4: Handle expired tokens (AC: 4)
  - [ ] Detect 401 responses
  - [ ] Attempt token refresh
  - [ ] Logout if refresh fails
  - [ ] Show appropriate message
- [ ] Task 5: Update logout to clear tokens (AC: 5)
  - [ ] Clear localStorage
  - [ ] Clear any timers
  - [ ] Reset authentication state
- [ ] Task 6: Create integration tests (AC: 6)
  - [ ] Test token refresh flow
  - [ ] Test expired token handling
  - [ ] Test logout clears everything
  - [ ] Test automatic refresh

## Dev Notes

### Refresh Token Endpoint
```java
@PostMapping("/refresh")
public ResponseEntity<AuthResponse> refreshToken(
    @RequestHeader("Authorization") String authHeader) {
    String token = authHeader.substring(7);

    if (jwtTokenService.validateToken(token)) {
        String username = jwtTokenService.extractUsername(token);
        UserDetails userDetails = userDetailsService.loadUserByUsername(username);
        String newToken = jwtTokenService.generateToken(userDetails);

        return ResponseEntity.ok(new AuthResponse(newToken, username, ...));
    }

    return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
}
```

### Angular Token Refresh
```typescript
private startTokenRefresh() {
  const token = this.getToken();
  if (!token) return;

  const expiry = this.getTokenExpiry(token);
  const refreshTime = expiry - (5 * 60 * 1000); // 5 min before expiry
  const timeout = refreshTime - Date.now();

  if (timeout > 0) {
    setTimeout(() => this.refreshToken().subscribe(), timeout);
  }
}
```

## Testing
- Test refresh before expiration
- Test handling of expired tokens
- Test logout clears tokens
- E2E test for complete auth flow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 0, Feature 0.5 | Bob (Scrum Master) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
