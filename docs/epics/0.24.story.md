# Story 0.24: Implement Token Storage and Refresh

## Status
Ready for Review

## Story
**As a** Developer,
**I want** token storage and refresh mechanism implemented,
**so that** users stay authenticated and tokens refresh before expiration.

## Acceptance Criteria
1. Token refresh endpoint created in backend
2. Angular service refreshes token automatically
3. Refresh happens before token expires
4. Expired tokens handled gracefully
5. Logout clears all stored tokens
6. Token refresh tested end-to-end

## Tasks / Subtasks
- [x] Task 1: Create refresh token endpoint (AC: 1)
  - [x] POST /api/auth/refresh
  - [x] Accept current token
  - [x] Validate and generate new token
  - [x] Return new token
- [x] Task 2: Implement refresh in AuthService (AC: 2)
  - [x] Add refreshToken method
  - [x] Call refresh endpoint
  - [x] Update stored token
- [x] Task 3: Add automatic refresh (AC: 3)
  - [x] Calculate token expiration time
  - [x] Set timer to refresh before expiration
  - [x] Refresh 5 minutes before expiry
  - [x] Handle refresh failures
- [x] Task 4: Handle expired tokens (AC: 4)
  - [x] Detect 401 responses
  - [x] Attempt token refresh
  - [x] Logout if refresh fails
  - [x] Show appropriate message
- [x] Task 5: Update logout to clear tokens (AC: 5)
  - [x] Clear localStorage
  - [x] Clear any timers
  - [x] Reset authentication state
- [x] Task 6: Create integration tests (AC: 6)
  - [x] Test token refresh flow
  - [x] Test expired token handling
  - [x] Test logout clears everything
  - [x] Test automatic refresh

## Dev Notes

### Refresh Token Endpoint
```java
@PostMapping("/refresh")
public ResponseEntity<AuthResponse> refreshToken(
    @RequestHeader("Authorization") String authHeader) {
    String token = authHeader.substring(7);

    if (jwtTokenService.validateToken(token)) {
        String username = jwtTokenService.extractUsername(token);
        UserDetails userDetails = userDetailsService.loadUserByUsername(username);
        String newToken = jwtTokenService.generateToken(userDetails);

        return ResponseEntity.ok(new AuthResponse(newToken, username, ...));
    }

    return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
}
```

### Angular Token Refresh
```typescript
private startTokenRefresh() {
  const token = this.getToken();
  if (!token) return;

  const expiry = this.getTokenExpiry(token);
  const refreshTime = expiry - (5 * 60 * 1000); // 5 min before expiry
  const timeout = refreshTime - Date.now();

  if (timeout > 0) {
    setTimeout(() => this.refreshToken().subscribe(), timeout);
  }
}
```

## Testing
- Test refresh before expiration
- Test handling of expired tokens
- Test logout clears tokens
- E2E test for complete auth flow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 0, Feature 0.5 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes
- Backend refresh endpoint implemented and tested successfully (12/12 tests passing)
- Angular AuthService enhanced with:
  - refreshToken() method
  - getTokenExpiry() method for JWT decoding
  - Automatic token refresh timer (5 min before expiry)
  - Token refresh on login/register/refresh
  - Timer cleanup on logout
- HTTP interceptor updated to handle 401 responses with automatic token refresh and retry
- Installed jwt-decode npm package for token expiration parsing
- Comprehensive test suite added for refresh functionality
- All acceptance criteria met and validated

### File List
#### Backend
- studymate-backend/src/main/java/com/studymate/backend/service/AuthService.java (modified)
- studymate-backend/src/main/java/com/studymate/backend/service/AuthServiceImpl.java (modified)
- studymate-backend/src/main/java/com/studymate/backend/controller/AuthController.java (modified)
- studymate-backend/src/test/java/com/studymate/backend/controller/AuthControllerIntegrationTest.java (modified)

#### Frontend
- studymate-frontend/package.json (modified - added jwt-decode)
- studymate-frontend/src/app/core/services/auth.service.ts (modified)
- studymate-frontend/src/app/core/services/auth.service.spec.ts (modified)
- studymate-frontend/src/app/core/interceptors/auth.interceptor.ts (modified)

## QA Results
_To be filled by QA Agent_
