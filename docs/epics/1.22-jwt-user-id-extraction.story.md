# Story 1.22: JWT User ID Extraction Implementation

## Story Metadata

| Field | Value |
|-------|-------|
| **Story ID** | 1.22 |
| **Title** | JWT User ID Extraction Implementation |
| **Epic** | Epic-1 - Owner Dashboard & Analytics |
| **Feature** | Feature 1.5 - Owner Portal Infrastructure |
| **Priority** | Medium |
| **Story Points** | 3 |
| **Status** | Ready for development |
| **Dependencies** | Story 1.21 (Owner Settings API Implementation) |
| **Blocks** | None |

---

## User Story

**As a** Backend Developer,
**I need** to implement proper JWT user ID extraction from Spring Security context
**so that** the Owner Settings API and other authenticated endpoints can correctly identify the authenticated user instead of using placeholder values.

---

## Acceptance Criteria

### AC1: JWT Claims Extraction Utility
- [ ] Create a utility class `JwtUtils` or `SecurityUtils` for extracting user information from JWT claims
- [ ] Method signature: `public static Long extractUserIdFromAuthentication(Authentication authentication)`
- [ ] Extract user ID from JWT "sub" (subject) claim or custom claim
- [ ] Handle null/invalid authentication gracefully
- [ ] Return `null` or throw appropriate exception when authentication is invalid
- [ ] Unit tests for all extraction scenarios

### AC2: Update OwnerSettingsController
- [ ] Replace placeholder `extractUserIdFromAuthentication()` method
- [ ] Use new utility class for user ID extraction
- [ ] Remove TODO comment from line 68
- [ ] Maintain existing endpoint behavior (GET and PUT)
- [ ] Integration tests verify user ID correctly extracted

### AC3: Handle Edge Cases
- [ ] Throw 401 Unauthorized if authentication is null or invalid
- [ ] Throw 403 Forbidden if user ID cannot be extracted from valid JWT
- [ ] Log extraction failures for debugging
- [ ] Provide meaningful error messages in API responses

### AC4: Update Tests
- [ ] Update `OwnerSettingsControllerTest` to use proper JWT mocking
- [ ] Add test cases for user ID extraction failures
- [ ] Add test cases for invalid JWT tokens
- [ ] Ensure existing tests continue to pass with real extraction logic
- [ ] All tests passing (minimum 16/16)

### AC5: Documentation
- [ ] Add JavaDoc to JWT extraction utility
- [ ] Update controller comments to remove TODO
- [ ] Document JWT claim structure expected
- [ ] Add examples of JWT token structure in comments

---

## Tasks / Subtasks

- [ ] Task 1: Create JWT extraction utility (AC: 1, 3)
  - [ ] Create `JwtUtils` or `SecurityUtils` class in `com.studymate.backend.security` package
  - [ ] Implement `extractUserIdFromAuthentication(Authentication)` method
  - [ ] Extract user ID from JWT claims (check "sub" claim or custom "userId" claim)
  - [ ] Handle `JwtAuthenticationToken` type specifically
  - [ ] Add null safety checks and validation
  - [ ] Add error handling for invalid tokens
  - [ ] Add comprehensive JavaDoc documentation

- [ ] Task 2: Implement error handling (AC: 3)
  - [ ] Create custom exception `JwtExtractionException` if needed
  - [ ] Add logging for extraction failures (using SLF4J)
  - [ ] Ensure GlobalExceptionHandler catches and handles extraction errors
  - [ ] Map exceptions to appropriate HTTP status codes (401/403)
  - [ ] Test error scenarios

- [ ] Task 3: Update OwnerSettingsController (AC: 2)
  - [ ] Replace placeholder method with utility class call
  - [ ] Remove TODO comment
  - [ ] Ensure both GET and PUT endpoints use new extraction
  - [ ] Verify controller still returns proper responses
  - [ ] Update JavaDoc if needed

- [ ] Task 4: Update and extend integration tests (AC: 4)
  - [ ] Mock JWT authentication with proper claims in tests
  - [ ] Create test utility for generating test JWT tokens
  - [ ] Add test case: valid JWT with user ID
  - [ ] Add test case: valid JWT without user ID (should fail)
  - [ ] Add test case: null authentication (should return 401)
  - [ ] Add test case: invalid JWT format (should return 401)
  - [ ] Verify all existing tests still pass
  - [ ] Aim for 18+ total tests (14 existing + 4 new)

- [ ] Task 5: Add unit tests for JWT utility (AC: 1)
  - [ ] Create `JwtUtilsTest` or `SecurityUtilsTest`
  - [ ] Test successful extraction with valid JWT
  - [ ] Test extraction failure with invalid JWT
  - [ ] Test null authentication handling
  - [ ] Test missing user ID claim
  - [ ] Test malformed claims
  - [ ] Achieve 100% coverage of utility class

- [ ] Task 6: Documentation updates (AC: 5)
  - [ ] Add comprehensive JavaDoc to utility class
  - [ ] Document expected JWT structure
  - [ ] Update controller comments
  - [ ] Add code examples in documentation

---

## Dev Notes

### Previous Story Insights

**From Story 1.21** (Owner Settings API Implementation):
- Current implementation uses placeholder: `return 1L;` in `extractUserIdFromAuthentication()`
- TODO comment exists at line 68: `// TODO: Implement proper user ID extraction from JWT`
- Controller uses `Authentication` parameter instead of `@AuthenticationPrincipal User`
- Reason: User entity doesn't implement UserDetails interface
- This approach works for testing but needs production-ready JWT extraction
- Files to modify:
  - `studymate-backend/src/main/java/com/studymate/backend/controller/OwnerSettingsController.java`
  - `studymate-backend/src/test/java/com/studymate/backend/controller/OwnerSettingsControllerTest.java`

**QA Gate Feedback:**
- Non-blocking recommendation (priority: medium)
- Reference: OwnerSettingsController.java:68
- Note: "Currently returns placeholder value 1L. Production implementation should extract user ID from JWT claims in SecurityContext."

### Architecture Overview

[Source: docs/architecture/tech-stack.md#backend-stack]
- **Backend**: Spring Boot 3.5.6 with Java 17
- **Security**: JWT/OAuth 2.0 authentication via Spring Security
- **Testing**: JUnit 5 with Mockito for unit tests, MockMvc for integration tests

### Spring Security JWT Integration

[Source: docs/architecture/coding-standards.md#java-spring-boot-standards]
- Spring Security configured with JWT authentication
- JWT tokens contain user claims
- Authentication object in SecurityContext contains JWT information
- Standard claim structure:
  ```json
  {
    "sub": "123",          // Subject (usually user ID)
    "email": "user@example.com",
    "roles": ["ROLE_OWNER"],
    "exp": 1234567890,
    "iat": 1234567890
  }
  ```

### JWT Extraction Pattern

**Recommended Approach:**
```java
@Component
public class JwtUtils {

    private static final Logger log = LoggerFactory.getLogger(JwtUtils.class);

    /**
     * Extracts user ID from JWT authentication token.
     *
     * @param authentication Spring Security Authentication object
     * @return User ID as Long, or null if not found
     * @throws IllegalArgumentException if authentication is invalid
     */
    public static Long extractUserIdFromAuthentication(Authentication authentication) {
        if (authentication == null || !authentication.isAuthenticated()) {
            log.warn("Authentication is null or not authenticated");
            return null;
        }

        // For JWT tokens, principal is usually JwtAuthenticationToken
        if (authentication instanceof JwtAuthenticationToken) {
            Jwt jwt = ((JwtAuthenticationToken) authentication).getToken();

            // Try to get user ID from "sub" claim first
            String subject = jwt.getSubject();
            if (subject != null) {
                try {
                    return Long.parseLong(subject);
                } catch (NumberFormatException e) {
                    log.error("Cannot parse user ID from subject: {}", subject);
                }
            }

            // Try custom "userId" claim as fallback
            Object userIdClaim = jwt.getClaim("userId");
            if (userIdClaim != null) {
                return Long.valueOf(userIdClaim.toString());
            }
        }

        log.error("Cannot extract user ID from authentication: {}", authentication.getClass().getName());
        return null;
    }
}
```

### File Locations

**New Files:**
- `studymate-backend/src/main/java/com/studymate/backend/security/JwtUtils.java`
- `studymate-backend/src/test/java/com/studymate/backend/security/JwtUtilsTest.java`

**Files to Modify:**
- `studymate-backend/src/main/java/com/studymate/backend/controller/OwnerSettingsController.java`
- `studymate-backend/src/test/java/com/studymate/backend/controller/OwnerSettingsControllerTest.java`

### Testing Requirements

[Source: docs/architecture/coding-standards.md#testing-standards]

#### Unit Testing
- **Framework**: JUnit 5 with Mockito
- **Coverage**: 90%+ required for new utility class
- **Focus**: JWT extraction logic, edge cases, error handling

#### Integration Testing
- **Framework**: Spring Boot Test with MockMvc
- **Focus**: Controller behavior with real JWT extraction
- **JWT Mocking**: Use `@WithMockUser` or create JWT tokens for tests

#### Test Categories
1. **Happy Path**: Valid JWT with user ID in "sub" claim
2. **Alternative Path**: Valid JWT with user ID in custom "userId" claim
3. **Error Cases**: Null authentication, invalid JWT, missing user ID, non-numeric user ID
4. **Security**: Ensure 401/403 returned for authentication failures

### context7 MCP Integration (MANDATORY)

[Source: docs/architecture/tech-stack.md#development-tools]
- **Pre-Implementation**: Consult context7 for Spring Security 6 JWT best practices
- **Required Queries**:
  - `"use context7 - Spring Boot 3.5.6 JWT authentication extraction"`
  - `"use context7 - Spring Security 6 JwtAuthenticationToken usage"`
  - `"use context7 - Java 17 pattern matching for JWT claims"`

### Error Handling Strategy

**HTTP Status Codes:**
- **401 Unauthorized**: Authentication is null or invalid JWT
- **403 Forbidden**: Valid JWT but cannot extract user ID (data issue)
- **500 Internal Server Error**: Unexpected extraction failure

**Logging:**
- WARN level: Authentication null or not authenticated
- ERROR level: Cannot extract user ID from valid JWT
- DEBUG level: Successful extractions (optional, for troubleshooting)

### Security Considerations

1. **Never log JWT tokens** - contains sensitive user information
2. **Validate authentication state** before extraction
3. **Handle NumberFormatException** gracefully for non-numeric user IDs
4. **Thread safety** - utility methods should be stateless
5. **Null safety** - check all JWT claims for null before accessing

---

## Definition of Done

- [ ] JWT extraction utility implemented and tested
- [ ] OwnerSettingsController updated to use new utility
- [ ] All edge cases handled with proper error responses
- [ ] Unit tests for utility class (100% coverage)
- [ ] Integration tests updated with JWT mocking
- [ ] All tests passing (minimum 18/18)
- [ ] JavaDoc documentation complete
- [ ] TODO comment removed from controller
- [ ] Code reviewed and approved

---

## References

- **Story 1.21**: [Owner Settings API Implementation](./1.21-owner-settings-api-implementation.story.md)
- **QA Gate**: [Quality Gate for Story 1.21](../qa/gates/1.21-owner-settings-api-implementation.yml)
- **Context7 MCP**: `"use context7 - Spring Boot 3.5.6 JWT authentication"`
- **Coding Standards**: [Java/Spring Boot Rules](../guidelines/coding-standard-guidelines/java-spring-rules.md)
- **Security Config**: Review existing SecurityConfig for JWT setup

---

## Estimated Effort: ~12 hours (3 SP)

---

**Status:** Draft
**Assigned To:** Development Agent (James)
**Depends On:** Story 1.21 (completed)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 1.0 | Story created for JWT User ID Extraction | Bob (Scrum Master) |
