# Story 1.21: Owner Settings API Implementation (Backend)

## Story Metadata

| Field | Value |
|-------|-------|
| **Story ID** | 1.21 |
| **Title** | Owner Settings API Implementation |
| **Epic** | Epic-1 - Owner Dashboard & Analytics |
| **Feature** | Feature 1.5 - Owner Portal Infrastructure |
| **Priority** | Medium |
| **Story Points** | 5 |
| **Status** | Ready for Development |
| **Dependencies** | Epic 0 (Auth, Database Schema) |
| **Blocks** | Story 1.20 (Settings Page Frontend) |

---

## User Story

**As a** Backend Developer,
**I need** to implement Owner settings management APIs
**so that** Owners can configure their notification and system preferences.

---

## Acceptance Criteria

### AC1: GET /owner/settings Endpoint
- [ ] Returns authenticated owner's settings
- [ ] Requires valid JWT with OWNER role
- [ ] Response includes:
  ```json
  {
    "emailNotifications": true,
    "smsNotifications": false,
    "pushNotifications": true,
    "notificationBooking": true,
    "notificationPayment": true,
    "notificationSystem": true,
    "language": "en",
    "timezone": "America/New_York",
    "defaultView": "dashboard",
    "profileVisibility": "public"
  }
  ```
- [ ] Returns default settings if none exist for owner
- [ ] Returns 401 for unauthenticated requests

### AC2: PUT /owner/settings Endpoint
- [ ] Updates authenticated owner's settings (partial updates allowed)
- [ ] Requires valid JWT with OWNER role
- [ ] Accepts partial request body (any subset of fields)
- [ ] Validates all fields:
  - Boolean fields: emailNotifications, smsNotifications, pushNotifications, notificationBooking, notificationPayment, notificationSystem
  - String fields: language (enum: en, es, fr), timezone (valid timezone string), defaultView (enum: dashboard, seat-map), profileVisibility (enum: public, private)
- [ ] Returns updated settings
- [ ] Returns 400 for validation failures
- [ ] Returns 401 for unauthenticated requests

### AC3: Default Settings on Owner Registration
- [ ] When new owner created (in User Service), create default settings:
  ```json
  {
    "emailNotifications": true,
    "smsNotifications": false,
    "pushNotifications": true,
    "notificationBooking": true,
    "notificationPayment": true,
    "notificationSystem": true,
    "language": "en",
    "timezone": "UTC",
    "defaultView": "dashboard",
    "profileVisibility": "public"
  }
  ```
- [ ] Settings automatically created on owner registration

### AC4: Database Schema (Flyway Migration)
- [ ] Create `owner_settings` table:
  ```sql
  CREATE TABLE owner_settings (
      id SERIAL PRIMARY KEY,
      owner_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
      email_notifications BOOLEAN DEFAULT TRUE,
      sms_notifications BOOLEAN DEFAULT FALSE,
      push_notifications BOOLEAN DEFAULT TRUE,
      notification_booking BOOLEAN DEFAULT TRUE,
      notification_payment BOOLEAN DEFAULT TRUE,
      notification_system BOOLEAN DEFAULT TRUE,
      language VARCHAR(10) DEFAULT 'en',
      timezone VARCHAR(50) DEFAULT 'UTC',
      default_view VARCHAR(20) DEFAULT 'dashboard',
      profile_visibility VARCHAR(20) DEFAULT 'public',
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(owner_id)
  );
  ```
- [ ] Migration executed successfully via `./mvnw flyway:migrate`
- [ ] Validated via PostgreSQL MCP

### AC5: Authorization
- [ ] Owners can only access/update their own settings
- [ ] JWT sub (subject) claim matches owner_id
- [ ] Attempting to access other owner's settings returns 403

### AC6: Error Handling
- [ ] 400: Validation errors with field-specific messages
- [ ] 401: Unauthenticated (missing/invalid JWT)
- [ ] 403: Unauthorized (wrong role)
- [ ] 404: Settings not found (should auto-create)
- [ ] 500: Server errors with proper logging

---

## Tasks / Subtasks

- [ ] Task 1: Create Flyway migration (AC: 4)
  - [ ] Create V5__create_owner_settings.sql migration file
  - [ ] Define owner_settings table schema
  - [ ] Add all required columns with default values
  - [ ] Create UNIQUE constraint on owner_id
  - [ ] Add foreign key to users table with ON DELETE CASCADE
  - [ ] Create index on owner_id
  - [ ] Run migration: `./mvnw flyway:migrate`
  - [ ] Verify table created with PostgreSQL MCP

- [ ] Task 2: Create entity and repository (AC: All)
  - [ ] Create OwnerSettings JPA entity with @Entity
  - [ ] Add all fields with proper @Column annotations
  - [ ] Use Lombok annotations (@Data, @Builder)
  - [ ] Create OwnerSettingsRepository interface
  - [ ] Add findByOwnerId method
  - [ ] Test repository methods

- [ ] Task 3: Create controller and service (AC: All)
  - [ ] Create OwnerSettingsController with @RestController
  - [ ] Create OwnerSettingsService with @Service
  - [ ] Set up dependency injection
  - [ ] Configure @RequestMapping("/owner/settings")

- [ ] Task 4: Implement GET /owner/settings endpoint (AC: 1, 6)
  - [ ] Create GET endpoint method
  - [ ] Extract owner ID from @AuthenticationPrincipal
  - [ ] Find settings by owner ID
  - [ ] If not found, create default settings
  - [ ] Map OwnerSettings entity to DTO
  - [ ] Return ResponseEntity with settings data
  - [ ] Handle errors (401, 500)

- [ ] Task 5: Implement PUT /owner/settings endpoint (AC: 2, 6)
  - [ ] Create PUT endpoint method
  - [ ] Accept @Valid @RequestBody UpdateSettingsRequest
  - [ ] Extract owner ID from @AuthenticationPrincipal
  - [ ] Find or create settings for owner
  - [ ] Implement partial update logic (only update non-null fields)
  - [ ] Save updated settings to database
  - [ ] Return updated DTO
  - [ ] Handle validation errors (400)

- [ ] Task 6: Implement default settings creation (AC: 3)
  - [ ] Create createDefaultSettings method
  - [ ] Set all default values (email=true, sms=false, etc.)
  - [ ] Save to database
  - [ ] Return new settings entity
  - [ ] Consider auto-creating on user registration

- [ ] Task 7: Implement authorization (AC: 5)
  - [ ] Verify JWT sub claim matches owner_id
  - [ ] Ensure owners can only access their own settings
  - [ ] Return 403 for unauthorized access attempts
  - [ ] Test role-based access control

- [ ] Task 8: Create DTOs and validation (AC: 2, 6)
  - [ ] Create OwnerSettingsDTO with Lombok @Builder
  - [ ] Create UpdateSettingsRequest
  - [ ] Add validation annotations for enum fields
  - [ ] Test validation rules

- [ ] Task 9: Implement unit tests (AC: All)
  - [ ] Test getSettings creates defaults if not found
  - [ ] Test updateSettings partial update logic
  - [ ] Test updateSettings validation
  - [ ] Test authorization checks
  - [ ] Test default settings values
  - [ ] Achieve 90%+ code coverage

- [ ] Task 10: Implement integration tests
  - [ ] Test full API workflow with MockMvc
  - [ ] Test JWT authentication
  - [ ] Test partial updates
  - [ ] Test database persistence

- [ ] Task 11: PostgreSQL MCP validation (AC: All)
  - [ ] Verify migration created table
  - [ ] Verify default settings created
  - [ ] Verify settings updated in database
  - [ ] Test data retrieval queries
  - [ ] Validate foreign key constraints

---

## Technical Implementation

### Flyway Migration

**File:** `src/main/resources/db/migration/V5__create_owner_settings.sql`

```sql
CREATE TABLE owner_settings (
    id SERIAL PRIMARY KEY,
    owner_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    email_notifications BOOLEAN DEFAULT TRUE,
    sms_notifications BOOLEAN DEFAULT FALSE,
    push_notifications BOOLEAN DEFAULT TRUE,
    notification_booking BOOLEAN DEFAULT TRUE,
    notification_payment BOOLEAN DEFAULT TRUE,
    notification_system BOOLEAN DEFAULT TRUE,
    language VARCHAR(10) DEFAULT 'en',
    timezone VARCHAR(50) DEFAULT 'UTC',
    default_view VARCHAR(20) DEFAULT 'dashboard',
    profile_visibility VARCHAR(20) DEFAULT 'public',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(owner_id)
);

CREATE INDEX idx_owner_settings_owner_id ON owner_settings(owner_id);
```

### Controller

**File:** `OwnerSettingsController.java`

```java
@RestController
@RequestMapping("/owner/settings")
@RequiredArgsConstructor
public class OwnerSettingsController {

    private final OwnerSettingsService settingsService;

    @GetMapping
    public ResponseEntity<OwnerSettingsDTO> getSettings(@AuthenticationPrincipal User currentUser) {
        OwnerSettingsDTO settings = settingsService.getSettings(currentUser.getId());
        return ResponseEntity.ok(settings);
    }

    @PutMapping
    public ResponseEntity<OwnerSettingsDTO> updateSettings(
            @AuthenticationPrincipal User currentUser,
            @Valid @RequestBody UpdateSettingsRequest request) {
        OwnerSettingsDTO updated = settingsService.updateSettings(currentUser.getId(), request);
        return ResponseEntity.ok(updated);
    }
}
```

### Service

**File:** `OwnerSettingsService.java`

```java
@Service
@RequiredArgsConstructor
public class OwnerSettingsService {

    private final OwnerSettingsRepository settingsRepository;

    public OwnerSettingsDTO getSettings(Long ownerId) {
        OwnerSettings settings = settingsRepository.findByOwnerId(ownerId)
            .orElseGet(() -> createDefaultSettings(ownerId));

        return mapToDTO(settings);
    }

    @Transactional
    public OwnerSettingsDTO updateSettings(Long ownerId, UpdateSettingsRequest request) {
        OwnerSettings settings = settingsRepository.findByOwnerId(ownerId)
            .orElseGet(() => createDefaultSettings(ownerId));

        // Partial update - only update non-null fields
        if (request.getEmailNotifications() != null) {
            settings.setEmailNotifications(request.getEmailNotifications());
        }
        if (request.getLanguage() != null) {
            settings.setLanguage(request.getLanguage());
        }
        // ... update other fields ...

        settings.setUpdatedAt(LocalDateTime.now());
        settingsRepository.save(settings);

        return mapToDTO(settings);
    }

    private OwnerSettings createDefaultSettings(Long ownerId) {
        OwnerSettings settings = OwnerSettings.builder()
            .ownerId(ownerId)
            .emailNotifications(true)
            .smsNotifications(false)
            .pushNotifications(true)
            .notificationBooking(true)
            .notificationPayment(true)
            .notificationSystem(true)
            .language("en")
            .timezone("UTC")
            .defaultView("dashboard")
            .profileVisibility("public")
            .build();

        return settingsRepository.save(settings);
    }
}
```

### Entity

**File:** `OwnerSettings.java`

```java
@Entity
@Table(name = "owner_settings")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OwnerSettings {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "owner_id", nullable = false, unique = true)
    private Long ownerId;

    @Column(name = "email_notifications")
    private Boolean emailNotifications;

    @Column(name = "sms_notifications")
    private Boolean smsNotifications;

    @Column(name = "push_notifications")
    private Boolean pushNotifications;

    @Column(name = "notification_booking")
    private Boolean notificationBooking;

    @Column(name = "notification_payment")
    private Boolean notificationPayment;

    @Column(name = "notification_system")
    private Boolean notificationSystem;

    @Column(length = 10)
    private String language;

    @Column(length = 50)
    private String timezone;

    @Column(name = "default_view", length = 20)
    private String defaultView;

    @Column(name = "profile_visibility", length = 20)
    private String profileVisibility;

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
}
```

---

## Testing Requirements

### JUnit Tests

```java
@SpringBootTest
class OwnerSettingsServiceTest {

    @Test
    void getSettings_CreatesDefaultIfNotExists() {
        OwnerSettingsDTO settings = settingsService.getSettings(newOwnerId);

        assertNotNull(settings);
        assertTrue(settings.getEmailNotifications());
        assertEquals("en", settings.getLanguage());
    }

    @Test
    void updateSettings_PartialUpdate() {
        UpdateSettingsRequest request = new UpdateSettingsRequest();
        request.setEmailNotifications(false);
        // Other fields null - should not update

        OwnerSettingsDTO updated = settingsService.updateSettings(ownerId, request);

        assertFalse(updated.getEmailNotifications());
        assertEquals("en", updated.getLanguage()); // Unchanged
    }
}
```

### PostgreSQL MCP Validation

```sql
-- Verify migration created table
SELECT table_name, column_name, data_type
FROM information_schema.columns
WHERE table_name = 'owner_settings';

-- Verify default settings created
SELECT * FROM owner_settings WHERE owner_id = 1;

-- Verify settings updated
UPDATE owner_settings SET email_notifications = false WHERE owner_id = 1;
SELECT email_notifications FROM owner_settings WHERE owner_id = 1;
```

---

## Definition of Done

- [ ] All endpoints implemented with acceptance criteria met
- [ ] Flyway migration created and executed
- [ ] Unit and integration tests passing
- [ ] PostgreSQL MCP validation successful
- [ ] Code reviewed and approved
- [ ] API documentation updated (OpenAPI/Swagger)

---

## References

- **Context7 MCP:** `"use context7 - Spring Boot 3.5.6 JPA entity relationships"`
- **Flyway:** `"use context7 - Flyway PostgreSQL migration best practices"`
- **Coding Standards:** [docs/guidelines/coding-standard-guidelines/java-spring-rules.md](../guidelines/coding-standard-guidelines/java-spring-rules.md)

---

## Estimated Effort: ~20 hours (5 SP)

---

**Status:** Ready for Development
**Blocks:** Story 1.20 (Frontend needs these APIs)

---

## Dev Notes

### Previous Story Insights

**Story 1.20** (Frontend) depends on these APIs:
- Frontend SettingsService will consume these endpoints
- DTO structure must match frontend expectations
- Partial updates must be supported (only non-null fields updated)
- Default settings must be auto-created if not found

**Story 1.19** (Profile API) provides similar patterns:
- Controller/Service structure
- @AuthenticationPrincipal for authenticated user
- DTO mapping and validation

**Epic 0** Auth infrastructure:
- JWT authentication configured
- Security filters handle 401/403 responses

**Key Learning:** Settings API supports partial updates - must only update provided fields, not reset others to null.

### Architecture Overview

[Source: docs/architecture/studymate-system-architecture-blueprint.md]
- **Backend**: Spring Boot 3.5.6 with Java 17
- **Security**: JWT/OAuth 2.0 authentication
- **Database**: PostgreSQL (owner_settings table)
- **Migration Tool**: Flyway

### Spring Boot Development Standards

[Source: docs/guidelines/coding-standard-guidelines/java-spring-rules.md]
- Use @RestController for REST endpoints
- Use @Service for business logic
- Use Lombok annotations (@Data, @Builder, @RequiredArgsConstructor)
- Use Bean Validation for enum validation
- Use ResponseEntity for HTTP responses
- Follow RESTful conventions

### Database Migration

**Flyway Conventions:**
- Version: V5 (increment from last migration)
- Naming: V5__create_owner_settings.sql
- Location: src/main/resources/db/migration/
- Command: `./mvnw flyway:migrate`

### File Locations

**Migration:**
- `studymate-backend/src/main/resources/db/migration/V5__create_owner_settings.sql`

**Entity & Repository:**
- `studymate-backend/src/main/java/com/studymate/owner/entity/OwnerSettings.java`
- `studymate-backend/src/main/java/com/studymate/owner/repository/OwnerSettingsRepository.java`

**Controller & Service:**
- `studymate-backend/src/main/java/com/studymate/owner/controller/OwnerSettingsController.java`
- `studymate-backend/src/main/java/com/studymate/owner/service/OwnerSettingsService.java`

**DTOs:**
- `studymate-backend/src/main/java/com/studymate/owner/dto/OwnerSettingsDTO.java`
- `studymate-backend/src/main/java/com/studymate/owner/dto/UpdateSettingsRequest.java`

**Tests:**
- `studymate-backend/src/test/java/com/studymate/owner/service/OwnerSettingsServiceTest.java`
- `studymate-backend/src/test/java/com/studymate/owner/controller/OwnerSettingsControllerTest.java`

### Partial Update Pattern

**Service Logic:**
```java
public OwnerSettingsDTO updateSettings(Long ownerId, UpdateSettingsRequest request) {
    OwnerSettings settings = findOrCreate(ownerId);

    // Only update non-null fields
    if (request.getEmailNotifications() != null) {
        settings.setEmailNotifications(request.getEmailNotifications());
    }
    if (request.getLanguage() != null) {
        settings.setLanguage(request.getLanguage());
    }
    // ... other fields

    settings.setUpdatedAt(LocalDateTime.now());
    repository.save(settings);
    return mapToDTO(settings);
}
```

### Testing Requirements

[Source: docs/architecture/studymate-system-architecture-blueprint.md#5-testing-architecture--quality-assurance]

#### Unit Testing
- **Framework**: JUnit 5, Mockito
- **Coverage**: 90%+ required
- **Focus**: Service logic, partial updates, default creation

#### Integration Testing
- **Framework**: Spring Boot Test with MockMvc
- **Focus**: Full API workflow, authentication, database persistence

#### PostgreSQL MCP Validation
- **Tool**: PostgreSQL MCP server (MANDATORY)
- **Focus**: Migration validation, data persistence

### context7 MCP Integration (MANDATORY)

[Source: docs/architecture/studymate-system-architecture-blueprint.md#context7-mcp-integration-mandatory]
- **Pre-Implementation**: Consult context7 for Spring Boot 3.5.6 and Flyway best practices
- **Required Queries**:
  - `"use context7 - Spring Boot 3.5.6 JPA entity relationships"`
  - `"use context7 - Flyway PostgreSQL migration best practices"`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | Story created for Owner Settings API Implementation | Bob (Scrum Master) |
| 2025-10-12 | 1.1 | Added Tasks/Subtasks and Dev Notes sections | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent during implementation:_
- Document Flyway migration execution
- Note partial update implementation details
- Describe default settings creation logic
- List any OwnerSettingsRepository methods created
- Note any deviations from technical specs

### File List

**Files to Create:**
- `studymate-backend/src/main/resources/db/migration/V5__create_owner_settings.sql`
- `studymate-backend/src/main/java/com/studymate/owner/entity/OwnerSettings.java`
- `studymate-backend/src/main/java/com/studymate/owner/repository/OwnerSettingsRepository.java`
- `studymate-backend/src/main/java/com/studymate/owner/controller/OwnerSettingsController.java`
- `studymate-backend/src/main/java/com/studymate/owner/service/OwnerSettingsService.java`
- `studymate-backend/src/main/java/com/studymate/owner/dto/OwnerSettingsDTO.java`
- `studymate-backend/src/main/java/com/studymate/owner/dto/UpdateSettingsRequest.java`
- `studymate-backend/src/test/java/com/studymate/owner/service/OwnerSettingsServiceTest.java`
- `studymate-backend/src/test/java/com/studymate/owner/controller/OwnerSettingsControllerTest.java`

**Files to Modify:**
- None (users table already exists, no changes needed)

---

## QA Results

_To be filled by QA Agent_
