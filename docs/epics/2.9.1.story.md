# Story 2.9.1: Student Profile Gender Display/Edit

## Story Metadata

| Field | Value |
|-------|-------|
| **Story ID** | 2.9.1 |
| **Story Name** | Student Profile Gender Display/Edit |
| **Epic** | Epic 2: Student Booking & Seat Management |
| **Feature** | Feature 2.9: Student Profile Management (Enhancement) |
| **Story Type** | Frontend Development |
| **Priority** | Medium (Phase 3 of Ladies-Only Implementation) |
| **Status** | Draft |
| **Estimated Story Points** | 1 SP |
| **Sprint** | TBD (Phase 3 of Ladies-Only Implementation) |
| **Assigned To** | Unassigned |
| **Created Date** | 2025-10-14 |
| **Updated Date** | 2025-10-14 |
| **Related Change Proposal** | Sprint Change Proposal A: Ladies-Only Seats (SCP-2025-10-14-001) |

---

## User Story

**As a** Student,
**I want** to view and update my gender in my profile settings
**so that** I can access ladies-only seats if I identify as female or update my gender if it was not set during registration.

---

## Story Description

This story adds a gender field to the student profile page, allowing students to view and update their gender. The gender dropdown includes four options: Male, Female, Other, and Prefer not to say. When a student updates their gender, the system calls the backend API to persist the change and updates the JWT token. This enables students to update their gender after registration to access ladies-only seats.

**Context**:
- Part of Sprint Change Proposal A: Ladies-Only Seats Configuration
- Depends on Story 0.1.5-backend (gender field exists in database)
- Enables students to update gender for ladies-only seat access
- Optional enhancement for user profile management

**Business Value**:
- Students who skipped gender during registration can update it later
- Students can correct their gender if initially set incorrectly
- Improves UX by allowing self-service gender updates
- Reduces support tickets for gender corrections

[Source: Sprint Change Proposal A, Section 8 - Phase 3]

---

## Acceptance Criteria

### AC1: Gender Field Displays in Profile View
**Given** a student is viewing their profile page
**When** the profile page loads
**Then** the system displays:
- "Gender" label
- Current gender value (or "Not Set" if null)
- Edit button or dropdown (if in edit mode)
- Help text: "Used for ladies-only seat booking validation"

**Testing**:
- [ ] Gender field visible in profile
- [ ] "Not Set" displayed if gender is null
- [ ] Current gender value displayed if set
- [ ] Help text visible

[Source: Sprint Change Proposal A, Section 6 - Frontend Changes]

---

### AC2: Student Can Edit Gender via Dropdown
**Given** a student is viewing their profile in edit mode
**When** the student clicks the gender dropdown
**Then** the system displays:
- Dropdown with four options:
  - "Prefer not to say" (value: null)
  - "Male" (value: MALE)
  - "Female" (value: FEMALE)
  - "Other" (value: OTHER)
- Current gender pre-selected
- Dropdown follows design system styling

**Testing**:
- [ ] Dropdown renders with all four options
- [ ] Current gender pre-selected
- [ ] User can select different option
- [ ] Dropdown styling matches design system

[Source: Sprint Change Proposal A, Section 6 - Frontend Changes]

---

### AC3: Gender Update Saves via API
**Given** a student has updated their gender in the profile form
**When** the student clicks "Save" or "Update Profile" button
**Then** the system:
- Calls `PUT /api/user/profile` with gender field
- Sends gender value (MALE | FEMALE | OTHER | null)
- Shows success message on successful update
- Shows error message if update fails
- Refreshes JWT token if backend returns new token

**API Request Example**:
```json
PUT /api/user/profile
{
  "firstName": "John",
  "lastName": "Doe",
  "gender": "FEMALE"
}
```

**API Response Example**:
```json
{
  "message": "Profile updated successfully",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." // New JWT with updated gender
}
```

**Testing**:
- [ ] API called with correct gender value
- [ ] Success message displayed on 200 response
- [ ] Error message displayed on 400/500 response
- [ ] JWT token refreshed after update
- [ ] Profile data reloaded after update

[Source: Sprint Change Proposal A, Section 6 - Frontend Changes]

---

### AC4: JWT Token Refreshed After Gender Update
**Given** a student has successfully updated their gender
**When** the API returns a new JWT token
**Then** the system:
- Replaces old JWT token in localStorage
- Updates AuthService state with new token
- Decodes new token to extract updated gender
- Updates user gender signal in AuthService
- No re-login required

**Testing**:
- [ ] JWT token updated in localStorage
- [ ] AuthService state updated
- [ ] User gender extracted from new token
- [ ] No re-login prompt shown

[Source: Sprint Change Proposal A, Section 6 - Frontend Changes]

---

### AC5: Gender Update Success Message Displays
**Given** a student has successfully updated their gender
**When** the API call completes successfully
**Then** the system displays:
- Success toast/alert message
- Message text: "Profile updated successfully"
- Green success styling
- Auto-dismisses after 3 seconds

**Testing**:
- [ ] Success message displayed
- [ ] Message auto-dismisses after 3 seconds
- [ ] Message styling matches design system
- [ ] No error messages shown

[Source: Sprint Change Proposal A, Section 9 - Design System Compliance]

---

## Technical Implementation Details

### Frontend Implementation

**1. Update Profile Service**

File: `studymate-frontend/src/app/core/services/profile.service.ts`
```typescript
import { Injectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';
import { AuthService } from './auth.service';
import { environment } from '@env/environment';

export interface ProfileUpdateRequest {
  firstName: string;
  lastName: string;
  email: string;
  phoneNumber?: string;
  gender?: 'MALE' | 'FEMALE' | 'OTHER' | null;
}

export interface ProfileUpdateResponse {
  message: string;
  token?: string; // New JWT token with updated gender
}

@Injectable({
  providedIn: 'root'
})
export class ProfileService {
  private http = inject(HttpClient);
  private authService = inject(AuthService);

  private readonly API_URL = `${environment.apiUrl}/api/user/profile`;

  /**
   * Update user profile (including gender)
   */
  updateProfile(profileData: ProfileUpdateRequest): Observable<ProfileUpdateResponse> {
    return this.http.put<ProfileUpdateResponse>(this.API_URL, profileData).pipe(
      tap((response) => {
        // NEW: If backend returns new JWT token, update localStorage
        if (response.token) {
          this.authService.updateToken(response.token);
        }
      })
    );
  }

  /**
   * Get user profile
   */
  getProfile(): Observable<any> {
    return this.http.get(this.API_URL);
  }
}
```

**2. Update Auth Service with Token Refresh**

File: `studymate-frontend/src/app/core/services/auth.service.ts`
```typescript
// ... existing code ...

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  // ... existing code ...

  /**
   * NEW: Update JWT token in localStorage and refresh state
   */
  updateToken(newToken: string): void {
    localStorage.setItem(this.TOKEN_KEY, newToken);
    const decoded = this.decodeToken(newToken);
    this.currentUser.set(decoded);
  }

  // ... existing code ...
}
```

**3. Student Profile Component Logic**

File: `studymate-frontend/src/app/features/student/profile/profile.component.ts`
```typescript
import { Component, OnInit, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, FormGroup, Validators, ReactiveFormsModule } from '@angular/forms';
import { ProfileService, ProfileUpdateRequest } from '@core/services/profile.service';
import { AuthService } from '@core/services/auth.service';

@Component({
  selector: 'app-student-profile',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './profile.component.html',
  styleUrls: ['./profile.component.scss']
})
export class StudentProfileComponent implements OnInit {
  private fb = inject(FormBuilder);
  private profileService = inject(ProfileService);
  private authService = inject(AuthService);

  profileForm!: FormGroup;
  isLoading = signal(false);
  showSuccessMessage = signal(false);
  errorMessage = signal<string | null>(null);

  // NEW: Gender options
  genderOptions = [
    { value: '', label: 'Prefer not to say' },
    { value: 'MALE', label: 'Male' },
    { value: 'FEMALE', label: 'Female' },
    { value: 'OTHER', label: 'Other' }
  ];

  ngOnInit(): void {
    this.initializeForm();
    this.loadProfile();
  }

  initializeForm(): void {
    this.profileForm = this.fb.group({
      firstName: ['', [Validators.required]],
      lastName: ['', [Validators.required]],
      email: [{ value: '', disabled: true }], // Email not editable
      phoneNumber: [''],
      gender: [''] // NEW: Optional gender field
    });
  }

  loadProfile(): void {
    this.isLoading.set(true);
    this.profileService.getProfile().subscribe({
      next: (profile) => {
        this.profileForm.patchValue({
          firstName: profile.firstName,
          lastName: profile.lastName,
          email: profile.email,
          phoneNumber: profile.phoneNumber || '',
          gender: profile.gender || '' // NEW: Load gender
        });
        this.isLoading.set(false);
      },
      error: (error) => {
        console.error('Failed to load profile:', error);
        this.errorMessage.set('Failed to load profile. Please try again.');
        this.isLoading.set(false);
      }
    });
  }

  updateProfile(): void {
    if (this.profileForm.invalid) {
      this.profileForm.markAllAsTouched();
      return;
    }

    const formValue = this.profileForm.getRawValue();
    const updateRequest: ProfileUpdateRequest = {
      firstName: formValue.firstName,
      lastName: formValue.lastName,
      email: formValue.email,
      phoneNumber: formValue.phoneNumber || undefined,
      gender: formValue.gender || null // NEW: Include gender (null if empty)
    };

    this.isLoading.set(true);
    this.errorMessage.set(null);

    this.profileService.updateProfile(updateRequest).subscribe({
      next: (response) => {
        this.isLoading.set(false);
        this.showSuccessMessage.set(true);

        // Auto-dismiss success message after 3 seconds
        setTimeout(() => {
          this.showSuccessMessage.set(false);
        }, 3000);
      },
      error: (error) => {
        console.error('Failed to update profile:', error);
        this.errorMessage.set(error.error?.message || 'Failed to update profile. Please try again.');
        this.isLoading.set(false);
      }
    });
  }

  /**
   * Get current gender display value
   */
  getCurrentGender(): string {
    const genderValue = this.profileForm.get('gender')?.value;
    if (!genderValue) {
      return 'Not Set';
    }
    const option = this.genderOptions.find(opt => opt.value === genderValue);
    return option ? option.label : 'Not Set';
  }
}
```

**4. Student Profile Component Template**

File: `studymate-frontend/src/app/features/student/profile/profile.component.html`
```html
<div class="profile-container">
  <h2 class="text-2xl font-bold mb-6">My Profile</h2>

  <!-- Success Message -->
  @if (showSuccessMessage()) {
    <div class="alert alert-success mb-4">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
      </svg>
      <span>Profile updated successfully</span>
    </div>
  }

  <!-- Error Message -->
  @if (errorMessage()) {
    <div class="alert alert-error mb-4">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
      </svg>
      <span>{{ errorMessage() }}</span>
    </div>
  }

  <!-- Profile Form -->
  <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" class="profile-form">
    <!-- First Name -->
    <div class="form-group">
      <label for="firstName" class="form-label">First Name *</label>
      <input
        id="firstName"
        type="text"
        formControlName="firstName"
        class="form-input"
        placeholder="Enter first name"
      />
      @if (profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched) {
        <p class="error-message">First name is required</p>
      }
    </div>

    <!-- Last Name -->
    <div class="form-group">
      <label for="lastName" class="form-label">Last Name *</label>
      <input
        id="lastName"
        type="text"
        formControlName="lastName"
        class="form-input"
        placeholder="Enter last name"
      />
      @if (profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched) {
        <p class="error-message">Last name is required</p>
      }
    </div>

    <!-- Email (Read-Only) -->
    <div class="form-group">
      <label for="email" class="form-label">Email</label>
      <input
        id="email"
        type="email"
        formControlName="email"
        class="form-input"
        readonly
      />
      <p class="help-text">Email cannot be changed</p>
    </div>

    <!-- Phone Number -->
    <div class="form-group">
      <label for="phoneNumber" class="form-label">Phone Number</label>
      <input
        id="phoneNumber"
        type="tel"
        formControlName="phoneNumber"
        class="form-input"
        placeholder="Enter phone number"
      />
    </div>

    <!-- NEW: Gender Dropdown -->
    <div class="form-group">
      <label for="gender" class="form-label">Gender (Optional)</label>
      <select
        id="gender"
        formControlName="gender"
        class="form-select"
      >
        @for (option of genderOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
      <p class="help-text">Used for ladies-only seat booking validation</p>
    </div>

    <!-- Submit Button -->
    <div class="form-actions">
      <button
        type="submit"
        class="btn-primary"
        [disabled]="isLoading() || profileForm.invalid"
      >
        @if (isLoading()) {
          <span class="spinner"></span>
          <span>Updating...</span>
        } @else {
          <span>Update Profile</span>
        }
      </button>
    </div>
  </form>
</div>
```

**5. Student Profile Component Styling**

File: `studymate-frontend/src/app/features/student/profile/profile.component.scss`
```scss
.profile-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 24px;
}

.profile-form {
  background-color: white;
  border-radius: 8px;
  padding: 24px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.form-group {
  margin-bottom: 20px;

  &:last-child {
    margin-bottom: 0;
  }
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: #374151;
  margin-bottom: 8px;
}

.form-input,
.form-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s;

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  &:disabled,
  &[readonly] {
    background-color: #f9fafb;
    cursor: not-allowed;
  }
}

.form-select {
  cursor: pointer;
  background-color: white;

  &:disabled {
    cursor: not-allowed;
  }
}

.help-text {
  margin-top: 6px;
  font-size: 12px;
  color: #6b7280;
}

.error-message {
  margin-top: 6px;
  font-size: 12px;
  color: #ef4444;
}

.alert {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: 6px;
  font-size: 14px;
  animation: slideDown 0.3s ease-out;

  svg {
    flex-shrink: 0;
  }

  &.alert-success {
    background-color: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
  }

  &.alert-error {
    background-color: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }
}

.form-actions {
  margin-top: 24px;
}

.btn-primary {
  width: 100%;
  padding: 12px 24px;
  background-color: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;

  &:hover:not(:disabled) {
    background-color: #2563eb;
  }

  &:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
  }
}

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
```

[Source: Sprint Change Proposal A, Section 6 - Frontend Changes]

---

## Testing Requirements

### Frontend Unit Tests

```typescript
describe('StudentProfileComponent', () => {
  let component: StudentProfileComponent;
  let fixture: ComponentFixture<StudentProfileComponent>;
  let profileService: ProfileService;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [StudentProfileComponent]
    }).compileComponents();

    fixture = TestBed.createComponent(StudentProfileComponent);
    component = fixture.componentInstance;
    profileService = TestBed.inject(ProfileService);
  });

  it('should display gender dropdown with four options', () => {
    fixture.detectChanges();

    const genderSelect = fixture.nativeElement.querySelector('#gender');
    const options = genderSelect.querySelectorAll('option');

    expect(options.length).toBe(4);
    expect(options[0].textContent).toContain('Prefer not to say');
    expect(options[1].textContent).toContain('Male');
    expect(options[2].textContent).toContain('Female');
    expect(options[3].textContent).toContain('Other');
  });

  it('should load and display current gender', () => {
    const mockProfile = {
      firstName: 'Jane',
      lastName: 'Doe',
      email: 'jane@example.com',
      gender: 'FEMALE'
    };

    spyOn(profileService, 'getProfile').and.returnValue(of(mockProfile));

    component.loadProfile();
    fixture.detectChanges();

    expect(component.profileForm.get('gender')?.value).toBe('FEMALE');
  });

  it('should display "Not Set" if gender is null', () => {
    component.profileForm.patchValue({ gender: '' });

    const currentGender = component.getCurrentGender();

    expect(currentGender).toBe('Not Set');
  });

  it('should call API with updated gender on save', () => {
    const mockResponse = { message: 'Profile updated successfully' };
    spyOn(profileService, 'updateProfile').and.returnValue(of(mockResponse));

    component.profileForm.patchValue({
      firstName: 'Jane',
      lastName: 'Doe',
      email: 'jane@example.com',
      gender: 'FEMALE'
    });

    component.updateProfile();

    expect(profileService.updateProfile).toHaveBeenCalledWith(
      jasmine.objectContaining({
        gender: 'FEMALE'
      })
    );
  });

  it('should display success message after successful update', () => {
    const mockResponse = { message: 'Profile updated successfully' };
    spyOn(profileService, 'updateProfile').and.returnValue(of(mockResponse));

    component.profileForm.patchValue({
      firstName: 'Jane',
      lastName: 'Doe',
      email: 'jane@example.com',
      gender: 'FEMALE'
    });

    component.updateProfile();

    expect(component.showSuccessMessage()).toBe(true);
  });

  it('should display error message on failed update', () => {
    const mockError = { error: { message: 'Update failed' } };
    spyOn(profileService, 'updateProfile').and.returnValue(throwError(() => mockError));

    component.profileForm.patchValue({
      firstName: 'Jane',
      lastName: 'Doe',
      email: 'jane@example.com',
      gender: 'FEMALE'
    });

    component.updateProfile();

    expect(component.errorMessage()).toBe('Update failed');
  });
});
```

### E2E Tests (Playwright)

```typescript
import { test, expect } from '@playwright/test';

test.describe('Student Profile Gender Management', () => {
  test.beforeEach(async ({ page }) => {
    // Login as student
    await page.goto('/login');
    await page.fill('input[name="email"]', 'student@example.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // Navigate to profile page
    await page.goto('/student/profile');
    await page.waitForSelector('.profile-form');
  });

  test('gender dropdown displays with all options', async ({ page }) => {
    const genderSelect = page.locator('#gender');
    await expect(genderSelect).toBeVisible();

    // Check all options
    const options = await genderSelect.locator('option').allTextContents();
    expect(options).toContain('Prefer not to say');
    expect(options).toContain('Male');
    expect(options).toContain('Female');
    expect(options).toContain('Other');
  });

  test('student can update gender to Female', async ({ page }) => {
    // Select "Female" from dropdown
    await page.selectOption('#gender', 'FEMALE');

    // Click "Update Profile" button
    await page.click('button[type="submit"]');

    // Verify success message
    await expect(page.locator('.alert-success')).toContainText('Profile updated successfully');
  });

  test('student can update gender to "Prefer not to say"', async ({ page }) => {
    // Select "Prefer not to say" (empty value)
    await page.selectOption('#gender', '');

    // Click "Update Profile" button
    await page.click('button[type="submit"]');

    // Verify success message
    await expect(page.locator('.alert-success')).toContainText('Profile updated successfully');
  });

  test('success message auto-dismisses after 3 seconds', async ({ page }) => {
    // Select gender and save
    await page.selectOption('#gender', 'MALE');
    await page.click('button[type="submit"]');

    // Verify success message appears
    await expect(page.locator('.alert-success')).toBeVisible();

    // Wait 3.5 seconds
    await page.waitForTimeout(3500);

    // Verify success message dismissed
    await expect(page.locator('.alert-success')).not.toBeVisible();
  });

  test('help text explains gender usage', async ({ page }) => {
    const helpText = page.locator('#gender ~ .help-text');
    await expect(helpText).toContainText('ladies-only seat booking validation');
  });
});
```

[Source: Sprint Change Proposal A, Section 11 - Testing Requirements]

---

## Definition of Done

- [ ] Gender field displays in profile view
- [ ] "Not Set" displayed if gender is null
- [ ] Current gender value displayed if set
- [ ] Gender dropdown with four options (Prefer not to say, Male, Female, Other)
- [ ] Current gender pre-selected in dropdown
- [ ] Help text visible: "Used for ladies-only seat booking validation"
- [ ] Student can update gender via dropdown
- [ ] API called with updated gender on save
- [ ] Success message displayed after successful update
- [ ] Success message auto-dismisses after 3 seconds
- [ ] Error message displayed if update fails
- [ ] JWT token refreshed after gender update
- [ ] No re-login required after update
- [ ] Unit tests passing (95%+ coverage)
- [ ] E2E tests passing (Playwright)
- [ ] No console errors or warnings
- [ ] Design system compliance verified
- [ ] Code reviewed and approved
- [ ] Story 0.1.5-backend verified complete

---

## Dependencies & Blockers

### Blocked By:
- ⛔ Story 0.1.5-backend (Backend Gender Field) - MUST be complete
- ⛔ Profile update API must accept gender field
- ⛔ Backend must return new JWT token with updated gender

### Unblocks:
- ✅ Students can update gender for ladies-only seat access
- ✅ Reduces support tickets for gender corrections

[Source: Sprint Change Proposal A, Section 8 - Phase 3]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Story created from Sprint Change Proposal A | Bob (SM) |

---

**Story Status**: Draft
**Last Updated**: 2025-10-14
**Next Steps**: Review with PO, verify Story 0.1.5-backend complete, assign to frontend developer
