# Story 1.12-Backend: Implement Report Generation API

## Status
Draft

## Story
**As a** Backend Developer,
**I want** report generation API endpoint implemented,
**so that** owners can download performance reports in PDF/Excel format.

## Acceptance Criteria
1. GET `/owner/reports/{hallId}` endpoint created
2. Reports generated in-memory (no file storage)
3. PDF and Excel formats supported (query param: ?format=pdf or ?format=excel)
4. Report includes: Revenue, Utilization %, Busiest Times
5. Date range filtering supported (query params: ?startDate=&endDate=)
6. Direct download response with proper content-type headers
7. PostgreSQL MCP validation for data aggregation

## Tasks / Subtasks
- [ ] Create ReportController with GET endpoint
- [ ] Create ReportService for data aggregation
- [ ] Create ReportGenerator interface with PDF and Excel implementations
- [ ] Use Apache POI for Excel generation
- [ ] Use iText or similar for PDF generation
- [ ] Query aggregated data from bookings table
- [ ] Calculate utilization percentage by date range
- [ ] Identify busiest times (peak hours analysis)
- [ ] Return StreamingResponseBody for direct download
- [ ] Set proper Content-Type and Content-Disposition headers
- [ ] Create integration tests
- [ ] Validate data with PostgreSQL MCP

## Dev Notes

### API Specification
**Endpoint:** `GET /owner/reports/{hallId}?format=pdf&startDate=2025-01-01&endDate=2025-01-31`

**Response:** File download with appropriate headers
```
Content-Type: application/pdf or application/vnd.ms-excel
Content-Disposition: attachment; filename="hall-report-2025-01.pdf"
```

### Controller Implementation
```java
@GetMapping("/{hallId}")
@PreAuthorize("hasRole('OWNER')")
public ResponseEntity<StreamingResponseBody> generateReport(
        @PathVariable Long hallId,
        @RequestParam(defaultValue = "pdf") String format,
        @RequestParam LocalDate startDate,
        @RequestParam LocalDate endDate,
        @AuthenticationPrincipal UserDetails userDetails) {

    ReportData data = reportService.aggregateData(hallId, startDate, endDate, userDetails);
    StreamingResponseBody stream = reportGenerator.generate(data, format);

    String filename = String.format("hall-%d-report.%s", hallId, format);
    String contentType = format.equals("pdf") ? "application/pdf" : "application/vnd.ms-excel";

    return ResponseEntity.ok()
        .contentType(MediaType.parseMediaType(contentType))
        .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"" + filename + "\"")
        .body(stream);
}
```

### Service Implementation
```java
@Service
@RequiredArgsConstructor
public class ReportService {

    private final BookingRepository bookingRepository;
    private final SeatRepository seatRepository;

    public ReportData aggregateData(Long hallId, LocalDate startDate, LocalDate endDate, UserDetails user) {
        // Verify ownership
        verifyOwnership(hallId, user);

        // Aggregate data
        BigDecimal totalRevenue = bookingRepository.sumRevenueByHallAndDateRange(hallId, startDate, endDate);
        Map<LocalDate, Double> dailyUtilization = calculateUtilization(hallId, startDate, endDate);
        Map<Integer, Long> busiestHours = bookingRepository.findBusiestHoursByHall(hallId, startDate, endDate);

        return ReportData.builder()
            .hallId(hallId)
            .startDate(startDate)
            .endDate(endDate)
            .totalRevenue(totalRevenue)
            .dailyUtilization(dailyUtilization)
            .busiestHours(busiestHours)
            .build();
    }
}
```

### Report Queries
```java
// In BookingRepository
@Query("SELECT COALESCE(SUM(b.amount), 0) FROM Booking b " +
       "WHERE b.seat.hall.id = :hallId " +
       "AND b.startTime >= :startDate AND b.endTime <= :endDate " +
       "AND b.status = 'CONFIRMED'")
BigDecimal sumRevenueByHallAndDateRange(Long hallId, LocalDate startDate, LocalDate endDate);

@Query("SELECT HOUR(b.startTime) as hour, COUNT(b) as count " +
       "FROM Booking b " +
       "WHERE b.seat.hall.id = :hallId " +
       "AND b.startTime >= :startDate AND b.endTime <= :endDate " +
       "GROUP BY HOUR(b.startTime) " +
       "ORDER BY count DESC")
Map<Integer, Long> findBusiestHoursByHall(Long hallId, LocalDate startDate, LocalDate endDate);
```

### Dependencies
Add to pom.xml:
```xml
<!-- Apache POI for Excel -->
<dependency>
    <groupId>org.apache.poi</groupId>
    <artifactId>poi-ooxml</artifactId>
    <version>5.2.3</version>
</dependency>

<!-- iText for PDF -->
<dependency>
    <groupId>com.itextpdf</groupId>
    <artifactId>itext7-core</artifactId>
    <version>7.2.5</version>
</dependency>
```

### File Locations
- Controller: `controller/ReportController.java`
- Service: `service/ReportService.java`
- Generators: `service/report/PdfReportGenerator.java`, `ExcelReportGenerator.java`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Report generation API backend story | Bob (Scrum Master) |
